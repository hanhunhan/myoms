<!DOCTYPE html>
<html>
<head>
    <title>活动立项</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
    <!--<link href="./Public/css/jquery-ui.css" type="text/css" rel="stylesheet"/>-->
    <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>-->

    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/jquery-ui.js"></script>-->

    <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>-->
    <style>
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            /* 防止水平滚动条 */
            overflow-x: hidden;
        }
    </style>

</head>
<body>

<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab  ">
            {$tabs}
        </div>
        {$form}
        <!--活动变更号-->
        <input type="hidden" name="CID" value="{$CID}" id="CID">
        <script>
            $(function () {
                // 费用选择字段适用select2
                var feeOptions = '{$feeOptions}';
                if (feeOptions) {
                    $('select[name="FEE_ID"]')
                            .html(feeOptions)
                            .addClass('js-example-basic-single')
                            .val($('input[name="FEE_ID_OLD"]').val())
                            .unbind('focus')
                            .select2({
                                allowClear: true,
                                noResults: '没有找到相关信息'
                            });
                }

                var demo = $(".registerform").Validform();
                var checkFeeUrl = "{:U('Api/checkFeeId')}" + "&activitiesId={$activitiesId}" + "&atfeeID={$atfeeID}";
                if (parseInt($('#CID').val()) > 0) {
                    checkFeeUrl = "{:U('Api/checkFeeId')}" + "&activitiesId={$activitiesId}&CID=" + $('#CID').val() + "&atfeeID={$atfeeID}";
                }
                demo.addRule([
                    {
                        ele: "select[name$='FEE_ID']",
                        datatype: "*",
                        ajaxurl: checkFeeUrl,
                        nullmsg: "请选择类型！",
                        errormsg: "请选择类型！"
                    }
                ]);

                $("input[name='AMOUNT']").bind('blur', function () {
                    proportion();
                });

                proportion = function () {
                    if ($("input[name='AMOUNT']").val()) {
                        var activid = '{$activitiesId}';
                        var CHANGE = '{$CHANGE}';
                        $.ajax({
                            url: "{:U('Activ/activBudget','&act=getproportion')}",
                            dataType: "json",
                            data: {
                                'tid': $("input[name$='ID']").val(),
                                'amount': $("input[name='AMOUNT']").val(),
                                'activitiesId': activid,
                                'CHANGE': CHANGE

                            },
                            success: function (obJect) {
                                if (obJect.proportion) {
                                    $("input[name='PROPORTION']").val(obJect.proportion).parent().parent().find('span').first().html(obJect.proportion);
                                }
                            }

                        });
                    }
                }
                proportion();
                proportions = function () {
                    var total = 0;
                    $(".contractinfo-table tbody .itemlist").each(function () {
                        var thisid = $(this).attr("fid");
                        total = total + Number($("input[name='" + thisid + "_AMOUNT']").val());

                    });
                    $(".contractinfo-table tbody tr").each(function () {
                        var thisid = $(this).attr("fid");
                        var fee = Number($("input[name='" + thisid + "_AMOUNT']").val());
                        var proportion = fee / total * 100;
                        proportion = proportion.toFixed(2);
                        $("input[name='" + thisid + "_PROPORTION']").parent().parent().find('span').first().html(proportion);

                    });

                }
                proportions();

            });
        </script>
    </div>
</div>
</body>
</html>
