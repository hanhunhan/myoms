<!DOCTYPE html>
<html>
<head>
    <title>广告合同</title>
    <meta charset="GBK">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
    <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>-->
    <!--<link rel="stylesheet" href="./Public/css/nocode.css" type="text/css"/>-->
    <include file="./Tpl/Admin/Public/comm_css_js.html" />
    <script>
        var appUrl;
        $(function () {
            var prjid;
            $(".handle-tab ul li").eq(0).addClass("selected");
            $(".CONTRACT_NO").blur(function () {
                var contractnum = $(this).val();
                var str;
                if ($.trim(contractnum) == '') {
                    return false;
                }
                $.ajax({
                    url: "index.php?s=/Advert/get_contract_data",
                    type: "POST",
                    dataType: "json",
                    data: {contractnum: contractnum, projectId: $("#prjid").val()},
                    success: function (data) {
                        if (data.msg) {
                            alert(data.msg);
                            $("input[name='CONTRACT_NO']").val('');
                        } else {
                            str = "<input type= 'hidden' name = 'STATUS' value = '" + data.step + "'>\n\
									<input type='hidden' name='CONTRACT_TYPE' value='" + data.type + "'>\n\
									<input type='hidden' name='PUB_TIME' value='" + data.pubdate + "'>\n\
									<input type='hidden' name='CONF_TIME' value='" + data.confirmtime + "'>\n\
									<input type='hidden' name='ADDMAN' value='" + data.addman + "'>";
                            $(".COMPANY").val(data.contunit).attr("readonly", true);
                            $(".PROJECTNAME").val(data.prjname).attr("readonly", true);
                            $(".START_TIME").val(data.contbegintime).attr("readonly", true);
                            $(".END_TIME").val(data.contendtime).attr("readonly", true);
                            $(".MONEY").val(data.contmoney).attr("readonly", true);
                            $(".SIGN_USER").val(data.addman).attr("readonly", true);
                            $(".registerform").append(str).attr("readonly", true);
                        }
                    }
                })
            });

            //同步合同系统
            $("#syn_contract_system").click(function(){
                var contract = new Array();
                var i = 0;
                $("input[name= 'checkedtd']:checkbox").each(function()
                {
                    if ($(this).prop("checked") == true)
                    {
                        contract[i] = $(this).val();
                        i += 1;
                    }
                });

                if( i == 0 )
                {
                    layer.alert('请至少选择一条记录!', {icon: 2});
                    return false;
                }

                $.ajax({
                    type: "GET",
                    url: "{:U('Advert/contract',$paramUrl)}",
                    data:{'contract':contract,'act':'syc_contract'},
                    dataType:"JSON",
                    success:function(data){
                        if(data.status)
                        {
                            layer.alert('同步成功', {icon: 1},function(index){
                                window.location.reload();
                            });
                        }
                        else
                        {
                            layer.alert(data.msg, {icon: 2});
                        }
                    },
                    error:function(){
                        alert('对不起，操作异常');
                    }
                })
            });
            $("#save_displace_property").hide();
            //变更置换合同系统         
            $("#change_contract_displace").click(function(){
                var fid = $("tbody .selected").attr('fid');             
                if (fid <= 0) {
                    layer.alert("请至少选择一条记录", {icon: 0});
                    return false;
                }
                $("select[name='"+fid+"_DISPLACE']").parent().prev().hide();
                $("select[name='"+fid+"_DISPLACE'] option[value='']").css("display","none");
                $("select[name='"+fid+"_DISPLACE']").parent().show();
                $("#save_displace_property").show();
                $("#save_displace_property").click(function(){  
                var displace =  $("select[name='"+fid+"_DISPLACE']").val();
                $.ajax({
                    type:"POST",
                    url: "index.php?s=/Advert/updateDisplaceProperty",
                    data:{'fid':fid,'displace':displace},
                    dataType:"JSON",
                    success:function(data){
                        if(data.status)
                        {
                            layer.alert(data.msg, {icon: 1},function(index){
                                var text = $("select[name='"+fid+"_DISPLACE']").find("option:selected").text();
                                $("select[name='"+fid+"_DISPLACE']").parent().hide();
                                $("select[name='"+fid+"_DISPLACE']").parent().prev().text(text).show();
                                layer.close(index)
                                $("#save_displace_property").hide();
                            });
                        }
                        else
                        {
                            layer.alert(data.msg, {icon: 2},function(index){
                                $("select[name='"+fid+"_DISPLACE']").parent().hide();
                                $("select[name='"+fid+"_DISPLACE']").parent().prev().show();
                                layer.close(index)
                                $("#save_displace_property").hide();
                               
                            });
                        }
                    },
                    error:function(){
                        alert('对不起，操作异常');
                    }

                })

                $("#save_displace_property").unbind();
            });
            });

         
            
            //判断是否已有合同
            $("#addcontract").click(function () {
                prjid = $("#prjid").val();
                contract_type = $("#contract_type").val();
                var url = "index.php?s=/Advert/contract&showForm=1&prjid=" + prjid + "&contract_type=" + contract_type;
                $(this).attr("href", url);
                location.href = url;
            })
        });

        function show_purchase_requestion() {
            var current_url = $("#current_purchase_url").val();
            var contract_type = $("#contract_type").val();
            var scale_type = $("#scale_type").val();
            var url = current_url + "/contract_type/" + contract_type + "/scale_type/" + scale_type;
            window.location.href = url;
        }

        function opinionFlow() {
            var current_url = $("#current_opinionFlow_url").val();
            var contract_type = $("#contract_type").val();
            var scale_type = $("#scale_type").val();
            var url = current_url + "/scale_type/" + scale_type;
            window.location.href = url;
        }
    </script>
</head>
<body>
<div class="right fright j-right">
    <div class="handle-tab">
        {$tabs}
    </div>
    <div id="form">
        {$form}
        <input type="hidden" id="prjid" value="{$prjid}">
        <input type="hidden" id="current_purchase_url" value="{:U('Advert/show_purchase_requestion',$paramUrl)}">
        <input type="hidden" id="current_opinionFlow_url" value="{:U('Advert/opinionFlow',$paramUrl)}">
        <input type="hidden" id="contract_type" value="{$contract_type}">
        <input type="hidden" id="scale_type" value="{$scale_type}">
    </div>
</div>
<include file="./Tpl/Admin/Public/filter.html"/>
</body>
</html>
