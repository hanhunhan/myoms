<!DOCTYPE html>
<html>
<head>
    <title>业务津贴</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="Public/third/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>
    <script type="text/javascript" src="./Public/validform/js/common.js"></script>
    <script type="text/javascript" src="./Public/js/common.js"></script>
    <script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>
    <script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>
    <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.core.js"></script>
    <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.widget.js"></script>
    <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.position.js"></script>
    <script type="text/javascript" src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.autocomplete.js"></script>
    <script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>
    <script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>
    <script src="Public/third/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="Public/js/jquery.nicescroll.min.js"></script>
    <link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <script>
        $(function() {
//            $('html').niceScroll();  // 美化的滚动条
            // 获取上次的搜索条件
            var lastFilterResult = '{$lastFilter}';
            $('#last_filter_result').text(lastFilterResult);
        });
        function show_benefit_info() {
            var benefits_id = $(".j-right tbody .selected").attr('fid');
            var apply_amount = $("input[name = '" + benefits_id + "_AMOUNT']").val();
            var case_id  = $("input[name = '" + benefits_id + "_CASE_ID']").val();
            var status = $("select[name = '" + benefits_id + "_STATUS'] option:selected").val();
            if (!benefits_id) {
                layer.alert("请选择需要申请的津贴记录", {icon: 2});
                return false;
            }
            if (status != 1) {
                layer.alert("该津贴已提交流程审核，或者已被否决，不能提交审核！", {icon: 2});
                return false;
            }

            var scale_type = $("select[name = '" + benefits_id + "_SCALE_TYPE'] option:selected").val();
            var benefits_type = $("#benefits_type").val();
            if (benefits_type == 0) {
                var flowtype = 'yewujintie';
            } else if (benefits_type == 1) {
                var flowtype = 'yusuanqita';
            }

            var _this = this;
            //是否超出垫资比例
            _this.is_over = false;

            $.ajax({
                type: "get",
                url: "{:U('Api/is_over_payout_limit')}",
                async: false,
                data: {"case_id": case_id, "apply_amount": apply_amount},
                dataType: "JSON",
                success: function (res) {
                    if(res.data.state==true)
                        _this.is_over = true;
                },
                error: function () {
                    alert("网络错误，请重试~~");
                }
            });

            if(_this.is_over){
                if(!confirm("该项目成本已超出垫资额度或超出费用预算（总费用>开票回款收入*付现成本率）\n您确定要继续吗？"))
                    return false;
            }

            var current_url = $("#show_benefit_info_url").val();
            var url = current_url + "/RECORDID/" + benefits_id + "/FLOWTYPE/" + flowtype +
                    "/scale_type/" + scale_type + "/benefits_type/" + benefits_type;

            var appUrl = "__APP__";
			if(benefits_type==0){
				url = appUrl + '/Touch/Benefits/process&RECORDID=' + benefits_id + '&CASEID=' + case_id + '&flowTypePinYin=yewujintie';
			}else{
				url = appUrl + '/Touch/BenefitFlow/process&RECORDID=' + benefits_id + '&CASEID=' + case_id + '&flowTypePinYin=yusuanqita';
					
			}

            window.location.href = url;
        }

        function applyReimburse() {
            var benefits_id = $(".j-right tbody .selected").attr('fid');
            var reimburse_type = "yewujintie";//报销类型为业务津贴
            var url = "{:U('Benefits/apply_reimburse',$paramUrl)}";
            if (!benefits_id) {
                layer.alert("请选择需要报销的津贴记录", {icon: 0});
                return false;
            }
            var supplier = $("input[name='"+benefits_id+"_SUPPLIER_OLD']").val();
            if(!supplier){
                layer.alert("亲，申请报销需填写供应商",{icon:0});
                return false;
            }
            $.ajax({
                type: "post",
                url: url,
                data: {"reimburse_type": reimburse_type, benefits_id: benefits_id},
                dataType: "JSON",
                success: function (data) {
                    if (data.state == 1) {
                        layer.alert(data.msg, {icon: 1});
                    }
                    else {
                        layer.alert(data.msg, {icon: 2});
                    }
                }
            })
        }

        //查看津贴流程图
        function show_flow_step() {
            var benefits_id = $(".j-right tbody .selected").attr('fid');
            var scale_type = $("select[name='" + benefits_id + "_SCALE_TYPE']").val();
            var benefits_type = $("#benefits_type").val();
            if (!benefits_id) {
                layer.alert("请选择要查看的记录", {icon: 0});
                return false;
            } else {
                var url = "{:U('Benefits/show_flow_step',$paramUrl)}";
                $.ajax({
                    type: "post",
                    url: url,
                    data: {"benefits_id": benefits_id, "scale_type": scale_type, "benefits_type": benefits_type},
                    dataType: "JSON",
                    success: function (data) {
                        if (data.state == 0) {
                            layer.alert(data.msg, {icon: 2});
                        } else if (data.state == 1) {
                            url = url + "/flowid/" + data.msg + "/benefits_id/" + benefits_id;
                            //window.location.href = url + "/flowid/"+data.msg+"/benefits_id/"+benefits_id;
                            layer.open({
                                type: 2,
                                title: '流程详情',
                                shadeClose: true,
                                shade: 0.8,
                                area: ['90%', '90%'],
                                content: url //iframe的url
                            });
                        } else {
                            layer.alert(data.msg, {icon: 2});
                        }
                    }
                })
            }
        }
    </script>
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab">
            {$tabs}
        </div>
        <if condition="$benefits_type eq 0">
            <div style="text-align: center">
                <h2 style="display: inline-block">【{$prjname}】</h2>
                <span style="font-size: 20px">--业务津贴管理</span>
            </div>
            <else/>
            <div style="text-align: center">
                <h2 style="display: inline-block">【{$prjname}】</h2>
                <span style="font-size: 20px">--预算外其他费用管理</span>
            </div>
        </if>
        {$form}
        <input type="hidden" name="show_benefit_info_url" id="show_benefit_info_url"
               value="{:U('Benefits/show_benefit_info',$paramUrl)}">
        <input type="hidden" name="apply_reimburse_url" id="apply_reimburse_url"
               value="{:U('Benefits/apply_reimburse',$paramUrl)}">
        <input type="hidden" name="benefits_type" id="benefits_type" value="{$benefits_type}">
        <textarea id="last_filter_text" style="display: none">{$lastFilter}</textarea>
    </div>
</div>

<script>
    $(function () {
        $(".j-right tbody tr").click(function () {
            $(this).siblings().removeClass("selected");
            $(this).addClass("selected");
        });

        var isShowOptionBtn = "{$isShowOptionBtn}";
        var benefitsType = "{$benefits_type}";
        if (isShowOptionBtn == DISPLAY_OPTION_BTN.HIDE) {
            $.each($('.page a'), function (index, elem) {
                if (benefitsType == 1) {
                    if (!REG_EXPS.ORDER.test($(elem).text())
                            && !REG_EXPS.SEARCH.test($(elem).text())
                            && !REG_EXPS.REFRESH.test($(elem).text())
                            && !REG_EXPS.REIM.test($(elem).text())
                            && !REG_EXPS.DECLARE.test($(elem).text())) {
                        $(elem).remove();
                    }
                } else {
                    if (!REG_EXPS.ORDER.test($(elem).text())
                            && !REG_EXPS.SEARCH.test($(elem).text())
                            && !REG_EXPS.REFRESH.test($(elem).text())) {
                        $(elem).remove();
                    }
                }

            });

            $('.buttons').remove();
            $('.handle-btn').remove();
        }

        //供应商编号
        $("input[name='SUPPLIER']").parent().after("<input name='S_ID_GET' type = 'hidden' value='{$supplierId}'>");

        $("input[name='SUPPLIER']").autocomplete({
            source: function (request, response) {
                var supplier_name = request.term;
                $.ajax({
                    url: "{:U('Supplier/get_supplier_by_keyword')}",
                    type: "GET",
                    dataType: "JSON",
                    data: {'keyword': encodeURI(supplier_name)},
                    success: function (data) {
                        //判断返回数据是否为空，不为空返回数据。
                        if (data[0]['id'] > 0) {
                            response(data);
                            $("input[name='S_ID_GET']").val('');
                        }
                        else {
                            response(data);
                            $("input[name='S_ID_GET']").val('');
                        }
                    }
                });
            },
            minLength: 1,
            removeinput: 0,
            select: function (event, ui) {
                if (ui.item.id > 0) {
                    var supplier_id = ui.item.id;
                    $("input[name='S_ID_GET']").val(supplier_id);
                    removeinput = 2;
                } else {
                    removeinput = 1;
                    $("input[name='S_ID_GET']").val('');
                    open_add_supplier_window();
                }
            },
            close: function (event) {
                if (typeof(removeinput) == 'undefined' || removeinput == 1) {
                    $(this).val('');
                    $("input[name='S_ID_GET']").val('');
                }
            }
        }).autocomplete("instance")._renderItem = function (ul, item) {
            if (item.id > 0) {
                var ul_text = item.label + '&nbsp;&nbsp;' + item.telno;
            } else {
                var ul_text = '无符合条件的供应商，点击添加';
            }
            return $("<li>")
                    .append("<a>" + ul_text + "</a>")
                    .appendTo(ul);
        };


        function open_add_supplier_window() {
            var iframe_add_supplier = layer.open({
                type: 2,
                title: '添加供应商',
                content: '{:U("Supplier/supplier_manage")}' + '&showForm=3&layer_num=1',
                area: ['65%', '40%'],
                btn: ['保存', '取消'],
                yes: function (index) {
                    var name = $(".NAME", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var address = $(".ADDRESS", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var truename = $(".CONTACT", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var telno = $(".CONTACT_TELNO", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var city_id = $(".CITY_ID", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var status = $(".STATUS", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();

                    if (name.trim() == '') {
                        layer.alert('供应商名称必须填写', {icon: 2});
                        return false;
                    }

                    if (address.trim() == '') {
                        layer.alert('地址必须填写', {icon: 2});
                        return false;
                    }

                    if (truename.trim() == '') {
                        layer.alert('联系人必须填写', {icon: 2});
                        return false;
                    }

                    if (telno.trim() == '') {
                        layer.alert('联系电话必须填写', {icon: 2});
                        return false;
                    }

                    if (city_id.trim() == '') {
                        layer.alert('城市必须填写', {icon: 2});
                        return false;
                    }

                    if (status.trim() == '') {
                        layer.alert('状态必须选择', {icon: 2});
                        return false;
                    }

                    $.ajax({
                        type: "POST",
                        url: '{:U("Supplier/ajax_add_supplier_info")}',
                        data: {
                            'name': name, 'address': address, 'truename': truename,
                            'telno': telno, 'city_id': city_id, 'status': status
                        },
                        dataType: "JSON",
                        success: function (data) {
                            if (data.status == 'noauth') {
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                                return false;
                            }

                            if (data.state == 0) {
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                            else if (data.state == 1) {
                                if (data.supplier_id > 0) {
                                    //设置供应商
                                    set_supplier( name, data.supplier_id);
                                }

                                layer.alert(data.msg, {icon: 1, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                            else {
                                var msg = data.msg ? data.msg : '操作异常';
                                layer.alert(msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                        }
                    })
                },
                cancel: function (index) {
                    layer.close(index);
                }
            });
        }

        function set_supplier(s_name,s_id) {
            $("input[name='S_NAME']").val(s_name);
            $("input[name='S_ID_GET']").val(s_id);
        }
    })
</script>
</body>
</html>
