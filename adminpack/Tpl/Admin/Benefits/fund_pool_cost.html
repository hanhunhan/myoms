<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="GBK">
    <title>资金池费用</title>
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab">
            <ul>
                <li class="selected"><a href="{$srcUrl}">资金池费用</a></li>
            </ul>
        </div>
        <div class="text-center">
            <h2 style="display: inline-block">【{$prjName}】</h2>
            <span style="font-size: 20px">--资金池费用管理</span>
        </div>
        <div class="prj-info-panel" style="margin: 20px 0 30px;">
            <p>【项目情况】
                <div style="max-width: 400px;" class="">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <td>收入</td>
                                <td>{$prjAffirmIncome}元</td>
                            </tr>
                            <tr>
                                <td>资金池比例</td>
                                <td>{$fundPoolRatio}%</td>
                            </tr>
                            <tr>
                                <td>可支付金额</td>
                                <td><if condition="$maxApplyCost lt 0">0元<else />{$maxApplyCost}元</if></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            <p>【说明】如果您的申请额度大于“可支付金额”，请走采购流程进行申请</p>
        </div>
        {$html}
    </div>
</div>
<script>
    $(function () {
        $('.contractinfo-table tbody > tr').click(function() {
            $('.itemlist.selected').removeClass("selected");
            $(this).addClass("selected");
        });
       
        $('#commit_fund_cost_apply').click(function() {
            var fid = $('.itemlist.selected').attr('fid');
            if (!fid) {
                layer.alert('请选择一条资金池费用申请', {icon: 0});
                return;
            }
            
            var status = $('.itemlist.selected').find('[name="' + fid + '_ISCOST"]').val();
            if (status != 1) {
                layer.alert('该条资金池费用已申请报销，不能重复申请', {icon: 0});
                return;
            }

            var url = "{:U('Reimbursement/applyFundPoolCost')}";
            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    biz_id: fid
                },
                success: onFundCostApplySuccess
            });

            function onFundCostApplySuccess(data) {
                if (data.status == 1) {  // 状态更改成功
                    layer.open({
                        content: '申请成功',
                        btn: ['确定'],
                        yes: function() {
                            location.reload();
                        },
                        icon: 1
                    });
                } else {
                    if (!data.status) {
                        data = data && JSON.parse(data);
                    }
                    var msg = data.msg || '申请失败';
                    layer.alert(msg, {icon: 2});
                }
            }
        });

        //供应商文字
//        var Supplier_text_val = $("input[name='SUPPLIER']").parent().siblings('span').html();
//        $("input[name='SUPPLIER']").parent().after("<input name='S_NAME' class = 'Supplier_Text' type = 'text' value='" + Supplier_text_val + "'>");

        //供应商编号
        $("input[name='SUPPLIER']").parent().after("<input name='S_ID_GET' type = 'hidden' value='{$S_ID_GET}'>");

        $("input[name='SUPPLIER']").autocomplete({
            source: function (request, response) {
                var supplier_name = request.term;
                $.ajax({
                    url: "{:U('Supplier/get_supplier_by_keyword')}",
                    type: "GET",
                    dataType: "JSON",
                    data: {'keyword': encodeURI(supplier_name)},
                    success: function (data) {
                        //判断返回数据是否为空，不为空返回数据。
                        if (data[0]['id'] > 0) {
                            response(data);
                            $("input[name='S_ID_GET']").val('');
                        }
                        else {
                            response(data);
                            $("input[name='S_ID_GET']").val('');
                        }
                    }
                });
            },
            minLength: 1,
            removeinput: 0,
            select: function (event, ui) {
                if (ui.item.id > 0) {
                    var supplier_id = ui.item.id;
                    $("input[name='S_ID_GET']").val(supplier_id);
                    removeinput = 2;
                } else {
                    removeinput = 1;
                    $("input[name='S_ID_GET']").val('');
                    open_add_supplier_window();
                }
            },
            close: function (event) {
                if (typeof(removeinput) == 'undefined' || removeinput == 1) {
                    $(this).val('');
                    $("input[name='S_ID_GET']").val('');
                }
            }
        }).autocomplete("instance")._renderItem = function (ul, item) {
            if (item.id > 0) {
                var ul_text = item.label + '&nbsp;&nbsp;' + item.telno;
            } else {
                var ul_text = '无符合条件的供应商，点击添加';
            }
            return $("<li>")
                    .append("<a>" + ul_text + "</a>")
                    .appendTo(ul);
        };


        function open_add_supplier_window() {
            var iframe_add_supplier = layer.open({
                type: 2,
                title: '添加供应商',
                content: '{:U("Supplier/supplier_manage")}' + '&showForm=3&layer_num=1',
                area: ['65%', '40%'],
                btn: ['保存', '取消'],
                yes: function (index) {
                    var name = $(".NAME", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var address = $(".ADDRESS", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var truename = $(".CONTACT", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var telno = $(".CONTACT_TELNO", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var city_id = $(".CITY_ID", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();
                    var status = $(".STATUS", window.frames["layui-layer-iframe" + iframe_add_supplier].document).val();

                    if (name.trim() == '') {
                        layer.alert('供应商名称必须填写', {icon: 2});
                        return false;
                    }

                    if (address.trim() == '') {
                        layer.alert('地址必须填写', {icon: 2});
                        return false;
                    }

                    if (truename.trim() == '') {
                        layer.alert('联系人必须填写', {icon: 2});
                        return false;
                    }

                    if (telno.trim() == '') {
                        layer.alert('联系电话必须填写', {icon: 2});
                        return false;
                    }

                    if (city_id.trim() == '') {
                        layer.alert('城市必须填写', {icon: 2});
                        return false;
                    }

                    if (status.trim() == '') {
                        layer.alert('状态必须选择', {icon: 2});
                        return false;
                    }

                    $.ajax({
                        type: "POST",
                        url: '{:U("Supplier/ajax_add_supplier_info")}',
                        data: {
                            'name': name, 'address': address, 'truename': truename,
                            'telno': telno, 'city_id': city_id, 'status': status
                        },
                        dataType: "JSON",
                        success: function (data) {
                            if (data.status == 'noauth') {
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                                return false;
                            }

                            if (data.state == 0) {
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                            else if (data.state == 1) {
                                if (data.supplier_id > 0) {
                                    //设置供应商
                                    set_supplier( name, data.supplier_id);
                                }

                                layer.alert(data.msg, {icon: 1, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                            else {
                                var msg = data.msg ? data.msg : '操作异常';
                                layer.alert(msg, {icon: 2, closeBtn: false}, function () {
                                    layer.closeAll();
                                });
                            }
                        }
                    })
                },
                cancel: function (index) {
                    layer.close(index);
                }
            });
        }

        function set_supplier(s_name,s_id) {
            $("input[name='S_NAME']").val(s_name);
            $("input[name='S_ID_GET']").val(s_id);
        }
    });
</script>
</body>
</html>