<!DOCTYPE html>
<html>
<head>
    <title>项目决算</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <style>
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            /* 防止水平滚动条 */
            overflow-x: hidden;
        }
    </style>
    <script>
        $(document).ready(function () {
            var thisid = $(window.parent.document).find(".contractinfo-table tbody .selected").attr('fid');
            var tags = thisid + "_" + "STATUS";
            var status = $(window.parent.document).find("[name='" + tags + "']").val();

            $(".registerform2").Validform({
                tiptype: function (msg, o, cssctl) {
                    //msg：提示信息;
                    //o:{obj:*,type:*,curform:*}, obj指向的是当前验证的表单元素（或表单对象），type指示提示的状态，值为1、2、3、4， 1：正在检测/提交数据，2：通过验证，3：验证失败，4：提示ignore状态, curform为当前form对象;
                    //cssctl:内置的提示信息样式控制函数，该函数需传入两个参数：显示提示信息的对象 和 当前提示的状态（既形参o中的type）;

                    if (!o.obj.is("form")) {  //验证表单元素时o.obj为该表单元素，全部验证通过提交表单时o.obj为该表单对象;
                        o.obj.parents("td").append('<div class="info"><span class="Validform_checktip"> </span><span class="dec"><s class="dec1">&#9670;</s><s class="dec2">&#9670;</s></span></div>');

                        var objtip = o.obj.parents("td").find(".Validform_checktip");
                        cssctl(objtip, o.type);
                        objtip.text(msg);

                        var infoObj = o.obj.parents("td").find(".info");
                        if (o.type == 2) {
                            infoObj.fadeOut(200);
                        } else {
                            if (infoObj.is(":visible")) {
                                return;
                            }
                            var left = o.obj.offset().left,
                                    top = o.obj.offset().top;

                            infoObj.css({
                                left: left,
                                top: top - 45
                            }).show().animate({
                                top: top - 35
                            }, 200);
                        }
                    }
                },
                ignoreHidden: true,
                ajaxPost: true,
                beforeSubmit: function (curform) {
                    if (thisid) {
                        if (status == 1 || status == 2) {
                            alert('请不要重复提交');
                            return false;
                        }
                        $("#FINALACCOUNTS_ID").val(thisid);
                    } else {
                        alert('请选择要提交的类型');
                        return false;
                    }
                },
                beforeCheck: function () {
                },
                callback: function (data) {
                    if (data.status == 'y') {
                        // "{$paramUrl}";  去掉这一句会导致程序出问题，暂时没找到什么原因
                       // var url = "{:U('Case/opinionFlow_final',$paramUrl)}" + '&RECORDID=' + thisid;
						var url = "{:U('/Touch/Finalaccounts/show')}" + '&RECORDID=' + thisid;
                        window.parent.location.href = url;
                    } else alert(data.info);
                },
                usePlugin: {}
            });



			//保存 
            $("#ZHAD_SHIJI, #OFFSET_COST,#TOBEPAID_FUNDPOOL,#TOBEPAID_YEWU,#Z_TAX,#Z_COUNTERFEE").blur(function () {
                var PRJBUDGET_ID = $("#PRJBUDGET_ID").val();
                var UNDOTIME = $("#UNDOTIME").val();
				var OFFSET_COST = $("#OFFSET_COST").val();
				var ZHAD_SHIJI = $("#ZHAD_SHIJI").val();
				var TOBEPAID_FUNDPOOL = $("#TOBEPAID_FUNDPOOL").val();
				var TOBEPAID_YEWU = $("#TOBEPAID_YEWU").val();
				var Z_TAX = $("#Z_TAX").val();
				var Z_COUNTERFEE = $("#Z_COUNTERFEE").val();
				var FINAL_ACCOUNT_ID = $("#FINAL_ACCOUNT_ID").val();
                var that = $(this);
                var type = $(this).attr('id');  // 保存数值类型

                $.ajax({
                    url: "{:U('Case/project_finalaccounts',$paramUrl)}" +'&ischildren=1&act=savezjdata',
                    type: "post",
                    dataType: "JSON",
                    data: {
                        PRJBUDGET_ID: PRJBUDGET_ID,
                        UNDOTIME: UNDOTIME,
                        OFFSET_COST: OFFSET_COST,
                        ZHAD_SHIJI: ZHAD_SHIJI,
                        FINAL_ACCOUNT_ID: FINAL_ACCOUNT_ID,
                        TYPE: type,
						TOBEPAID_FUNDPOOL:TOBEPAID_FUNDPOOL,
						TOBEPAID_YEWU:TOBEPAID_YEWU,
						Z_TAX:Z_TAX,
						Z_COUNTERFEE:Z_COUNTERFEE



                    },
                    success: function (data) {
                        if (data.status == 'y') {
                            layer.tips('数据保存成功', that);
                            location.reload();
						}else  {
                            if (that.val() !== '') {
                                layer.tips(data.info, that);
                            }
                        }
                    }
                })
            });
			//保存 
            $("#UNDOTIME").blur(function () {
                var PRJBUDGET_ID = $("#PRJBUDGET_ID").val();
                var UNDOTIME = $("#UNDOTIME").val();
				var OFFSET_COST = $("#OFFSET_COST").val();
				var ZHAD_SHIJI = $("#ZHAD_SHIJI").val();
				var FINAL_ACCOUNT_ID = $("#FINAL_ACCOUNT_ID").val();
				var TOBEPAID_FUNDPOOL = $("#TOBEPAID_FUNDPOOL").val();
				var TOBEPAID_YEWU = $("#TOBEPAID_YEWU").val();
				var Z_TAX = $("#Z_TAX").val();
				var Z_COUNTERFEE = $("#Z_COUNTERFEE").val();
               
                $.ajax({
                    url: "{:U('Case/project_finalaccounts',$paramUrl)}" +'&ischildren=1&act=savezjdata',
                    type: "post",
                    dataType: "JSON",
                    data: {PRJBUDGET_ID: PRJBUDGET_ID, UNDOTIME: UNDOTIME, OFFSET_COST: OFFSET_COST,ZHAD_SHIJI:ZHAD_SHIJI,FINAL_ACCOUNT_ID:FINAL_ACCOUNT_ID,TOBEPAID_FUNDPOOL:TOBEPAID_FUNDPOOL,TOBEPAID_YEWU:TOBEPAID_YEWU,Z_TAX:Z_TAX,Z_COUNTERFEE:Z_COUNTERFEE},
                    success: function (data) {
                        if (data.status == 'y') {
							//window.location.reload();
						}else alert(data.info);
                    }
                })
            });


        });
    </script>
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="contractinfo-table">
            <form class='registerform2' action="{:U('Case/project_finalaccounts','&act=savezjdata')}" method="post">
                <table>
                    <thead>
                    <tr>
                        <td rowspan="2">进场时间</td>
                        <td rowspan="2">撤场时间</td>
                        <td rowspan="2">财务预收款</td>
                        <td rowspan="2">已开票回款</td>
                        <td colspan='2'>我方成本</td>
                        <td colspan="3">资金池及项目分成</td>
                        <td rowspan="2">付现利润</td>

						<td rowspan="2">待支付资金池</td>
						<td rowspan="2">待支付业务费</td>
						<td rowspan="2">税金</td>
						<td rowspan="2">POS机手续费</td>

                        <td rowspan="2">付现利润率</td>
						<td rowspan="2">实际广告费</td>
                        <td rowspan="2">利润率</td>
                        <td rowspan="2">立项预估收入</td>
                        <td rowspan="2">立项预估付现利润率</td>
                    </tr>
                    <tr>
                        <td>已报销费用</td>
                        <td>已发生未报销费用</td>
                        <td>已报销费用</td>
                        <td>已发生未报销费用</td>
                        <td>已冲抵费用</td>
                    </tr>
                    </thead>
                    <tbody>
                    <if condition="($data.status eq 0) or ($data.status eq 3)">
                        <tr><input type="hidden" name="PRJBUDGET_ID" id="PRJBUDGET_ID" value="{$data.PRJBUDGET_ID}"/>
                            <input type="hidden" name="FINAL_ACCOUNT_ID" id="FINAL_ACCOUNT_ID"
                                   value="{$data.FINAL_ACCOUNT_ID}"/>
                            <td>{$data.FROMDATE}</td>
                            <td><input type="text" name="UNDOTIME" size="10" datatype="s" onfocus="WdatePicker( )"
                                       value="{$data.UNDOTIME}" id="UNDOTIME" nullmsg="请填写撤场时间"/></td>
                            <td>{$data.caiwuyushou}</td>
                            <td>{$data.yikaipiaohk}</td>
                            <td>{$data.w_yibaoxiaofy}</td>
                            <td>{$data.w_yifswbxfy}</td>
                            <td>{$data.z_yibaoxiaofy}</td>
                            <td>{$data.z_yifswbxfy}</td>
                            <td>
                                <input type="text" name="OFFSET_COST" id="OFFSET_COST" value="{$data.z_yichongdi}" size="10"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/>
                            </td>
							


                            <td>{$data.fuxianlirun}</td>

							 <td>  <input type="text" name="TOBEPAID_FUNDPOOL" id="TOBEPAID_FUNDPOOL" value="{$data.tobepaid_fundpool}" size="10" ignore="ignore"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/></td>
							  <td>  <input type="text" name="TOBEPAID_YEWU" id="TOBEPAID_YEWU" value="{$data.tobepaid_yewu}" size="10" ignore="ignore"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/></td>
							   <td> <input type="text" name="Z_TAX" id="Z_TAX" value="{$data.z_tax}" size="10"  ignore="ignore"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/> </td>

									 <td>  <input type="text" name="Z_COUNTERFEE" id="Z_COUNTERFEE" value="{$data.Z_counterfee}" size="10"  ignore="ignore"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/></td>



                            <td>{$data.fuxianlirunlv}</td>
							 <td>
                                <input type="text" name="ZHAD_SHIJI" value="{$data.ZHAD_SHIJI}" id="ZHAD_SHIJI" size="10"
                                       
                                       datatype="money" errormsg="请输入正确数值，小数点精确至两位！" altercss="gray"/>
                            </td>
                            <td>{$data.lirunlv}</td>
                            <td>{$data.lixiangyugushouru}</td>
                            <td>{$data.lixiangyugufuxianlirunlv}</td>
                        </tr>
                        <else/>
                        <tr>
                            <td>{$data.FROMDATE}</td>
                            <td>{$data.UNDOTIME}</td>
                            <td>{$data.caiwuyushou}</td>
                            <td>{$data.yikaipiaohk}</td>
                            <td>{$data.w_yibaoxiaofy}</td>
                            <td>{$data.w_yifswbxfy}</td>
                            <td>{$data.z_yibaoxiaofy}</td>
                            <td>{$data.z_yifswbxfy}</td>
                            <td>{$data.z_yichongdi}</td>
                            <td>{$data.fuxianlirun}</td>

							 <td>{$data.tobepaid_fundpool}</td>
							  <td>{$data.tobepaid_yewu}</td>
							   <td>{$data.z_tax}</td>
							    <td>{$data.Z_counterfee}</td>

                            <td>{$data.fuxianlirunlv}</td>
							<td>{$data.ZHAD_SHIJI}</td>
                            <td>{$data.lirunlv}</td>
                            <td>{$data.lixiangyugushouru}</td>
                            <td>{$data.lixiangyugufuxianlirunlv}</td>
                        </tr>
                    </if>
                    </tbody>
                </table>
                <if condition="($data.status eq 0) or ($data.status eq 3)">
                    <div style="padding:10px;margin-top:30px;text-align:center; " class="handle-btn"><input class="btn btn-primary" type='submit' name=''
                            value='提交'></div>
                </if>
            </form>
        </div>
    </div>
</div>
</body>
</html>
