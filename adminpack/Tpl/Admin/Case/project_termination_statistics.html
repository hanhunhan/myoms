<!DOCTYPE html>
<html>
<head>
    <title>项目决算</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
    <!--<link href="./Public/css/jquery-ui.css" type="text/css" rel="stylesheet"/>-->
    <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/jquery-ui.js"></script>-->
    <!--<script type="text/javascript" src="./Public/layer/layer.js"></script>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>-->
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <style>
        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            /* 防止水平滚动条 */
            overflow-x: hidden;
        }
    </style>
    <script>
        $(document).ready(function () {
            var thisid = $(window.parent.document).find(".contractinfo-table tbody .selected").attr('fid');
            var tags = thisid + "_" + "STATUS";
            var status = $(window.parent.document).find("[name='" + tags + "']").val();

            $(".registerform2").Validform({
                tiptype: function (msg, o, cssctl) {
                    //msg：提示信息;
                    //o:{obj:*,type:*,curform:*}, obj指向的是当前验证的表单元素（或表单对象），type指示提示的状态，值为1、2、3、4， 1：正在检测/提交数据，2：通过验证，3：验证失败，4：提示ignore状态, curform为当前form对象;
                    //cssctl:内置的提示信息样式控制函数，该函数需传入两个参数：显示提示信息的对象 和 当前提示的状态（既形参o中的type）;

                    if (!o.obj.is("form")) {  //验证表单元素时o.obj为该表单元素，全部验证通过提交表单时o.obj为该表单对象;
                        o.obj.parents("td").append('<div class="info"><span class="Validform_checktip"> </span><span class="dec"><s class="dec1">&#9670;</s><s class="dec2">&#9670;</s></span></div>');

                        var objtip = o.obj.parents("td").find(".Validform_checktip");
                        cssctl(objtip, o.type);
                        objtip.text(msg);

                        var infoObj = o.obj.parents("td").find(".info");
                        if (o.type == 2) {
                            infoObj.fadeOut(200);
                        } else {
                            if (infoObj.is(":visible")) {
                                return;
                            }
                            var left = o.obj.offset().left,
                                    top = o.obj.offset().top;

                            infoObj.css({
                                left: left,
                                top: top - 45
                            }).show().animate({
                                top: top - 35
                            }, 200);
                        }

                    }
                },
                ignoreHidden: true,
                ajaxPost: true,
                beforeSubmit: function (curform) {


                    if (thisid) {
                        if (status == 1 || status == 2) {
                            alert('请不要重复提交');
                            return false;
                        }
                        //window.parent.location.href=url;
                        $("#FINALACCOUNTS_ID").val(thisid);

                    } else {
                        alert('请选择要提交的类型');
                        return false;
                    }
                },
                beforeCheck: function () {

                },
                callback: function (data) {
                    if (data.status == 'y') {
                        //alert('保存成功！');
                        //var url = "{:U('Case/opinionFlow_termination',$paramUrl)}" + '&RECORDID=' + thisid;
                        var url = "{:U('/Touch/ProjectTermination/show')}" + '&RECORDID=' + thisid;
						window.parent.location.href = url;
                    } else alert(data.info);


                },
                usePlugin: {}
            });

            // 为折后广告费用绑定失去焦点事件，以将折后广告费写入数据库
           // $('input[name="ZHAD_SHIJI"]').blur(function () {
			$("#ZHAD_SHIJI,#ZJYUANYIN").blur(function () {
                var zhad = $('input[name="ZHAD_SHIJI"]').val().trim();
				var ZJTIME = $("#ZJTIME").val();
				var ZJYUANYIN = $("#ZJYUANYIN").val();
				 

                // 更新折后广告成功
                function updateZhadSuccess(data, status, xhr) {
                    //layer.tips(data.msg, '#ZHAD_SHIJI');
                    if (data.state == 1) {
						window.location.reload();
                        var realIncome = parseFloat($('#real_income').text());
                        var cashProfit = parseFloat(parseFloat($('#cash_profit').text()));
                        zhad = parseFloat(zhad);
                        var rate = ((cashProfit - zhad) * 100 / realIncome).toFixed(2);
                        if (rate > 0) {
                            $('#overall_profit_rate').text(String(rate) + '%');
                        }
                    }
                }

                // 更新折后广告失败
                function updateZhadFail(xhr, status, err) {
                    //layer.tip('服务器内部错误', '#ZHAD_SHIJI')
                }

                // 异步请求存储数值
                $.ajax({
                    url: "{:U('Case/asyncUpdateFinalAccounts',$paramUrl)}",
                    type: "post",
                    dataType: "JSON",
                    data: {ZHAD_SHIJI: zhad,ZJTIME:ZJTIME,ZJYUANYIN:ZJYUANYIN},
                    success: updateZhadSuccess,
                    error: updateZhadFail
                })

            });

			$("#ZJTIME").blur(function () {
                var zhad = $('input[name="ZHAD_SHIJI"]').val().trim();
				var ZJTIME = $("#ZJTIME").val();
				var ZJYUANYIN = $("#ZJYUANYIN").val();
				 

                // 更新折后广告成功
                function updateZhadSuccess(data, status, xhr) {
                    //layer.tips(data.msg, '#ZJTIME');
                    if (data.state == 1) {
						//window.location.reload();
                        
                    }
                }

                // 更新折后广告失败
                function updateZhadFail(xhr, status, err) {
                    //layer.tip('服务器内部错误', '#ZJTIME')
                }

                // 异步请求存储数值
                $.ajax({
                    url: "{:U('Case/asyncUpdateFinalAccounts',$paramUrl)}",
                    type: "post",
                    dataType: "JSON",
                    data: {ZHAD_SHIJI: zhad,ZJTIME:ZJTIME,ZJYUANYIN:ZJYUANYIN},
                    success: updateZhadSuccess,
                    error: updateZhadFail
                })

            });

        });
    </script>

</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="contractinfo-table">
            <form class='registerform2' action="{:U('Case/project_termination','&act=savezjdata')}" method="post">
                <table>
                    <thead>
                    <tr>
                        <td rowspan="2">执行开始时间</td>
                        <td rowspan="2">执行结束时间</td>
                        <td rowspan="2">终止时间</td>
                        <td rowspan="2">终止原因</td>
                        <td colspan='2'>收入</td>
                        <td colspan="2">线下费用</td>
                        <td colspan="2">付现利润</td>
                        <td colspan="2">付现利润率</td>
                        <td colspan="2">综合利润率</td>
                        <td colspan="2">折后广告</td>
                        　
                    </tr>
                    <tr>　
                        <td>实际</td>
                        <td>预估</td>
                        <td>实际</td>
                        <td>预估</td>
                        <td>实际</td>
                        <td>预估</td>
                        <td>实际</td>
                        <td>预估</td>
                        <td>实际</td>
                        <td>预估</td>
                        <td>实际</td>
                        <td>预估</td>
                    </tr>
                    </thead>
                    <tbody>
                    <if condition="($data.status eq 0) or ($data.status eq 3)">
                        <tr><input type="hidden" name="FINALACCOUNTS_ID" id="FINALACCOUNTS_ID" value=""/>
                            <td>{$data.FROMDATE}</td>
                            <td>{$data.TODATE}</td>
                            <td><input type="text" name="ZJTIME" id="ZJTIME" size="10" datatype="s" onfocus="WdatePicker( )"
                                       value="{$data.ZJTIME}"/></td>
                            <td><textarea name="ZJYUANYIN" cols="10"  id="ZJYUANYIN" rows="2" datatype="s">{$data.ZJYUANYIN}</textarea>
                            </td>
                            <td id="real_income">{$data.shouru_shiji}</td>
                            <td>{$data.shouru_yugu}</td>
                            <td>{$data.xianxia_shiji}</td>
                            <td>{$data.xianxia_yugu}</td>
                            <td id="cash_profit">{$data.fuxianlirun_shiji}</td>
                            <td>{$data.fuxianlirun_yugu}</td>
                            <td>{$data.fuxianlirunlv_shiji}</td>
                            <td>{$data.fuxianlirunlv_yugu}</td>
                            <td id="overall_profit_rate">{$data.zhlirunlv_shiji}</td>
                            <td>{$data.zhlirunlv_yugu}</td>
                            <td>
                                <input type="text" name="ZHAD_SHIJI" value="{$data.ZHAD_SHIJI}" size="10"
                                       id="ZHAD_SHIJI"
                                       datatype="money" errormsg="请输入正确数值 小数点精确至两位！" altercss="gray"/></td>
                            <td>{$data.zhad_yugu}</td>
                        </tr>
                        <else/>
                        <tr>
                            <td>{$data.FROMDATE}</td>
                            <td>{$data.TODATE}</td>
                            <td>{$data.ZJTIME}</td>
                            <td>{$data.ZJYUANYIN}</td>
                            <td>{$data.shouru_shiji}</td>
                            <td>{$data.shouru_yugu}</td>
                            <td>{$data.xianxia_shiji}</td>
                            <td>{$data.xianxia_yugu}</td>
                            <td>{$data.fuxianlirun_shiji}</td>
                            <td>{$data.fuxianlirun_yugu}</td>
                            <td>{$data.fuxianlirunlv_shiji}</td>
                            <td>{$data.fuxianlirunlv_yugu}</td>
                            <td>{$data.zhlirunlv_shiji}</td>
                            <td>{$data.zhlirunlv_yugu}</td>
                            <td>{$data.ZHAD_SHIJI}</td>
                            <td>{$data.zhad_yugu}</td>
                        </tr>
                    </if>
                    </tbody>
                </table>

                <if condition="($data.status eq 0) or ($data.status eq 3)">
                    <div style="padding:10px;margin-top:30px;text-align:center; " class="handle-btn"><input  class="btn btn-primary" type='submit' name=''
                            value='提交'></div>
                </if>
            </form>
        </div>
    </div>
</div>
</body>
</html>
