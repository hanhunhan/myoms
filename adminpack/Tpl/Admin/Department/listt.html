<html>
<head>
    <meta charset="GBK">
    <title>部门管理</title>
    <link rel=stylesheet href="./Tpl/css/global.css" type="text/css">
    <link rel=stylesheet href="./Tpl/css/mainPage.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="./Public/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="./Public/easyui/themes/icon.css">
    <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./Public/easyui/jquery.easyui.min.js"></script>

    <style>
        .showform tr {
            padding: 10px;
        }
    </style>
    <script type="text/javascript">

        var editingId;
        function edit() {

            var row = $('#tg').treegrid('getSelected');
            if (row) {
                editingId = row.ID
                $('#tg').treegrid('beginEdit', editingId);
            }
        }
        function save() {
            if (editingId != undefined) {
                var t = $('#tg');
                t.treegrid('endEdit', editingId);

                //t.treegrid('reloadFooter');

            }
        }
        function svaerows(rows, changes) {
            console.log(rows);
            if (changes) {
                $.post('__SELF__&mod=edit', {
                    ID: rows.ID,
                    DMNAME: rows.DMNAME,
                    LEVELS: rows.LEVELS,
                    QUEUE: rows.QUEUE,
                    STATUS: rows.STATUS
                }, function (d) {
                    d = eval('(' + d + ')');
                    if (d.msg == 'ok') {
                        $.messager.alert('提示', '保存成功!');
                    } else {
                        $.messager.alert('提示', '保存失败!', 'error');
                    }

                });
            }
        }

        function cancel() {
            if (editingId != undefined) {
                $('#tg').treegrid('cancelEdit', editingId);
                editingId = undefined;
            }
        }

        function add() {
            var row = $('#tg').treegrid('getSelected');
            if (row) {
                $('#w').window('open');
            } else {
                $.messager.alert('提示', '请选择上级目录!');
                return false;
            }
        }

        $(function () {
            $('#ff').form({
                url: '__SELF__&mod=add',
                onSubmit: function (param) {
                    param.DMNAME = encodeURI($('input[name=DMNAME]').val());

                    var row = $('#tg').treegrid('getSelected');
                    if (row) {
                        var level = $('#tg').treegrid('getLevel', row.ID);
                        param.PARENTID = row.ID;
                        param.LEVELS = level;
                    } else {
                        $.messager.alert('提示', '请选择上级目录!');
                        return false;
                    }
                },
                success: function (data) {
                    d = eval('(' + data + ')');
                    if (d.msg == 'ok') {
                        $.messager.alert('提示', '添加成功!', 'info');

                        $('#DMNAME').textbox('clear');
                        $('#LEVELS').textbox('clear');
                        $('#QUEUE').textbox('clear');
                        $('#w').window('close');
                        $('#tg').treegrid('reload');
                    }
                }
            });
        });
        var arrstatus = [{status: '-1', name: '有效'}, {status: '0', name: '禁用'}];
    </script>
</head>
<body>
<div class="box" id="interestManage">
    <div class="box-tit"><h3>部门管理</h3></div>
    <div class="box-con">
        <table id="tg" class="easyui-treegrid" title="部门" style="width:80%;height:500px;"
               data-options="
							iconCls: 'icon-ok',
							rownumbers: true,
							animate: true,
							collapsible: true,
							fitColumns: true,
							url: '__SELF__&mod=getJson',
							method: 'POST',
							idField: 'ID',
							treeField: 'DMNAME',
							lines: true,
							showFooter: true,
							collapsible:false,
							onAfterEdit:svaerows">
            <thead>
            <tr>
                <th data-options="field:'DMNAME',width:180,editor:'text'">部门名称</th>
                <th data-options="field:'LEVELS',width:80">层级</th>
                <th data-options="field:'QUEUE',width:80,editor:'numberbox'">排序</th>
                <th data-options="field:'STATUS',width:120,                       formatter:function(value,row){
								for(var i=0; i<arrstatus.length; i++){  
									if (arrstatus[i].status == value) return arrstatus[i].name;  
								}  
								return value;  
							},
							editor:{
                            type:'combobox',
                            options:{
                                valueField:'status',
                                textField:'name',
                                data:arrstatus,
                                required:true
                            }
                        }">状态
                </th>
            </tr>
            </thead>
        </table>
        <div style="margin:20px 0;">
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="add()">新增</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="edit()">编辑</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="save()">保存</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancel()">取消</a>
        </div>
    </div>
</div>

<div id="w" class="easyui-window" title="新增" style="width:300px;height:300px;padding:10px;" data-options="
            iconCls:'icon-save',
			closed:true,
			minimizable:false,
			maximizable:false,
			collapsible:false,
            onResize:function(){
                $(this).window('hcenter');
            }">
    <form id="ff" method="post">
        <table cellpadding="5" class="showform">
            <tr>
                <td>部门:</td>
                <td><input class="easyui-textbox" type="text" name="DMNAME" id="DMNAME"
                           data-options="required:true"></input></td>
            </tr>
            <tr>
                <td>排序:</td>
                <td><input class="easyui-textbox" type="text" name="QUEUE" id="QUEUE"
                           data-options="required:true,validType:'num'"></input></td>
            </tr>
            <tr>
                <td>状态:</td>
                <td><select class="easyui-combobox" name="STATUS" data-options="required:true">
                    <option value="-1">可用</option>
                    <option value="0">禁用</option>
                </select></td>
            </tr>
            <tr>
                <td></td>
                <td><input type="submit" value="提交"></input></td>
            </tr>
        </table>
    </form>
</div>
</body>
</html>
