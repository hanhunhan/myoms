<!DOCTYPE html>
<html>
    <head>
        <title>置换仓库</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <include file="./Tpl/Admin/Public/comm_css_js.html" />

        <style>
            .ui-autocomplete-input {
                background-image: none;
            }

            input.settle-percent, input.settle-amount, input.settle-money{
                border: 1px solid #ccc;
                padding: 4px 8px;
                border-radius: 4px;
                margin-right: 5px;
                outline: none;
            }

            .layer-content {
                /*min-height: 50px;*/
            }

            .layui-layer-content {
                /*min-height: 50px;*/
                padding: 20px 15px;
            }

            .table-input {
                padding: 4px;
                text-indent: 6px;
                border-radius: 4px;
                border: 1px solid #ccc;
                border-top: 1px solid #aaa;
                outline: none;
            }

            .template-form-wrap {
                border: 1px solid #ccc;
                margin-top: 30px;
                padding: 20px;
            }

            .text-red {
                color: #f00;
            }
            
            .star-mark {
                font-style: normal;
                color: #f00;
            }
        </style>
    </head>
    <body>
        <div class="containter">
            <div class="right fright j-right">
                <div class="handle-tab">{$tabs}</div>
                <div>{$form}</div>
            </div>
        </div>
    <!--确认入库-->
    <script id="confirmInbound" type="text/html">
        <div class="contractinfo-table">
            <table>
                <thead>
                    <tr>
                        <td>编号</td>
                        <td>合同编号</td>
                        <td>项目名称</td>
                        <td>品牌</td>
                        <td>型号</td>
                        <td>品名</td>
                        <td>货源</td>
                        <td>单价</td>
                        <td>置换池数量</td>
                        <td>入库数量</td>
                    </tr>
                </thead>
                <tbody>                 
                    {{each list as value i}} 
                    <tr>                  
                        <td>{{value.ID}}</td>
                        <td>{{value.CONTRACT}}</td>
                        <td>{{value.PROJECTNAME}}</td>
                        <td>{{value.BRAND}}</td>
                        <td>{{value.MODEL}}</td>
                        <td>{{value.PRODUCTNAME}}</td>
                        <td>{{value.SOURCE}}</td>
                        <td>{{value.PRICE}}</td>
                        <td id="{{value.ID}}_NUM_OLD">{{value.NUMOLD}}</td>
                        <td><input type="text" name="{{value.ID}}_NUM" value="{{value.NUMOLD}}" class="settle-amount"></td>
                    </tr>
                    {{/each}}
               
                </tbody>
            </table>          
        </div>
    </script>
    
    <!--折（溢）价售卖-->
    <script id="discount_sale_tpl" type="text/html">
        <div class="contractinfo-table layer-content">
            <table>
                <thead>
                <tr>
                    <th>编号</th>
                    <th>合同编号</th>
                    <th>项目名称</th>
                    <th>品牌</th>
                    <th>型号</th>
                    <th>品名</th>
                    <th>货源</th>
                    <th>置换单价</th>
                    <th>售卖单价</th>
                    <th>库存数量</th>
                    <th>售卖数量</th>
                </tr>
                </thead>
                <tbody>
                {{each list}}
                <tr>
                    <td>{{$value.ID}}</td>
                    <td>{{$value.CONTRACT}}</td>
                    <td>{{$value.PROJECTNAME}}</td>
                    <td>{{$value.BRAND}}</td>
                    <td>{{$value.MODEL}}</td>
                    <td>{{$value.PRODUCT_NAME}}</td>
                    <td>{{$value.SOURCE}}</td>
                    <td>{{$value.PRICE}}</td>
                    <td><input type="text" class="settle-money" data-id="{{$value.ID}}" id="{{$value.ID}}_sale_money"  value="{{$value.PRICE}}"/></td>
                    <td>{{$value.NUM}}</td>
                    <td><input type="text" class="settle-amount" data-id="{{$value.ID}}" data-max-amount="{{$value.NUM}}" id="{{$value.ID}}_sale_amount" attr="{{$value.NUM}}" value="{{$value.NUM}}"/></td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
        <div class="template-form-wrap">
            <form class="form-horizontal" role="form">
                <div class="form-group">
                    <label class="col-sm-2 control-label">总金额：</label>
                    <div class="col-sm-6">
                        <p class="form-control-static"><span id="total_sale_money">{{total_money}}</span>元</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">买家<i class="star-mark">*</i>：</label>
                    <div class="col-sm-6">
                        <input type="text" name="buyer" id="buyer" class="form-control" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">售卖说明<i class="star-mark">*</i>：</label>
                    <div class="col-sm-6">
                        <textarea id="remark" name="remark" rows="5" class="form-control"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </script>
    
     <!--内部领用-->
    <script id="inner_use_tpl" type="text/html">
        <div class="contractinfo-table  layer-content">
            <table>
                <thead>
                <tr>
                    <th>编号</th>
                    <th>合同编号</th>
                    <th>项目名称</th>
                    <th>品牌</th>
                    <th>型号</th>
                    <th>品名</th>
                    <th>货源</th>
                    <th>置换单价</th>
                    <th>置换数量</th>
                    <th>领用数量</th>
                </tr>
                </thead>
                <tbody>
                {{each list}}
                <tr>
                    <td>{{$value.ID}}</td>
                    <td>{{$value.CONTRACT}}</td>
                    <td>{{$value.PROJECTNAME}}</td>
                    <td>{{$value.BRAND}}</td>
                    <td>{{$value.MODEL}}</td>
                    <td>{{$value.PRODUCT_NAME}}</td>
                    <td>{{$value.SOURCE}}</td>
                    <td>{{$value.PRICE}}</td>                 
                    <td>{{$value.NUM}}</td>
                    <td>
                        <input type="hidden" class="settle-money" data-id="{{$value.ID}}" id="{{$value.ID}}_sale_money" attr="{{$value.PRICE}}"  value="{{$value.PRICE}}"/>
                        <input type="text" class="settle-amount" data-id="{{$value.ID}}" data-max-amount="{{$value.NUM}}" id="{{$value.ID}}_sale_amount" attr="{{$value.NUM}}"  value="{{$value.NUM}}"/>
                    </td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
        <div class="template-form-wrap">
            <form class="form-horizontal" role="form">
                <div class="form-group">
                    <label class="col-sm-2 control-label">总金额：</label>
                    <div class="col-sm-6">
                        <p class="form-control-static"><span id="total_sale_money">{{total_money}}</span>元</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">领用说明<i class="star-mark">*</i>：</label>
                    <div class="col-sm-6">
                        <textarea id="remark" name="remark" rows="5" class="form-control"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </script>
    
    <!--报损-->
    <script id="damage_report_tpl" type="text/html">
        <div class="contractinfo-table  layer-content">
            <table>
                <thead>
                <tr>
                    <th>编号</th>
                    <th>合同编号</th>
                    <th>项目名称</th>
                    <th>品牌</th>
                    <th>型号</th>
                    <th>品名</th>
                    <th>货源</th>
                    <th>置换单价</th>
                    <th>置换数量</th>
                </tr>
                </thead>
                <tbody>
                {{each list}}
                <tr>
                    <td>{{$value.ID}}</td>
                    <td>{{$value.CONTRACT}}</td>
                    <td>{{$value.PROJECTNAME}}</td>
                    <td>{{$value.BRAND}}</td>
                    <td>{{$value.MODEL}}</td>
                    <td>{{$value.PRODUCT_NAME}}</td>
                    <td>{{$value.SOURCE}}</td>
                    <td>{{$value.PRICE}}</td>
                    <td>
                        {{$value.NUM}}
                        <input type="hidden" class="settle-money" data-id="{{$value.ID}}" id="{{$value.ID}}_sale_money" attr="{{$value.PRICE}}"  value="{{$value.PRICE}}"/>
                        <input type="hidden" class="settle-amount" data-id="{{$value.ID}}" data-max-amount="{{$value.NUM}}" id="{{$value.ID}}_sale_amount" attr="{{$value.NUM}}"  value="{{$value.NUM}}"/>
                    </td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
        <div class="template-form-wrap">
            <form class="form-horizontal" role="form">
                <div class="form-group">
                    <label class="col-sm-2 control-label">总金额：</label>
                    <div class="col-sm-6">
                        <p class="form-control-static"><span id="total_sale_money">{{total_money}}</span>元</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">报损说明<i class="star-mark">*</i>：</label>
                    <div class="col-sm-6">
                        <textarea id="remark" name="remark" rows="5" class="form-control"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </script>
    
    <script type="text/javascript">

        /**
         * 置换各种操作处理
         */
        $(document).on('keyup', 'input.settle-amount,input.settle-money', function () {
            var fid = 0,originNum = 0,amount = 0;
            fid = $(this).attr("data-id"); //id
            originNum = $('#' + fid + '_sale_amount').attr("data-max-amount"); //原始数量
            amount = $('#' + fid + '_sale_amount').val(); //当前数量

            if(parseInt(amount) > parseInt(originNum)){
                alert('对不起，填写数量超出!');
            }
            getTotalMoney();

        });

        function save2DigsAfterPoint(num) {
            return Math.round(num * 100) / 100;
        }

        function getTotalMoney(){

            var total_money = 0;

            $("input.settle-amount").each(function(){
                var fid = 0,money = 0,amount = 0;
                fid = $(this).attr("data-id"); //id
                amount = $('#' + fid + '_sale_amount').val(); //当前数量
                money = $('#' + fid + '_sale_money').val(); //当前金额
                total_money += amount * money;
            });

            $("#total_sale_money").text(save2DigsAfterPoint(total_money));
        }

        $(function(){

            //超过报警时间状态栏变色，并且物品状态依然处于已入库状态
            var mydate = new Date();
            var nowTime = mydate.toLocaleDateString();

            $('.checkedtd').each(function(){
                var i = 0;
                var fId = new Array();
                fId[i] = $(this).val();                              
                var alarmTime = $("input[name="+fId[i]+"_ALARMTIME_OLD]").val(); 
                var liveTime = $("input[name="+fId[i]+"_LIVETIME_OLD]").val();
                var inboundStatus = $("input[name="+fId[i]+"_INBOUND_STATUS_OLD]").val();
                nowTime = Date.parse(new Date())
                alarmTime = Date.parse(new Date(alarmTime.replace(/-/g,"/")))
                if(nowTime >=  alarmTime && alarmTime != "" && (inboundStatus == 2 || inboundStatus == 1)){
                    $("tr[fid = "+fId[i]+"]").css("color","red")
                }
                i++
            });


            //置换仓库确认入库
            $("#confirm_inbound").click(function(){
                var i  = 0;
                var confirmInbound = new Array();
                var dataList = new Array();
                var contractArr = new Array();
                var projectNameArr = new Array();
                var brandArr = new Array();
                var modelArr = new Array();
                var productNameArr = new Array();
                var sourceArr = new Array();
                var priceArr = new Array();
                var statusArr = new Array();
                var arr = new Array();
                var numOldArr = new Array();
                var inboundStatus = new Array();

                $('.checkedtd').each(function(){
                    if($(this).prop("checked") == true) {
                        confirmInbound[i] = $(this).val();                
                        inboundStatus[i] = $("input[name="+confirmInbound[i]+"_INBOUND_STATUS_OLD]").val();
                        contractArr[i] = $("input[name="+confirmInbound[i]+"_CONTRACT_ID_OLD]").prev().prev().html();
                        projectNameArr[i] = $("input[name="+confirmInbound[i]+"_PROJECT_NAME_OLD]").val();
                        brandArr[i] = $("input[name="+confirmInbound[i]+"_BRAND_OLD]").val();
                        modelArr[i] = $("input[name="+confirmInbound[i]+"_MODEL_OLD]").val();
                        productNameArr[i] = $("input[name="+confirmInbound[i]+"_PRODUCT_NAME_OLD]").val();
                        sourceArr[i] = $("input[name="+confirmInbound[i]+"_SOURCE_OLD]").val();
                        priceArr[i] = $("input[name="+confirmInbound[i]+"_PRICE_OLD]").val();
                        numOldArr[i] = $("input[name="+confirmInbound[i]+"_NUM_OLD]").val();
                        i++;
                    }
                });

                for(var j = 0,len = confirmInbound.length; j < len; j++ ){
                    if(inboundStatus[j] != 1){
                        layer.alert("入库失败，已入库商品不能入库", {icon: 0});
                         return false;
                    }
                }

                if (confirmInbound.length <= 0) {
                    layer.alert("请选择要入库的明细记录", {icon: 0});
                    return false;
                }else{
                    for(var j = 0,len = confirmInbound.length; j < len; j++ ){
                        dataList = [{"ID":confirmInbound[j],"CONTRACT":contractArr[j],"PROJECTNAME":projectNameArr[j],"BRAND":brandArr[j],"MODEL":modelArr[j],
                        "PRODUCTNAME":productNameArr[j],"SOURCE":sourceArr[j],"PRICE":priceArr[j],"NUMOLD":numOldArr[j],"STATUS":statusArr[j]}];
                        arr = arr.concat(dataList);                     
                    }
                    var data = {
                        list: arr ,                 
                    }
                    // todo                
                    layer.open({              
                        type: 1,
                        title: '确认入库',
                        btn:['确定','取消'],
                        shadeClose: true,
                        shade: 0.8,
                        area: ['1000px', 'auto'],
                        content: template('confirmInbound', data),
                        yes: function(index, layero){
                            var Num = new Array();
                            var NumOld = new Array();
                            for(var n = 0, size = confirmInbound.length ; n < size ; n ++){
                                Num[n] = $("input[name=" + confirmInbound[n] + "_NUM]", '.layui-layer-content').val();
                                if(Num[n] <= 0){
                                    layer.alert("编号为"+confirmInbound[n]+"的入库数量应该填写正整数", {icon: 0});
                                    return false;
                                }
                                /*NumOld[n] = $("#"+confirmInbound[n] +"_NUM_OLD ").html();
                                alert(Num[n])
                                alert(NumOld[n])
                                if(NumOld[n] < Num[n]){
                                    layer.alert("入库数量不能超过置换池数量", {icon: 0});
                                    return false;
                                }*/
                            }
                            $.ajax({
                                type: "post",
                                url: "{:U('Displace/confirmInbound')}",
                                data: {fId:confirmInbound , num: Num},
                                dataType: "JSON",
                                success: function (data) {
                                    if (data.status == 1) {
                                        layer.alert(data.msg, {icon: 1},
                                                function (index) {
                                                    window.location.reload();
                                                    layer.close(index);
                                                });

                                    } else if (data.status == 0) {
                                        layer.alert(data.msg, {icon: 2})
                                    } else if (data.status == "noauth"){
                                        layer.alert(data.msg, {icon: 2})
                                    }
                                }
                            })
                        }
                    });
                }    
            })
            
            /**
             * 获取IDs
             */
            function getDisplaceIds() {
                var ids = [];
                $("input[name='checkedtd']:checkbox").each(function () {
                    if ($(this).prop("checked") == true) {
                        ids.push($(this).val());
                    }
                });
                return ids;
            }

            // 导出报表
            $('#export_excel').click(function () {
                var filterSql = "{$filter_sql}";
                var sortSql = "{$sort_sql}";
                layer.confirm('确定导出报表?', {icon: 3, title: '导出报表'}, function (index) {
                    layer.close(index);
                    location.href = "{:U('Displace/exportDisplace')}" + '/filter/' + filterSql + '/sort/' + sortSql;
                });
            });

            /**
             * 1：折（溢）价售卖
             * 2：内部领用
             * 3：报损
             */
            $("#discount_sale , #inner_use , #damage_report").click(function(){
                var DisplaceIds = getDisplaceIds();

                if (!DisplaceIds.length) {
                    layer.open({content: '亲,请至少选择一条仓库记录！', icon: 7});
                    return;
                }

                var actName = $(this).attr("id");
                createRequestForm(DisplaceIds);
                //创建售卖菜单
                function createRequestForm(DisplaceIds){
                    if (DisplaceIds instanceof Array && DisplaceIds.length) {

                        var tplId = 'discount_sale_tpl';  // 售卖
                        var postUrl = "{:U('Displace/ajaxPostInboundUse',array('Inbound_status'=>1))}" 
                        var tplName = '折（溢）价售卖';

                        if (actName == 'inner_use') {    //内部领用
                            tplId = 'inner_use_tpl';
                            postUrl = "{:U('Displace/ajaxPostInboundUse',array('Inbound_status'=>2))}";
                            tplName = '公司内部领用';
                        }
                        else if(actName == 'damage_report'){  //报损
                            tplId = 'damage_report_tpl';
                            postUrl = "{:U('Displace/ajaxPostInboundUse',array('Inbound_status'=>3))}";
                            tplName = '报损';
                        }

                        //获取置换仓库的明细数据
                        $.ajax({
                            url: "{:U('Displace/ajaxGetDisplaceData')}",
                            data: {
                                displace_ids: DisplaceIds,
                                act_name: actName
                            },
                            type: 'POST',
                            success: onGetDataSuccess
                        });

                        function onGetDataSuccess(resp, xhr) {
                            if ($.type(resp) === 'string') {
                                resp = JSON.parse(resp);
                            }

                            if (resp.status == 'noauth') {
                                var msg = resp.msg || '没有权限';
                                layer.open({
                                    content: msg,
                                    icon: 2
                                });
                                return;
                            }

                            if (!resp.status) {
                                var msg = resp.msg || '获取数据失败';
                                layer.open({
                                    content: msg,
                                    icon: 2
                                });
                                return;
                            }
                            
                            if (!resp.data.list.length) {
                                return '';
                            }
                            var respList = resp.data.list;


                            layer.open({
                                type :1,
                                title: tplName,
                                skin: 'layui-layer-rim',
                                btn: ['确定', '取消'],
                                area: ['1000px', 'auto'],
                                content: template(tplId, resp.data),
                                yes: function () {
                                    if(($("#remark")).val() == ""){
                                        if(tplId == 'discount_sale_tpl'){
                                            alert("售卖说明不能为空");
                                            return false;
                                        }else if(tplId == 'inner_use_tpl'){
                                            alert("领用说明不能为空");
                                            return false;
                                        }else if(tplId == 'damage_report_tpl'){
                                            alert("报损说明不能为空");
                                            return false;
                                        }                                     
                                    }

                                    var remarkStr = $("#remark").val();
                                    if(remarkStr.length >300){
                                        alert("亲，说明文字长度超出");
                                        var remarkInfo = remarkStr.substring(0,300);
                                        $("#remark").val(remarkInfo);
                                        return false;
                                    }

                                    if($("#buyer").val() == ""){
                                        alert("买家不能为空");
                                        return false;
                                    }
                                    
                                    var params = getParams();
                                    var caseId = '{$caseId}';
                                    $.ajax({
                                        url: postUrl,
                                        data: { displace_data: params, case_id: caseId },
                                        async:false,
                                        type: 'POST',
                                        dataType: 'json',
                                        success: function(data){                                                                               
                                            if(data.status == 0){
                                                alert(data.msg);
                                            }else{
                                                var appUrl = "__APP__";
                                                var flowId = data.flowId;
                                                var flowTypePinYin = data.flowTypePinYin;
                                                var url = appUrl + '/Touch/InboundUse/process&RECORDID=' + flowId + '&flowTypePinYin=' + flowTypePinYin ;
                                                window.location.href = url;
                                            }
                                        },
                                        error:function(data){
                                            alert("操作失败");
                                        }
                                    });
                                },
                                cancel: function () {
                                    // todo
                            }
                        });

                        //获取参数
                        function getParams() {
                            var params = {};
                            params.list = [];
                            // 获取每条记录设定的单价与数量
                            for (var i = 0; i < respList.length; i++) {
                                var one = {};
                                one.id = respList[i].ID;
                                one.money = $('#' + one.id + '_sale_money').val();
                                one.amount = $('#' + one.id + '_sale_amount').val();
                                params.list.push(one);
                            }
                            params.reason = $("#remark").val();
                            params.buyer = $("#buyer").val();
                            params.total_money = $('#total_sale_money').text();

                            return params;
                            }

                        }
                    }
                }    
            })
        })
     
    </script>
    <include file="./Tpl/Admin/Public/filter.html"/>
    </body>
</html>