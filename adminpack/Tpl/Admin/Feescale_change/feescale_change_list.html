<!DOCTYPE html>
<html>
<head>
    <title>标准调整</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
    <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
    <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>-->
    <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>-->
    <!--<script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>-->
    <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>-->
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <script>
        $(function () {
            $(".CASE_ID").attr("readonly", "readpnly");
            $("select[name='SCALETYPE']").change(function () {
                var scaletype = $(this).val();
                var prjid = $("#prjid").val();
                if (scaletype != "") {
                    if(scaletype == 8){
                        $("select[name='TYPE']").val(0);
                        $("select[name='TYPE'] option[value=1]").css("display","none");
                        $("select[name='TYPE'] option[value=3]").css("display","none");
                    }else{
                        $("select[name='TYPE'] option[value=1]").css("display","block");
                        $("select[name='TYPE'] option[value=3]").css("display","block");
                    }
                    $.ajax({
                        type: "post",
                        url: "{:U('Feescale_change/feescale_change_list',array('showForm'=>1))}",
                        dataType: "text",
                        data: {"scaletype": scaletype, "prjid": prjid},
                        success: function (res) {
                            if (res) {
                                $(".CASE_ID").val(res);
                            } else {
                                layer.alert('没有找到相关案例!', {icon: 2});
                                $(".CASE_ID").val(res);
                                return false;
                            }
                        }
                    })
                } else {
                    $(".CASE_ID").val("");
                }
                
            })
            
            var scstatus = $("select[name='SCALETYPE']").val();
            if(scstatus == 8){
                $("select[name='TYPE'] option[value=1]").css("display","none");
                $("select[name='TYPE'] option[value=3]").css("display","none");
            }else{
                $("select[name='TYPE'] option[value=1]").css("display","block");
                $("select[name='TYPE'] option[value=3]").css("display","block");
            }
            

        });

        function submitFlow() {
            var standard_id = $('.itemlist').filter('.selected').attr('fid');
            var case_id = $("input[name = '" + standard_id + "_CASE_ID']").val();
            var status = $("select[name ='" + standard_id + "_STATUS']").val();
            var scale_type = $("select[name ='" + standard_id + "_SCALETYPE']").val();
            if (status > 1) {
                layer.alert("该标准已提交申请，不能重复提交！", {icon: 0});
                return false;
            }

            $.ajax({
                url: "{:U('Feescale_change/is_allow_sub_to_flow',$paramUrl)}",
                type: "post",
                data: {"standard_id": standard_id, "scale_type": scale_type},
                dataType: "JSON",
                success: function (data) {
                    if (data.state == 0) {
                        layer.alert(data.msg, {icon: 2});
                    } else if (data.state == 1) {
                        var flowtype = "biaozhuntiaozheng";
                        var current_url = $("#opinionFlow_url").val();
                        var url = current_url + "/RECORDID/" + standard_id + "/CASEID/" + case_id + "/FLOWTYPE/" + flowtype;

                        var appUrl = "__APP__";
                        var url = appUrl + '/Touch/Feescale_change/process&RECORDID=' + standard_id + '&CASEID=' + case_id + '&flowTypePinYin=' + flowtype;
                        window.location.href = url;
                    }
                }
            })
        }

        function showFlow() {
            var standard_id = $('.itemlist').filter('.selected').attr('fid');
            var current_url = $("#show_flow_step_url").val();

            if (!standard_id) {
                layer.alert("请选择要查看的记录", {icon: 0});
                return false;
            } else {
                $.ajax({
                    type: "post",
                    url: current_url,
                    data: {"standard_id": standard_id},
                    dataType: "JSON",
                    success: function (data) {
                        if (data.state == 0) {
                            layer.alert(data.msg, {icon: 2});
                        } else if (data.state == 1) {
                            var url = current_url + "/flowid/" + data.msg + "/standard_id/" + standard_id;
                            layer.open({
                                type: 2,
                                title: '流程详情',
                                shadeClose: true,
                                shade: 0.8,
                                area: ['90%', '90%'],
                                content: url //iframe的url
                            });
                        }
                    }
                })
            }
        }
    </script>
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab">
            {$tabs}
        </div>
        <div>{$form}
            <input type="hidden" id="prjid" value="{$prjid}">
            <input type="hidden" id="recordid" value="{$recordid}">
            <input type="hidden" name="current_url" id="opinionFlow_url"
                   value="{:U('Feescale_change/opinionFlow',$paramUrl)}">
            <input type="hidden" name="current_url" id="show_flow_step_url"
                   value="{:U('Feescale_change/show_flow_step',$paramUrl)}">
        </div>
        <textarea id="last_filter_text" style="display: none">{$lastFilter}</textarea>
    </div>
</div>
</body>
</html>
