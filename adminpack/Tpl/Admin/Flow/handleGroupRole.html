<!DOCTYPE html>
<html>
<head>
    <title>工作流分组</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./Public/select2/select2.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="./Public/select2/bootstrap.min.css" type="text/css" media="all"/>
    <link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./Public/select2/select2.js"></script>
    <script type="text/javascript" src="./Public/layer/layer.js"></script>
    <script src="./Public/js/ECS5.js"></script>
    <script src="//cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
    <style>
        .c-yel{color:red}
        .close_list{color:#aaa;margin-left:15px}
        .group_name_list{background-color:#e4e4e4;border:1px solid #aaa;border-radius:4px;margin-left: 10px}
    </style>

    <include file="./Tpl/Admin/Public/comm_css_js.html" />
</head>
<body>
<div class="right fright j-right  registerform">
    <div class="handle-tab">
        <ul>
            <li class="selected"><a href="{:U('Flow/groupFlow')}">工作流分组</a></li>
        </ul>
    </div>
    <div class="caseinfo-table">
        <table>
            <tbody>

            <tr >
                <td class="leftlable" align="center" style="width:10%" >分组名称<em class="c-yel">*</em></td>
                <td align="left">
                    <input type="text" class="form-control" name="GROUPNAME" value="{$list['GROUPNAME']}" placeholder="" style="height:30px;"/>
                </td>
            </tr>
            <tr>
                <td class="leftlable" align="center" style="width:10%">组内成员<em class="c-yel">*</em></td>
                <td align="left">
                   <div id="str_user_name">

                   </div>
                </td>
            </tr>
            <tr>
                <td class="leftlable" align="center" style="width:10%">添加成员</td>
                <td align="left">
                    <input type="text" class="form-control" id="ADD_GROUP_NAME" placeholder=""/>
                    <ul class="ul_group"></ul>
                </td>
            </tr>

            </tbody>
        </table>
    </div>
    <input type="hidden" value="{$roleId}" id="roleId"/>


    <div class="handle-btn">
        <input class="btn btn-primary" type="button" onclick="submitForm();" value="保 存">
        <input class="btn btn-default" onclick="window.history.back()" type="button" value="返 回">
    </div>
</div>
<script>
    $(function () {

        $(".js-example-placeholder-multiple").select2({
            placeholder: '请选择..'
        });

    });

    function submitForm() {
        var groupUserId = [];
        $(".group_name_list").each(function(){
            groupUserId.push($(this).attr('id'));
        });
        groupUserId = groupUserId.join(',');
        var groupName = $("input[name='GROUPNAME']").val();
        if(groupName == "" || groupUserId ==""){
            alert("亲，分组名称和组内成员不能为空");
            return;
        }
        var ID = $("#roleId").val();
        $.ajax({
            url: "{:U('Flow/handleGroupRole',array('save'=>1))}",
            dataType: 'json',
            type: 'POST',
            data: {
                'GROUPNAME':groupName,
                'GROUPUSERID': groupUserId,
                'ID': ID
            },
            success: function (obJect) {
                alert(obJect.msg);
                window.location.href = "{:U('Flow/groupFlow')}";
            }
        });
    }

    $("#ADD_GROUP_NAME").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "index.php?s=/Api/getDirectSaller",
                dataType: "JSON",
                data: {
                    "search": request.term,
                    "roleId": $("#roleId").val()
                },
                success: function (obJect) {
                    response($.map(obJect, function (item) {
                        return {
                            label: item.deptname ,
                            value: item.name,
                            USERID: item.id,
                            PHONE: item.phone,
                            CITY: item.city,
                        }
                    }));

                }
            });
        },
        minLength: 1,
        removeinput: 0,
        select: function (event, ui) {
            if(ui.item.USERID > 0){
                var user_name = ui.item.value;
                var user_id = ui.item.USERID;
                var str_user_name = "<span id='"+user_id+"' class='group_name_list'>" +
                        "<span  class='choose_list' >"+ user_name+"" +
                        "<a  class='close_list' href = 'javascript:void(0);' data_id='"+user_id+"'>X</a></span>" +
                        "</span>";
                $("#str_user_name").append(str_user_name);

                // 清空输入框的内容
                $(this).val('');
                return false;

                removeinput = 2;
            }else{
                removeinput = 1;
            }

        },
        close: function(event) {
            if(typeof(removeinput) == 'undefined' || removeinput == 1 )
            {
                $(this).val('');
            }
        }
    });

    $(document).on('click', '.close_list', function () {
        var user_code = $(this).attr('data_id');
        $("#" + user_code).remove();
    });
</script>
<script>
    $(function () {
        var roleId = "{$roleId}";
        if(roleId){
            $.ajax({
                url: "{:U('Flow/ajax_get_groupname',array('edit'=>1))}",
                dataType: 'json',
                type: 'POST',
                data: {
                    'ID': roleId
                },
                success: function (data) {

                    if (data[0]['ID'] == 0) {
                        alert("权限不足");
                    }
                    else if (data[0]['ID'] >= 1) {
                        var output = [];
                        $.each(data, function(key, value)
                        {
                            output.push("<span id='"+value['ID']+"' class='group_name_list'>" +
                                    "<span  class='choose_list' >"+ value['NAME']+"" +
                                    "<a href='javascript:void(0);'>&nbsp;&nbsp;&nbsp;</a>" +
                                    "<a  class='close_list' href = 'javascript:void(0);' data_id='"+value['ID']+"'>X</a></span>" +
                                    "</span>");
                        })
                        $("#str_user_name").append(output);
                    }
                }
            });
        }
    })
</script>


</body>
</html>