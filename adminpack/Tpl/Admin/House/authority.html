<!DOCTYPE html>
<html>
    <head>
        <title>项目权限</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="./Public/ztree/css/demo.css" type="text/css" rel="stylesheet"/>
        <link href="./Public/ztree/css/metroStyle/metroStyle.css" type="text/css" rel="stylesheet"/>
		<link href="./Public/css/jquery-ui.css" type="text/css" rel="stylesheet"/>
		<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="./Public/ztree/js/jquery.ztree.core-3.5.js"></script>
		<script type="text/javascript" src="./Public/ztree/js/jquery.ztree.excheck-3.5.js"></script>
		<script type="text/javascript" src="./Public/ztree/js/jquery.ztree.exedit-3.5.js"></script>
		<script type="text/javascript" src="./Public/js/jquery-ui.js"></script>
		<script type="text/javascript" src="./Public/layer/layer.js"></script>
		<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>

		<script>
			$(".highlight").css("background", "#349ac0");
		</script>

		<style>	
			li{
				font-size: 14px;
    			font-family: "雅黑";
    			font-weight: 600;
			}
			.project{
				height: 32px;
    			/*width: 640px;*/
    			width: 768px;
			    border: 1px solid #d9d9d9;
			}	
			.project li{
				list-style: none;
			    text-align: center;
			    height: 30px;
			    line-height: 30px;
			    cursor: pointer;
			    float: left;
			    width: 126px;
			    background: #ccc;
			    border: 1px solid #fff;
			    color: #fff;
			}
			.project .highlight{
				background:#349ac0;
				color:white;
			}
			#userList li{
				list-style: none;
			    text-align: center;
			    border-bottom: 1px solid #d9d9d9;
			    height: 30px;
			    line-height: 30px;
			    cursor: pointer;
			    color: #999;
			}
			#userList li:hover{
				color: #349bc1;
			}
			#userList li:focus{
				color: #349bc1;
			}
			#chooseList{
				padding: 4px;
			    width: 288px;
			    height: 360px;
			    float: left;
			    font-size: 12px;
			    overflow: auto;
			}
			#chooseList p{
				border: 1px dashed #349ac0;
			    color: #349ac0;
			    text-align: center;
			    margin-left: 24%;
			    /* margin-right: 44px; */
			    margin-top: 10px;
			    border-radius: 4px;
			    padding: 0px 6px;
			    width: 80px;
			}
			#chooseList input{
				float: right;
			}
			.hidden{
				display:none;
			}
			.display{
				display:block;
			}
			.middle{
				vertical-align:middle;
			}
			.ui-autocomplete {
				max-height: 300px;
				overflow-y: auto;
				/* 防止水平滚动条 */
				overflow-x: hidden;
			}
			.ui-autocomplete  li{
				font-size:12px;
				list-style:outside none circle;
				font-family: inherit;
				font-weight: inherit;
			}
			.search{
				background: url("../images/search.png");
				display: block;
				width: 20px;
				height: 20px;
				position: absolute;
    			left: 152px;
    			top: 22px;
			}
		</style>
		
</head>
<body>       
<div style="margin: 40px 80px;">
	<div style="font-size:16px;font-weight:bold;color:#349ac0;">
		项目权限( {$project.PROJECTNAME} )
	</div>
	<div style=" margin: 20px 0;">
		<input name="search" type="text" id="search" placeholder="搜索用户" style="height: 30px; width:200px; border-radius: 3px; border: 1px solid #d9d9d9; text-indent: 10px;">
	</div>
	<form method='post' action="{:U('House/projectAuth',array('add'=>1))}">
	<div class="content_wrap">
		<div style="width:770px;height:40px;">
			<ul class="project">
				<?php
				foreach($caseList as $key=>$val){
					echo "<li erpId='" . $key . "'>" . $val . "</li>";
				}
				?>
				<!--<li erpId='1'>电商</li>-->
				<!--<li erpId='2'>分销</li>-->
				<!--<li erpId='3'>硬广</li>-->
				<!--<li erpId='4'>活动</li>-->
				<!--<li erpId='5'>产品</li>-->
				<!--<li erpId='8'>非我方收筹</li>-->
				<!--<li style="border-bottom:none" erpId='6'>驻场</li>-->
			</ul>
		</div>
		<div class="zTreeDemoBackground left">
			<ul id="treeDemo" class="ztree"></ul>
			<ul id = 'userList' class="userList hidden"></ul>
		</div>
		<div class="left" style="width: 320px; height: 370px; border: 1px solid #d9d9d9; margin-top: 10px;">
			<div id="chooseList">
			</div>	
		</div>
		
		<input type='hidden' name='projId' value='{$projId}' id= 'projId'/>
		<input type='hidden' name='erpId' value='' id= 'erpId'/>
		<input type='hidden' name='uId' value='' id= 'uId'/>
		<input type='hidden' name='caseStr' value='{$caseStr}' id= 'caseStr'/> 
	</div>
	<div style="height: 30px; width: 80px; text-align: center; margin-top: 60px;">
			<input type='submit' name='submit' value='保存' style="height: 30px;width: 80px;background: #349bc1;color: #fff;border: none;border-radius: 4px;float: left;margin-left: 564px; font-weight: 600; font-size: 14px; cursor: pointer;"/>
	</div>
	</form>
</div>
<script>

	 var setting = {
			async: {
				enable: true,
				url:"{:U('Api/getAuth')}",
				autoParam:["id","pId","name"],
				dataFilter: filter
			},
            data: {
                simpleData: {
                    enable: true
                }
            },
			callback: {
				onClick:onClick
			}  
        };

		function filter(treeId, parentNode, childNodes) {
			if (!childNodes) return null;
			return childNodes;
		}
		function treeClick(id){
			$.ajax({
				url:"{:U('Api/getUsers')}",
				dataType:"json",
				data:{
					'id':id
				},
				success:function(obJect){
					var html = '';
					for (var i=0, l=obJect.length; i<l; i++) {
						html += "<li uid="+obJect[i].id+" onclick=ChooseUser("+obJect[i].id+",'"+obJect[i].name+"')>"+obJect[i].name+"</li>";
					}
					$("#userList").html(html).addClass('display');
				}
			});
		}
		
		function ChooseUser(uid,uname){
			$("#userList li[uid !="+uid+"]").removeClass('highlight');
			$("#userList li[uid ="+uid+"]").addClass('highlight');

			var useId = $("#uId").val();
			var useArr = $("#uId").val().split(',');
			
			if(useId){
				if($.inArray(String(uid),useArr) < 0){
					$("#uId").val(useId +','+uid);
					var html = "<p><input type='checkbox' name='uid[]' value='"+uid+"' class='middle' checked='true' onclick=editOption(this) /><label class='middle'>"+uname+"</label></p> ";

					$("#chooseList").append(html);
				}else{
					layer.alert('该人员已经存在!', {icon: 2});
				}
			}else{
				$("#uId").val(uid);
				var html = "<p><input type='checkbox' name='uid[]' value='"+uid+"' class='middle' checked='true' onclick=editOption(this) /><label class='middle'>"+uname+"</label></p> ";

				$("#chooseList").append(html);
			}
		}

		function editOption(obj){
			
			if(!obj.checked){
				
				var uid = $("#uId").val().split(',');
				uid.splice($.inArray(obj.value,uid),1);

				$("#uId").val(uid);

				$("#chooseList :checkbox[value="+obj.value+"]").parent().remove();

			}
		}

		function onClick(event, treeId, treeNode) {
			var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
			nodes = zTree.getSelectedNodes();
			
			if(!nodes.isParent){
				if($("#erpId").val()){
					treeClick(nodes[0].id);
				}else{
					layer.alert('请先选择类型!', {icon: 2});
				}	
			}
		}

		//根据已选业务获取已有人员
		function getUserByType(erpId) {
			$.ajax({
				url:"{:U('Api/getUserByType')}",
				dataType:"json",
				data:{
					'erpId':erpId,
					'prjId':$("#projId").val()
				},
				success:function(obJect){
					var html = '';
					var uid = '';
					for (var i=0, l=obJect.length; i<l; i++) {
						html += "<p><input type='checkbox' name='uid[]' value ='"+obJect[i].use_id+"' class='middle' checked='true' onclick=editOption(this) /><label class='middle'>"+obJect[i].name+"</label></p>";

						uid += obJect[i].use_id + ',';
					}

					if(uid) uid= uid.substring(0, uid.length-1);

					$("#uId").val(uid);
					$("#chooseList").html(html);
				}
			});
		}

        $(document).ready(function(){
            $.fn.zTree.init($("#treeDemo"), setting);
			
			$(".project li").bind('click',function(){
				
				var caseStr = $("#caseStr").val();
				var erpId = $(this).attr('erpId');
				
				if(caseStr.indexOf(erpId) >= 0){
					$(this).addClass('highlight');
					$(this).siblings().removeClass('highlight');
					
					getUserByType(erpId);
					$("#erpId").val(erpId);
				}else{
					layer.alert('该业务类型不能选择!', {icon: 2});
				}
				
			});

			//初始默认值
			$(".project li").eq(0).click();

			$("#search").autocomplete({
			  source:"{:U('Api/getSearchUser')}",
			  select:function(event,ui){
				if($("#erpId").val()){
					var uid = ui.item.id;
					var uname = ui.item.value;
					var useId = $("#uId").val();
					var useArr = $("#uId").val().split(',');
					
					if(useId){
						if($.inArray(String(uid),useArr) < 0){
							$("#uId").val(useId +','+uid);
							var html = "<p><input type='checkbox' name='uid[]' value='"+uid+"' class='middle' checked='true' onclick=editOption(this) /><label class='middle'>"+uname+"</label></p> ";

							$("#chooseList").append(html);
						}else{
							
							layer.alert('该人员已经存在!', {icon: 2});
						}
					}else{
						$("#uId").val(uid);
						var html = "<p><input type='checkbox' name='uid[]' value='"+uid+"' class='middle' checked='true' onclick=editOption(this) /><label class='middle'>"+uname+"</label></p> ";

						$("#chooseList").append(html);
					}

				}else{
					layer.alert('请先选择业务类型！!', {icon: 2});
				}
			  }
		  });
        });
</script>
</body>
</html>