<!DOCTYPE html>
<html>
    <head>
        <title>会员退票列表</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
        <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
        <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
        <!--<script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>-->
        <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all" />-->
        <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all" />-->
        <include file="./Tpl/Admin/Public/comm_css_js.html" />
    </head>
    <body>
        <div class="containter">
            <div class="right fright j-right">
                <div class="handle-tab">
                    <ul>
                        <li class="selected"><a href="{:U('InvoiceRecycle/invoice_recycle_list',$paramUrl)}">退票申请</a></li>
                        <li><a href="{:U('InvoiceRecycle/invoice_recycle_progress_list',$paramUrl)}">退票进度</a></li>
                    </ul>
                </div>
                {$form}
            </div>
        </div>
        <script type="text/javascript">
        //加入审核单
        $("#add_to_invoice_recycle_audit_list").click(function()
        {
            var invoice_recycle_id = new Array();
            var i = 0;
            $("input[name= 'checkedtd']:checkbox").each(function() 
            {   
                if ($(this).prop("checked") == true) 
                {  
                   invoice_recycle_id[i] = $(this).val();  
                   i += 1;
                }
            }); 

            if( i == 0 )
            {   
                layer.alert('请至少选择一条记录!', {icon: 2});
                return false;
            }

            $.ajax({
                type: "POST",
                url: "{:U('InvoiceRecycle/add_to_audit_list')}",
                data:{'invoice_recycle_id':invoice_recycle_id},
                dataType:"JSON",
                success:function(data){
                    if(data.state == 0)
                    {
                        layer.alert(data.msg, {icon: 2, closeBtn: false}, 
                                    function(){window.location.reload();});
                    }
                    else if(data.state == 1)
                    {
                        layer.alert(data.msg, {icon: 1, closeBtn: false}, 
                                    function(){window.location.reload();});
                    }
                    else
                    {
                        var msg = data.msg ? data.msg : '操作异常';
                        layer.alert(msg, {icon: 2, closeBtn: false},
                                    function(){window.location.reload();});
                    }
                }
             })
        })
        
        //撤销退票申请
        $(".cancel_from_details").click(function()
        {   
            var invoice_recycle_details_id = $(this).parent().filter('.fedit').attr('fid');
            if(invoice_recycle_details_id > 0)
            {   
                layer.confirm('确定要撤销退票申请？', {
                    btn: ['确定', '取消'],
                    title: '是否撤销退票申请?',
                    closeBtn: false
                }, function(index, layero){
                    //确认操作
                    $.ajax({
                        type: "POST",
                        url: "{:U('InvoiceRecycle/delete_from_details')}",
                        data:{'invoice_recycle_details_id' : invoice_recycle_details_id},
                        dataType:"JSON",
                        success:function(data){
                            if(data.state == 0)
                            {   
                                layer.close(index);
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, 
                                            function(){window.location.reload();});
                            }
                            else if(data.state == 1)
                            {   
                                layer.close(index);
                                layer.alert(data.msg, {icon: 1, closeBtn: false}, 
                                            function(){window.location.reload();});
                            }
                            else
                            {   
                                layer.close(index);
                                var msg = data.msg ? data.msg : '操作异常';
                                layer.alert(msg, {icon: 2, closeBtn: false},
                                            function(){window.location.reload();});
                            }
                        }
                    })
                }, function(index){
                   layer.close(index);
                });
            }
            else
            {
                var msg = data.msg ? data.msg : '操作异常，删除失败';
                layer.alert(msg, {icon: 2, closeBtn: false},
                    function(){window.location.reload();});
            }
        })
        //导出退票
        $('#export_recycle').click(function() {
            var filter_sql = "<php>echo $filter_sql;</php>";
            var member_id = new Array();
            var i = 0;
            $("input[name='checkedtd']").each(function () {
                if ($(this).prop("checked") == true) {
                    member_id[i] = $(this).val();
                    i += 1;
                }
            });
            window.location.href = "index.php?s=/InvoiceRecycle/export_recycle/member_id/" + member_id +"&Filter_Sql=" + filter_sql;;
                                   // "index.php?s=/Financial/exportInvoice/member_id/" + member_id + "&Filter_Sql=" + filter_sql;
        });
        //查看审核单
        $("#view_invoice_recycle_audit_list").click(function()
        {   
            var url = "{:U('InvoiceRecycle/invoice_recycle_audit_list')}";
            //alert(url);
            layer.open({
                type : 2,
                title : '退票申请审核单',
                content : "{:U('InvoiceRecycle/invoice_recycle_audit_list')}",
                //alert
                area : ['95%', '80%'],
                cancel: function(index){ window.location.reload(); } 
                //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
            });
        })
        </script>
        <include file="./Tpl/Admin/Public/filter.html" />
    </body>
</html>