<!DOCTYPE html>
<html>
    <head>
        <title>我的借款列表</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <include file="./Tpl/Admin/Public/comm_css_js.html" />
        <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
        <!--<link href="./Public/css/jquery-ui.css" type="text/css" rel="stylesheet"/>-->
        <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
        <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
        <!--<script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>-->
        <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all" />-->
        <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all" />-->
        <style>
            .ui-autocomplete {
                max-height: 200px;
                overflow-y: auto;
                /* 防止水平滚动条 */
                overflow-x: hidden;
            }
        </style>
    </head>
<body>  
<div class="containter">   
    <div class="right fright j-right">
        {$form}
        <input type = 'hidden' name = 'reim_list_id' id = 'reim_list_id'  value = {$reim_list_id}>
      </div>   
</div>
 <script type="text/javascript">
 //检测关联金额的值
 $(".associated_amount").on("blur",function(){
    var unRepayment = $(this).parent().parent().find("input[name$='_UNREPAYMENT']").val();
    var relateMoney = $(this).val();

     if(parseFloat(relateMoney) > parseFloat(unRepayment)){
        alert('对不起，您填写的金额不能大于未还款金额！');
        $(this).val('');
     }
 });

 //关联借款
 $("#reim_relate_loan").click(function()
 {
     var reimMoney = '{$reimMoney}';
    var loanId = new Array();
    var loanMoney = new Array();
    var i = 0;
    $("input[name= 'checkedtd']:checkbox").each(function() 
    {   
        if ($(this).prop("checked") == true)
        {
            loanId[i] = $(this).val();
            loanMoney[i] = $(this).parent().parent().find(".associated_amount").val();
            i += 1;
        }
    });

    if( i > 0 )
    {
        //检测关联金额数值
        var moneyTotal = 0;
        for(var i=0;i<loanMoney.length;i++){
            if(isNaN(parseFloat(loanMoney[i]))){
                alert("对不起，要关联的对象，关联金额不能为空！");
                return false;
            }
            moneyTotal += parseFloat(loanMoney[i]);
        }

        //关联借款的总金额不能大于报销总金额
        if(moneyTotal > reimMoney){
            alert("对不起，您关联借款的总金额不能大于报销总金额！");
            return false;
        }

       var reim_list_id = $('#reim_list_id').val();

       if( reim_list_id > 0)
       {
           layer.confirm('确定使用选中的借款关联报销？', {
            btn: ['确定', '取消'],
            title: '是否关联报销?',
            closeBtn: false
           }, function(index, layero){
            //确认操作
            $.ajax({
                type: "GET",
                url: "{:U('Loan/ajax_relate_loan')}",
                data:{'loanId' : loanId,'loanMoney':loanMoney, 'reim_list_id' : reim_list_id},
                dataType:"JSON",
                success:function(data){
                    if(data.status)
                    {   
                       layer.close(index);
                       layer.alert(data.msg, {icon: 1, closeBtn: false},
                                   function(){window.location.reload();});
                    }
                    else
                    {   
                       layer.close(index);
                       layer.alert(data.msg, {icon: 2, closeBtn: false},
                                   function(){window.location.reload();});
                    }
                }
            })
        }, function(index){
           layer.close(index);
        });
       }
       else
       {
           layer.alert('请至少选择一条要关联的报销单!', {icon: 2});
           return false;
       }
    }
    else
    {
        layer.alert('请至少选择一条借款记录!', {icon: 2});
        return false;
    }
 })
  </script>
</body>
</html>