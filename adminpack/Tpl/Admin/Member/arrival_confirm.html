<!DOCTYPE html>
<html>
    <head>
        <title>到场确认</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <include file="./Tpl/Admin/Public/comm_css_js.html" />
        <!--<link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">-->
        <!--<link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>-->
        <!--<script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/js/common.js"></script>-->
        <!--<script type="text/javascript" src="./Public/js/common.js"></script>-->
        <!--<script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>		-->
        <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>-->
        <!--<script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>-->
        <!--<script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>-->
        <!--<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>-->
        <!--<link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all" />-->
        <!--<link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all" />-->
    </head>
    <body>
        <div class="containter">
            <div class="right fright j-right">
                <div class="handle-tab">{$tabs}</div>
                <div id = "main">
		<form action = "{:U('Member/arrivalConfirm')}" method = "post" name="confirm_form" id="confirm_form">
			<div class="kctjbot">
                <input type="hidden" name="action_type" value="arrive_confirm">
                <input type="hidden" name="authcode_key" value="<?=$form_sub_auth_key?>">
                <input type ="hidden" id = "project_listid" name = "project_listid" value="">
                <input type ="hidden" id = "user_project_id" name = "user_project_id" value="">
                <input type ="hidden" id = "is_from" name = "is_from" value="">
                <input type ="hidden" id = "customer_id" name = "customer_id" value="">
                <input type ="hidden" id = "ag_id" name = "ag_id" value="">
                <input type ="hidden" id = "cp_id" name = "cp_id" value="">
			</div>
            <div id="form">
                <style>.caseinfo-table table td:nth-of-type(2n+1){width:10%}</style>
                <div class="caseinfo-table">
                    <table style="table-layout:fixed;width:100%">
                    <tbody>
                    <tr>
                        <td align="left" class="leftlable">项目名称<font style="color:#f00;font-size:18px; ">*</font></td>
                        <td align="left">
                            <select name="project_id"  id="project_id" class="form-control">
                            <option value="">--请选择--</option>
                            <?php foreach ($projects as $_pro){ ?>
                            <option <?php if($selected_project_id == $_pro['ID'] ) {?>selected<?php } ?> value="<?php echo $_pro['ID']; ?>" data_pro_listid ="<?php echo $_pro['PRO_LISTID']; ?>" ><?php echo $_pro['PROJECTNAME']; ?></option>
                            <?php } ?>
                            </select>
                        </td>
                        <td align="left" class="leftlable">验证码<font style="color:#f00;font-size:18px; ">*</font></td>
                        <td align="left"><input datatype="n" type="text" name="code" id="code" value="" onblur="get_userinfo_by_code()" class="form-control pull-left"  placeholder="输入验证码"  size="15" maxlength="15"><input type="button"  class="noCodeBtn btn btn-info" value="没有校验码" style="margin-left: 5px; height: 30px;"></td>
                    </tr>
                    <tr>
                        <td align="left" class="leftlable">客户姓名<font style="color:#f00;font-size:18px; ">*</font></td>
                        <td align="left"><input datatype="s" type="text" name="truename" id="truename" value="" size="15" maxlength="15" class="form-control"></td>
                        <td align="left" class="leftlable">电话<font style="color:#f00;font-size:18px; ">*</font></td>
                        <td align="left"><input datatype="m" type="text" name="telno" id="telno" value="" size="11" maxlength="11" class="form-control"></td>
                    </tr>
                    </tbody>
                </table>
                </div>
                <div class="handle-btn">
                    <input type="button" value="确  认" class="comfirmbtn btn btn-primary default-btn-padding">
                    <input type="button" value="返  回" class="j-formclose btn btn-default default-btn-padding">
                </div>
                <script>  appUrl = "/tpp/adminpack/index.php?s="; actionUrl = "/tpp/adminpack/index.php?s=/Member/arrivalConfirm";</script>
            </div>

		</form>
                </div>
            </div>
        </div>
    </body>

    <script>
        /* ajax确认数据提交 */
        $(".comfirmbtn").on("click",function(){
            /**基础信息数据验证**/
            var project_id = $("#project_id").val();
            var truename = $("#truename").val();
            var telno = $("#telno").val();

            if(!project_id || !truename || !telno){
                alert("请保证所有的信息都已填写！");
                return false;
            }

            //电话正则
            var mobileReg = /^(13[0-9]{1}|145|147|15[0-9]{1}|18[0-9]{1}|17[0-9]{1})[0-9]{8}$/;
            if(telno == '' || !mobileReg.test(telno)){
                alert('请填入正确的手机号！');
                return false;
            }

            //提交操作
            $.ajax({
                type: "POST",
                url: "{:U('Member/arrivalConfirm')}",
                data:$('#confirm_form').serialize(),
                async: false,
                dataType:"JSON",
                success:function(data)
                {
                    alert(data.msg);
                    if(data.status)
                    {
                        location.href="{:U('Member/arrivalConfirm')}";
                    }
                },
                error: function(request) {
                    alert("网络错误,请重试~~");
                },
            });
        });

        function noCodeShow(){
            var   content = '<div id="noCode" class="form-horizontal"><br/>';
                    content += '<div class="form-group form-group-no-left-right-margin">';
                    content += '<label  class="col-md-4 control-label">';
                    content += '客户手机号：';
                    content += '</label>';
                    content += '<div class="col-md-6">';
                    content += '<input id="customer_telno" type="text" class="form-control"/>';
                    content += '</div>';
                    content += '</div>';

                    content += '<div class="form-group form-group-no-left-right-margin">';
                    content += '<label class="col-md-4 control-label">';
                    content += '经纪人手机号码：';
                    content += '</label>';

                    content += '<div class="col-md-6">';
                    content += '<input id="agent_telno" type="text" class="form-control"/>';
                    content += '</div>';
                    content += '</div>';
                    content += '<div class="form-group form-group-no-left-right-margin">';
                    content += '<div class="col-md-offset-4 col-md-6">';
                    content += '<input type="button" class="btn btn-primary" id="confirm" onclick="get_userinfo_by_telno()" value="确  认">';
                    content += '</div>';
                    content += '</div>';
                    content += '</div>';

            //页面层
            layer.open({
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                area: ['480px', '240px'], //宽高
                title:'获取验证码',
                content:content
            });
        }
    </script>

    <script type="text/javascript">
        $(function(){
            //点击无验证码按钮
            $(".noCodeBtn").click(function(){
                //项目ID
                var project_id = $("#project_id").val();
                if(project_id > 0)
                {
                    noCodeShow();
                }
                else
                {
                    alert('项目名称必须选择!');
                    return false;
                }
            });

            //页面更改项目时根据项目来填充用户来源和单套收费标准
            $("#project_id").change(function(){
                var project_id = $("#project_id").val();
                if(project_id > 0)
                {
                    //设置楼盘名称
                    set_pro_name()
                    //获取新房楼盘ID
                    set_pro_list_id(project_id);
                }
            });
        });

        function set_pro_name(){
            //赋值项目名称
            $("#project_name").remove();

            var prj_name = $("#project_id").find("option:selected").text();
            var prj_name_input = "<input type='hidden' name='project_name' id='project_name' value="+ prj_name +">";
            $('#project_id').after(prj_name_input);
        }

        //获取新房楼盘编号
        function set_pro_list_id(prj_id)
        {
            if( prj_id > 0 )
            {
                var scale_type = '';
                $.ajax({
                    type: "GET",
                    url: "{:U('Project/ajax_get_houseinfo_by_pid')}",
                    data:{'project_id':prj_id},
                    dataType:"JSON",
                    success:function(data)
                    {
                        if(data == null || data['ID'] == 0)
                        {
                            alert('项目未绑定新房楼盘信息，无法进行到场确认！');
                            cancle_pro_list_id();
                        }
                        else if(data['ID'] >= 1)
                        {
                            var list_id = data['PRO_LISTID'];
                            if(list_id > 0)
                            {
                                $('#project_listid').val(list_id);
                            }
                            else
                            {
                                alert('项目未绑定新房楼盘信息，无法进行到场确认！');
                                cancle_pro_list_id();
                            }
                        }
                        else
                        {
                            var msg = data.msg ? data.msg : '操作异常';
                            alert(msg);
                            cancle_pro_list_id();
                        }
                    }
                })
            }
            else
            {
                cancle_pro_list_id();
                alert('项目信息异常!');
                return false;
            }
        }

        //取消新房楼盘编号字段
        function cancle_pro_list_id()
        {
            $('#project_listid').val('');
        }

        /*根据用户CODE获取用户信息*/
        function get_userinfo_by_code()
        {
            //提交方式
            var action_type = 'ajax_userinfo_by_code';
            //短信验证码
            var code = $('#code').val();
            //楼盘ID
            var project_listid = $("#project_listid").val();

            if($.trim(code) == '')
                return false;

            $.ajax({
                url: "{:U('Member/arrivalConfirm')}",
                type: "POST",
                dataType: "JSON",
                data: {'action_type':action_type,'code':code,'project_listid':project_listid},
                success: function(data)
                {
                    if(data.result == 1)
                    {

                        if(data.truename == '' || data.truename == null){
                            alert('没有查到符合条件的用户信息1');
                            return false;
                        }

                        $('#truename').val(data.truename);
                        $('#telno').val(data.telno);
                        $('#customer_id').val(data.customer_id);
                        $('#is_from').val(data.is_from);
                        $('#user_project_id').val(data.projectid);

                        if(data.is_from == 2)
                        {
                            $('#ag_id').val(data.ag_id);
                            $('#cp_id').val(data.cp_id);
                        }
                    }
                    else if (data.result == 0)
                    {
                        //没有查询到符合条件的数据
                        alert('没有查到符合条件的用户信息');
                    }
                    else
                    {
                        //异常错误
                        alert('异常错误');
                    }
                }
            });
        }


        /*根据手机号码获取用户信息*/
        function get_userinfo_by_telno()
        {
            //提交方式
            var action_type = 'ajax_userinfo_by_telno';
            //客户手机号
            var customer_telno = $("#customer_telno").val();
            //经纪人手机号
            var agent_telno = $("#agent_telno").val();
            //项目ID
            var project_id = $("#project_id").val();
            //新房楼盘ID
            var project_listid = $("#project_listid").val();

            var mobileReg = /^[0-9]{11}$/;

            console.log(customer_telno);
            console.log(project_id);
            console.log(agent_telno);
            if(customer_telno == '' ||  !mobileReg.test(customer_telno))
            {
                alert('请输入正确的客户手机号码');
                return false;
            }

            if(project_id > 0)
            {
                $.ajax({
                    url: "{:U('Member/arrivalConfirm')}",
                    type: "POST",
                    dataType: "JSON",
                    data: {'action_type':action_type,'customer_telno':customer_telno,
                        'agent_telno':agent_telno,'project_id':project_id,'project_listid':project_listid},
                    success: function(data)
                    {
                        if(data.result == 1)
                        {
                            if(data.code == null || data.code == '')
                            {
                                alert('没有查到用户验证码信息......');
                                return false;
                            }

                            if(data.truename == '' || data.truename == null){
                                alert('没有查到符合条件的用户信息');
                                return false;
                            }

                            $('#truename').val(data.truename);
                            $('#customer_telno').val(customer_telno);
                            $('#code').val(data.code);
                            $('#ag_id').val(data.ag_id);
                            $('#cp_id').val(data.cp_id);
                            $('#customer_id').val(data.cm_id);
                            $('#is_from').val(data.is_from);
                            $('#telno').val(customer_telno);
                            if(data.is_from == 1)
                            {
                                $('#user_project_id').val(project_id);
                            }
                            else if(data.is_from == 2)
                            {
                                $('#user_project_id').val(project_listid);
                            }
                        }
                        else if (data.result == 0)
                        {
                            //没有查询到符合条件的数据
                            alert('没有查到符合条件的用户信息...');
                        }
                        else
                        {
                            //异常错误
                            alert('异常错误');
                        }
                    }
                });
            }
            else
            {
                alert('项目名称必须选择');
                return false;
            }
        }

    </script>

</html>
