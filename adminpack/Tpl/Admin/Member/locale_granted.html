<!DOCTYPE html>
<html>
    <head>
        <title>发放记录</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
        <link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>
        <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>
        <script type="text/javascript" src="./Public/validform/js/common.js"></script>
        <script type="text/javascript" src="./Public/js/common.js"></script>
        <script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>		
        <script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>
        <script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>
        <script type="text/javascript" src="Public/js/jquery.nicescroll.min.js"></script>
        <!--解决两个版本autocomplete冲突-->
        <if condition="$showForm gt 0">
            <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.core.js"></script>
            <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.widget.js"></script>
            <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.position.js"></script>
            <script type="text/javascript" src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.autocomplete.js"></script>
            <link rel="stylesheet" href="./Public/third/jquery_ui_autocomplete/themes/base/jquery.ui.all.css">
        </if>
        <script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>
        <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all" />
        <link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all" />
    </head>
    <body>
        <div class="containter">
            <div class="right fright j-right">
                <div class="handle-tab">{$tabs}</div>
                {$form}
            </div>
        </div>
        <script type="text/javascript">
            $(function(){
//                $('html').niceScroll();  // 滚动条样式修改
                $.widget("custom.autocomplete", $.ui.autocomplete, {
                    _renderItem: function( ul, item ) {
                        if(item.id > 0){
                            return $( "<li>" )
                            .data( "item.autocomplete", item )  
                            .append('<a class="ui-corner-all" tabindex="-1"><span class="ui_name">'+item.label
                            +'</span>&nbsp;&nbsp;<span class="ui_district">['+item.id+']</span></a>')
                            .appendTo( ul );
                        }else{
                            return $( "<li>" )
                            .data( "item.autocomplete", item )  
                            .append('<a class="ui-corner-all" tabindex="-1">'+item.label+'</a>')
                            .appendTo( ul );
                        }
                    }
                });

                $(".PRJ_NAME").autocomplete({
                    source: function( request, response ) 
                    {   
                        var cmt_name = request.term;
                        $.ajax({
                            url: "{:U('Project/ajax_get_project_list')}",
                            type: "GET",
                            dataType: "JSON",
                            data: {keyword: cmt_name},
                            success: function(data) 
                            {
                                //判断返回数据是否为空，不为空返回数据。
                                if(data[0]['id'] > 0)
                                {
                                    response(data);
                                }
                                else
                                {
                                    response(data);
                                }	                        
                            }
                        });
                    },
                    minLength: 1,
                    removeinput: 0,
                    select: function(event , ui) 
                    {   
                        if(ui.item.id > 0)
                        {
                            var project_name = ui.item.label;
                            var project_id = ui.item.id;
                            var city_id = ui.item.city_id;
                            $('#PRJ_ID').remove();
                            $('#CITY_ID').remove();
                            var str_input_prj_id = "<input type='hidden' name='PRJ_ID' id='PRJ_ID' value="+ project_id +">";
                            var str_input_city_id = "<input type='hidden' name='CITY_ID' id='CITY_ID' value="+ city_id +">";
                            $(this).after(str_input_prj_id);
                            $(this).after(str_input_city_id);
                            removeinput = 2;
                        }
                        else
                        { 
                           removeinput = 1;
                        }
                    },
                    close: function(event) {
                        if(typeof(removeinput) == 'undefined' || removeinput == 1)
                        {
                            $(this).val('');
                            $('#PRJ_ID').remove();
                            $('#CITY_ID').remove();
                        }
                    }
                });
                
                
                //报销申请
                $("#locale_granted_reim").click(function()
                {
                    var fx_id = new Array();
                    var i = 0;
                    $("input[name='checkedtd']:checkbox").each(function() 
                    {   
                        if ($(this).prop("checked") == true) 
                        {  
                           fx_id[i] = $(this).val();  
                           i += 1;
                        }
                    }); 
                    
                    if( i == 0 )
                    {   
                        layer.alert('请至少选择一条记录!', {icon: 2});
                        return false;
                    }
                    
                    $.ajax({
                        type: "GET",
                        url: "{:U('Reimbursement/apply_locale_granted_reim')}",
                        data:{'fx_id':fx_id},
                        dataType:"JSON",
                        success:function(data){
                            if(data.state == 0)
                            {
                                layer.alert(data.msg, {icon: 2, closeBtn: false}, 
                                    function(){window.location.reload();});
                            }
                            else if(data.state == 1)
                            {
                                layer.alert(data.msg, {icon: 1, closeBtn: false}, 
                                    function(){window.location.reload();});
                            }
                            else
                            {
                                var msg = data.msg ? data.msg : '操作异常';
                                layer.alert(msg, {icon: 2, closeBtn: false},
                                  function(){window.location.reload();});
                            }
                        }
                     })   
                });
            });
        </script>
        <include file="./Tpl/Admin/Public/filter.html" />
    </body>
</html>