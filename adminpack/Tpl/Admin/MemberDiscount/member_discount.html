<!DOCTYPE html>
<html>
    <head>
        <title>减免明细</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
        <link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>
        <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>
        <script type="text/javascript" src="./Public/validform/js/common.js"></script>
        <script type="text/javascript" src="./Public/js/common.js"></script>
        <script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>		
        <script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>
        <script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>
        <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.core.js"></script>
        <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.widget.js"></script>
        <script src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.position.js"></script>
        <script type="text/javascript" src="./Public/third/jquery_ui_autocomplete/ui/jquery.ui.autocomplete.js"></script>
        <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <script language="javascript" type="text/javascript" src="./Public/layer/layer.js"></script>
        <link rel="stylesheet" href="./Public/third/jquery_ui_autocomplete/themes/base/jquery.ui.all.css">
        <link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all" />
        <link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all" />
        <script>
            $(function(){
                var is_flow = $("#is_flow").val();
                /*if(is_flow == 0){
                    $(".itemlist").each(function(){
                        var fid = $(this).attr("fid");
                        //var reduce_money = $("input[name = '"+fid+"_REDUCE_MONEY']").val();
                        //if(reduce_money == 0)
                        //{
                            //$("input[name = '"+fid+"_REDUCE_MONEY']").parent().css("display","block");
                            //$("input[name = '"+fid+"_REDUCE_MONEY']").parent().siblings().css("display","none");
                        //}    
                        
                    })
                }*/
                $("input[name='checkedtd']").each(function(){
                    $(this).change(function(){
                        var fid = $(this).val();
                        if($(this).prop("checked") == true)
                        {                            
                            $("input[name = '"+fid+"_REDUCE_MONEY']").parent().css("display","block");
                            $("input[name = '"+fid+"_REDUCE_MONEY']").parent().siblings().css("display","none");
                        }
                        else
                        {
                            $("input[name = '"+fid+"_REDUCE_MONEY']").parent().css("display","none");
                            $("input[name = '"+fid+"_REDUCE_MONEY']").parent().siblings().css("display","block");
                        }
                    })
                    
                })
            $(".REDUCE_MONEY").change(function(){
                var reduce_money = $(this).val();
                var fid = $(this).parents("tr").attr("fid");
                var status = $("select[name='"+fid+"_STATUS']").val();
                var total_price = $("input[name='"+fid+"_TOTAL_PRICE']").val();
                if( parseFloat(reduce_money) > parseFloat(total_price) )
                {
                    layer.alert("减免金额不能大于单套收费标准，请重新填写减免金额",{icon:0});
                    return false;
                }
                if(status > 1)
                {
                    layer.alert("该记录已经提交或已被终止，不能修改减免金额",{icon:0});
                    return false;
                }

                var url = "{:U('MemberDiscount/update_discount_info',$paramUrl)}";
                $.post(
                     url, 
                     { 'reduce_money': reduce_money,'detail_id':fid},
                     function(data){
                         if(!data){
                             layer.alert("减免金额保存出错，请重新填写",{icon:2});
                         }
                         else if(data == 1)
                         {
                             layer.alert("金额保存成功！",{icon:1});
                         }
                     }
                 );
             });
                
            $("#sub_to_discount_list").click(function(){
                var discount_ids = new Array();
                var i = 0;
                $("input[name='checkedtd']").each(function(){
                    if($(this).prop("checked") == true){
                        discount_ids[i] = $(this).val();
                        i++;
                     }                       
                });
                if( discount_ids.length == 0){
                    layer.alert("请至少选择一条记录",{icon:0});
                    return false;
                }

                $.ajax({
                    type:"post",
                    url:"{:U('MemberDiscount/sub_to_discount_list',$paramUrl)}",
                    data:{"discount_ids":discount_ids},
                    dataType:"JSON",
                    success:function(data){
                        if(data.state == 0)
                        {
                            layer.alert(data.msg,{icon:2});
                        }
                        else if(data.state == 1)
                        {
                            layer.alert(data.msg,{icon:1});
                        }
                        else if(data.state == 2)
                        {
                            var url = "{:U('MemberDiscount/opinionFlow',$paramUrl)}",
                                url = url + "/RECORDID/"+data.recordid;

                            var appUrl = "__APP__";
                            var url = appUrl + '/Touch/MemberDiscount/process&RECORDID=' + data.recordid + '&flowTypePinYin=jianmianshenqing';

                            window.location.href = url;
                        }
                    }
                })
            })
               
            })
            function submitFlow(){
                var list_id = $("#list_id").val();                
                var url = $("#submitFlow").attr("href");
                if(list_id){
                    url = url+"/RECORDID/"+list_id;  
                }               
                $("#submitFlow").attr("href",url);
            }
        </script>
    </head>
    
    <body>
        
        <div class="containter">
            <div class="right fright j-right">
                <div class="handle-tab">
                    <ul>
                        <li class="selected"><a href="{:U('MemberDiscount/show_discount_detail',$paramUrl)}">会员减免</a></li>
                    </ul>
                </div>
                {$form}
                <input type="hidden" name="is_flow" value="{$is_flow}" id="is_flow">
                <input type="hidden" name="list_id" value="{$list_id}" id="list_id">
            </div>
        </div>
        <include file="./Tpl/Admin/Public/filter.html" />
    </body>
</html>