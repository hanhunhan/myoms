<!DOCTYPE html>
<html>
<head>
    <meta charset="GBK">
    <title>新增开票</title>
    <link href="Public/third/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="Public/uploadify/uploadify.css" rel="stylesheet">
    <style>
        body {
            padding: 20px 0;
        }
        .star {
            color: #f00;
            margin-right: 3px;
        }

        .btn {
            margin-right: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <form class="form-horizontal" role="form">
        <div class="form-group">
            <label for="INVOICE_MONEY" class="col-sm-2 control-label"><span class="star">*</span>金额</label>

            <div class="col-sm-9">
                <input type="text" class="form-control" id="INVOICE_MONEY">
            </div>
        </div>
        <div class="form-group">
            <label for="INVOICE_CLASS" class="col-sm-2 control-label"><span class="star">*</span>发票种类</label>

            <div class="col-sm-9">
                <select class="form-control" id="INVOICE_CLASS" name="INVOICE_CLASS">
                    <option value="1">普通发票</option>
                    <option value="2">专用发票</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="INVOICE_BIZ_TYPE" class="col-sm-2 control-label"><span class="star">*</span>发票类型</label>

            <div class="col-sm-9">
                <select class="form-control" id="INVOICE_BIZ_TYPE" name="INVOICE_BIZ_TYPE">
                    <option value="1">广告费</option>
                    <option value="2">服务费</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="FILES" class="col-sm-2 control-label">附件</label>

            <div class="col-sm-9">
                <input id="FILES" name="FILES" type="file" multiple="true" class="btn btn-default"/>
                <input name="filesvalue" class="form-control" tfield="FILES" type="hidden" value=""/>
            </div>
        </div>
        <div class="form-group">
            <label for="REMARK" class="col-sm-2 control-label">备注</label>

            <div class="col-sm-9">
                <textarea class="form-control" rows="3" name="REMARK" id="REMARK"></textarea>
            </div>
        </div>

        <br/>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-9">
                <button data-action="ok" type="button" class="btn btn-default btn-primary">确定</button>
                <button data-action="cancel" type="button" class="btn btn-default">取消</button>
            </div>
        </div>
        <input type="hidden" name="CASE_ID" value="{$case_id}" />
        <input type="hidden" name="CONTRACT_ID" value="{$contract_id}" />
        <input type="hidden" id="PRJ_ID" name="PRJ_ID" value="{$prj_id}" />
    </form>
</div>
<script src="Public/validform/js/jquery-1.9.1.min.js"></script>
<script src="Public/third/bootstrap/js/bootstrap.min.js"></script>
<script src="Public/uploadify/jquery.uploadify-3.1.min.js"></script>
<script language="javascript" type="text/javascript" src="Public/layer/layer.js"></script>
<script language="javascript" type="text/javascript" src="Public/layer/extend/layer.ext.js"></script>
<script>
    $(function () {
        function uploadify_uploadfilelist(filename, filesize, filecode, field) {
            var itemTemplate = '<div id="' + filecode + '" filename="' + filename + '" filesize="' + filesize + '"   name="filename_' + field + '" class="uploadify-queue-item">\
					<div class="cancel">\
						<a class="btn-remove-file" href="javascript:void(0);" data-filecode="' + filecode + '">&times;</a>\
					</div>\
					<span class="fileName"><a target="_blank" href="index.php?s=/Upload/showfile&filecode=' + filecode + '">' + filename + ' (' + filesize + ')</a></span><span class="data"></span>\
					<div class="uploadify-progress">\
						<div  > </div>\
					</div>\
				</div>';
            $("#" + field + "").parent().append(itemTemplate);
        }

        $(document).on('click', '.btn-remove-file', function () {
            var fileCode = $(this).attr('data-filecode');
            $("#" + fileCode).remove();
        });

        $('#FILES').uploadify({
            'uploader': 'index.php?s=/Upload/save2oracle/',
            'onUploadSuccess': function (file, data) {
                uploadify_uploadfilelist(file.name, file.size, data, 'FILES');
            },
            'formData': {
                'timestamp': '{:time()}',
                'token': "{:md5('nr234n9i92n2' . time())}"
            },
            'swf': 'Public/uploadify/uploadify.swf',
            'buttonText': '上传文件',
            'height': 'auto',
            'width': '120',
            'height': '35',
            'buttonCursor': 'hand'
        });

        $('.btn', 'form').click(function() {
            var action = $(this).attr('data-action');
            var index = parent.layer.getFrameIndex(window.name);
            if (action == 'ok') {
                var prjId = $('#PRJ_ID').val();
                if (!prjId) {
                    layer.msg('没有选定项目，不能新增开票', {icon: 2});
                    return;
                }
                var reqData = {};
                reqData['INVOICE_MONEY'] = $('#INVOICE_MONEY').val();  // 开票金额
                if (!reqData['INVOICE_MONEY']) {
                    layer.msg('开票金额不能为空', {icon: 2});
                    return;
                }

                if (!$.isNumeric(reqData['INVOICE_MONEY'])) {
                    layer.msg('开票金额为数字', {icon: 2});
                    return;
                }
                reqData['INVOICE_CLASS'] = $('#INVOICE_CLASS').val();  // 发票种类
                reqData['INVOICE_BIZ_TYPE'] = $('#INVOICE_BIZ_TYPE').val();  // 发票业务类型
                reqData['REMARK'] = $('#REMARK').val();  // 备注

                // 附件
                var attachmentData = [];
                var attachmentListElem = $('#FILES').parent().find('[name="filename_FILES"]');
                if (attachmentListElem) {
                    for (var i = 0; i < attachmentListElem.length; i++) {
                        var elem = attachmentListElem[i];
                        var fileAbstract = $(elem).attr('id') + '-' + $(elem).attr('filename') + '-' + $(elem).attr('filesize');
                        attachmentData.push(fileAbstract);
                    }
                }
                reqData['FILES'] = attachmentData.join(',');
                $.ajax({
                    url: '{:U("MemberDistribution/open_billing_record")}' + '/prjid/' + prjId + '/TAB_NUMBER/4/CASE_TYPE/fx/faction/saveFormData',
                    type: 'POST',
                    data: reqData,
                    success: function(resp, xhr) {
                        if ($.type(resp) === 'string') {
                            resp = JSON.parse(resp);
                        }
                        if (resp.status == 2) {
                            layer.msg(resp.msg, {icon: 1});
                            setTimeout(function() {
                                parent.layer.close(index);
                            }, 800);
                        } else {
                            layer.msg(resp.msg, {icon: 2});
                        }
                    },
                    error: function() {

                    }
                });
            } else {
                parent.layer.close(index);
            }
        });
    });
</script>
</body>
</html>