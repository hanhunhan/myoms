<!DOCTYPE html>
<html>
<head>
    <meta charset="GBK">
    <title>佣金管理</title>
    <include file="./Tpl/Admin/Public/comm_css_js.html"/>
    <style>
        .summary {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 8px;
        }

        .summary li {
            display: inline-block;
            width: 32%;
            /*border: 1px solid #f00;*/
            padding: 4px;
        }

        .summary li > select {
            min-width: 80px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            outline: none;
        }

        .star-mark {
            font-style: normal;
            color: #f00;
        }

        .summary label {
            font-weight: normal;
        }

        .summary textarea {
            float: left;
            padding: 4px 8px;
            line-height: 1.3;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }

        input.settle-percent, input.settle-amount {
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 5px;
            outline: none;
        }
    </style>
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab">{$tabs}</div>
        {$html}
    </div>

</div>
<script id="commission_invoice_tpl" type="text/html">
    <div class="commission_reim_box">
        <div class="contractinfo-table">
            <table>
                <thead>
                <tr>
                    <th>项目名称</th>
                    <th>会员姓名</th>
                    <th>房屋总价</th>
                    <th>后佣收费标准</th>
                    <th>剩余结算比例</th>
                    <th>剩余结算金额</th>
                    <th>本次结算比例</th>
                    <th>本次结算金额</th>
                    <th>本次结算后状态</th>
                </tr>
                </thead>
                <tbody>
                {{each list}}
                <tr>
                    <td>{{$value.PRJ_NAME}}</td>
                    <td>{{$value.REALNAME}}</td>
                    <td>{{$value.HOUSETOTAL}}</td>
                    <td>{{$value.TOTAL_PRICE_AFTER}}</td>
                    <td><span id="{{$value.ID}}_remain_percent">{{$value.REMAIN_PERCENT}}</span>%</td>
                    <td><span id="{{$value.ID}}_remain_amount">{{$value.REMAIN_AMOUNT}}</span>元</td>
                    <td><input data-max-percent="{{$value.REMAIN_PERCENT}}" data-max-amount="{{$value.REMAIN_AMOUNT}}"
                               type="text" value="{{$value.PERCENT}}" data-index="{{$index}}" class="settle-percent"
                               id="{{$value.ID}}_percent" data-id="{{$value.ID}}"/>%
                    </td>
                    <td><input data-max-percent="{{$value.REMAIN_PERCENT}}" data-max-amount="{{$value.REMAIN_AMOUNT}}"
                               type="text" value="{{$value.AMOUNT}}" data-index="{{$index}}" class="settle-amount"
                               id="{{$value.ID}}_amount" data-id="{{$value.ID}}"/>元
                    </td>
                    <td><span id="{{$value.ID}}_status">完全结算</span></td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
        <div class="summary">
            <ul>
                <li><label>总金额</label>：<span id="total_amount">{{total}}</span>元</li>
                <li><label>发票种类<i class="star-mark">*</i></label>：<select id="invoice_class">
                    <option value="1">普通发票</option>
                    <option value="2">专用发票</option>
                </select></li>
                <li><label>发票类型<i class="star-mark">*</i></label>：<select id="invoice_biz_type">
                    <option value="1">广告费</option>
                    <option value="2" selected="selected">服务费</option>
                </select></li>
                <li><label>申请说明<i class="star-mark"></i></label>：<textarea rows="5" cols="110"
                                                                            id="invoice_desc"></textarea>
            </ul>
        </div>
    </div>
</script>

<script id="commission_reim_tpl" type="text/html">
    <div class="commission_reim_box">
        <div class="contractinfo-table">
            <table>
                <thead>
                <tr>
                    <th>项目名称</th>
                    <th>会员姓名</th>
                    <th>房屋总价</th>
                    <th>后佣中介佣金标准</th>
                    <th>剩余结算比例</th>
                    <th>剩余结算金额</th>
                    <th>本次结算比例</th>
                    <th>本次结算金额</th>
                    <th>本次结算后状态</th>
                </tr>
                </thead>
                <tbody>
                {{each list}}
                <tr>
                    <td>{{$value.PRJ_NAME}}</td>
                    <td>{{$value.REALNAME}}</td>
                    <td>{{$value.HOUSETOTAL}}</td>
                    <td>{{$value.AGENCY_REWARD_AFTER}}</td>
                    <td><span id="{{$value.ID}}_remain_percent">{{$value.REMAIN_PERCENT}}</span>%</td>
                    <td><span id="{{$value.ID}}_remain_amount">{{$value.REMAIN_AMOUNT}}</span>元</td>
                    <td><input data-max-percent="{{$value.REMAIN_PERCENT}}" data-max-amount="{{$value.REMAIN_AMOUNT}}"
                               type="text" value="{{$value.PERCENT}}" data-index="{{$index}}" class="settle-percent"
                               id="{{$value.ID}}_percent" data-id="{{$value.ID}}"/>%
                    </td>
                    <td><input data-max-percent="{{$value.REMAIN_PERCENT}}" data-max-amount="{{$value.REMAIN_AMOUNT}}"
                               type="text" value="{{$value.AMOUNT}}" data-index="{{$index}}" class="settle-amount"
                               id="{{$value.ID}}_amount" data-id="{{$value.ID}}"/>元
                    </td>
                    <td><span id="{{$value.ID}}_status">完全结算</span></td>
                </tr>
                {{/each}}
                </tbody>
            </table>
        </div>

        <div class="summary" style="border: none;">
                <p><label>总金额</label>：<span id="total_amount">{{total}}</span>元</p>
        </div>
    </div>
</script>
<script>


    $(function () {
        function getCommissionIds() {
            var ids = [];
            $("input[name='checkedtd']:checkbox").each(function () {
                if ($(this).prop("checked") == true) {
                    ids.push($(this).val());
                }
            });

            return ids;
        }

        // 申请开票
        $('#apply_billing, #post_agency_reward_reim').click(function () {
            // 获取操作类型
            var prjId = '{$prjId}';
            var actName = $(this).attr('id');
            var commissionIds = getCommissionIds();
            if (!commissionIds.length) {
                layer.open({content: '请至少选择一条佣金记录', icon: 7});
                return;
            }
            createRequestForm(commissionIds);
            // 创建开票表单
            function createRequestForm(commissionIds) {
                if (commissionIds instanceof Array && commissionIds.length) {
                    var tplId = 'commission_invoice_tpl';  // 模板类型
                    var postUrl = "{:U('MemberDistribution/ajaxPostInvoice')}" + '/prjid/' + prjId;  // 数据提交接口
                    var tplName = '开票申请';
                    if (actName != 'apply_billing') {
                        tplId = 'commission_reim_tpl';
                        postUrl = "{:U('MemberDistribution/ajaxPostCommissionReim')}" + '/prjid/' + prjId;
                        tplName = '中介后佣报销申请';
                    }

                    $.ajax({
                        url: "{:U('MemberDistribution/ajaxGetCommissionData')}" + '/prjid/' + prjId,
                        data: {
                            commission_ids: commissionIds,
                            act_name: actName
                        },
                        type: 'POST',
                        success: onGetDataSuccess
                    });

                    function onGetDataSuccess(resp, xhr) {
                        if ($.type(resp) === 'string') {
                            resp = JSON.parse(resp);
                        }

                        if (resp.status == 'noauth') {
                            var msg = resp.msg || '没有权限';
                            layer.open({
                                content: msg,
                                icon: 2
                            });
                            return;
                        }

                        if (!resp.status) {
                            var msg = resp.msg || '获取数据失败';
                            layer.open({
                                content: msg,
                                icon: 2
                            });
                            return;
                        }

                        if (!resp.data.list.length) {
                            return '';
                        }

                        var respList = resp.data.list;  // 获取开票记录
                        layer.open({
                            title: tplName,
                            btn: ['确定', '取消'],
                            area: ['1200px', '600px'],
                            content: template(tplId, resp.data),
                            yes: function () {
                                if ($('.layui-layer-btn .layui-layer-btn0').attr('submit') == 1) {
                                    return;
                                }

                                var params = getParams();
                                var caseId = '{$caseId}';
                                $.ajax({
                                    url: postUrl,
                                    data: { commission_data: params, act_name: actName, case_id: caseId },
                                    type: 'POST',
                                    success: onPostDataSuccess
                                });
                                $('.layui-layer-btn .layui-layer-btn0').attr('submit', 1);
                            },
                            cancel: function () {
                                // todo
                            }
                        });

                        // 获取开票记录数据
                        function getParams() {
                            var params = {};
                            params.list = [];
                            // 获取每条记录设定的比例与对应金额
                            for (var i = 0; i < respList.length; i++) {
                                var one = {};
                                one.id = respList[i].ID;
                                one.card_member_id = respList[i].CARD_MEMBER_ID;
                                one.remain_amount = respList[i].REMAIN_AMOUNT;
                                one.remain_percent = respList[i].REMAIN_PERCENT;
                                one.percent = $('#' + one.id + '_percent').val();
                                one.amount = $('#' + one.id + '_amount').val();
                                params.list.push(one);
                            }

                            params.total_amount = $('#total_amount').text();
                            params.invoice_biz_type = $('#invoice_biz_type').val();  // 发票类型
                            params.invoice_class = $('#invoice_class').val();  // 发票类型
                            params.invoice_desc = $('#invoice_desc').val();
                            params.prj_id = '{$prjId}';
                            params.case_id = '{$caseId}';

                            return params;
                        }

                        // 提交开票数据成功的接口调用
                        function onPostDataSuccess(resp, xhr) {
                            if ($.type(resp) === 'string') {
                                resp = JSON.parse(resp);
                            }

                            if (resp.status == 'noauth') {
                                var msg = resp.msg || '没有权限';
                                layer.open({
                                    content: msg,
                                    icon: 2
                                });
                                return;
                            }

                            if (resp.status) {
                                layer.open({
                                    content: '申请成功',
                                    btn: ['确定'],
                                    yes: function() {
                                        location.reload();
                                    },
                                    icon: 1
                                });
                            } else {
                                var msg = resp.msg;
                                if (!msg) {
                                    if (tplId == 'commission_invoice_tpl') {
                                        msg = '申请开票失败';
                                    } else {
                                        msg = '中介后佣报销申请失败';
                                    }
                                }

                                layer.open({
                                    content: msg,
                                    btn:['确定'],
                                    icon: 2
                                });
                            }

                        }
                    }
                }
            }
        });

        //中介成交奖励、置业成交奖励报销
        $("#agency_deal_reward_reim, #property_deal_reward_reim, #out_reward_reim").click(function () {
            var actName = $(this).attr('id');
            var memberIds = [];
            $("input[name='checkedtd']:checkbox").each(function () {
                if ($(this).prop("checked") == true) {
                    var id = $(this).val();
                    memberIds.push($("[name='" + id + "_CARD_MEMBER_ID']").val());
                }
            });
            if (!memberIds.length) {
                layer.open({content: '请至少选择一条佣金记录', icon: 7});
                return;
            }
            var caseId = '{$caseId}';
            var prjId = '{$prjId}';
            $.ajax({
                type: "POST",
                url: "{:U('MemberDistribution/ajaxPostCommissionReim')}" + '/prjid/' + prjId,
                data: {member_ids: memberIds, act_name: actName, case_id: caseId},
                dataType: "JSON",
                success: function (resp, xhr) {
                    if ($.type(resp) === 'string') {
                        resp = JSON.parse(resp);
                    }

                    if (resp.status == 'noauth') {
                        var msg = resp.msg || '没有权限';
                        layer.open({
                            content: msg,
                            icon: 2
                        });
                        return;
                    }

                    var msg = resp.msg;
                    if (resp.status) {
                        msg = msg || '申请成功';
                        layer.open({
                            content: msg,
                            btn: ['确定'],
                            yes: function() {
                                location.reload();
                            },
                            icon: 1
                        });
                    } else {
                        msg = msg || '申请失败';
                        layer.open({
                            content: msg,
                            btn:['确定'],
                            icon: 2
                        });
                    }
                }
            })
        });

        $(document).on('keydown', '.summary textarea', function (event) {
            if (event.keyCode == 13) {
                $(this).val($(this).val() + '\r\n');
            }
        });

        // 修改结算比例
        $(document).on('keyup', 'input.settle-percent', function () {
            var
                    id = $(this).attr('data-id'),
                    curPercent = $(this).val(),
                    maxPercent = parseFloat($(this).attr('data-max-percent')),
                    maxAmount = parseFloat($(this).attr('data-max-amount'));

            if ((curPercent != '' && (parseFloat(curPercent) > maxPercent || parseFloat(curPercent) <= 0)) || (curPercent != '' && !$.isNumeric(curPercent))) {
                var msg = '';
                if (!$.isNumeric(curPercent)) {
                    msg = '请输入有效的数字';
                } else {
                    msg = '申请的结算比例超过了最大可申请结算比例，最大可申请计算比例为' + maxPercent + '%';
                    if (curPercent <= 0) {
                        msg = '申请结算比例要大于0';
                    }
                }
                alert(msg);
                $('#' + id + '_percent').val(save2DigsAfterPoint(maxPercent));
                $('#' + id + '_amount').val(save2DigsAfterPoint(maxAmount));
                $('#' + id + '_status').text('完全结算');
                return;
            }

            var curAmount = maxAmount * curPercent / maxPercent;
            $('#' + id + '_amount').val(save2DigsAfterPoint(curAmount));
            if (curAmount >= maxAmount) {
                $('#' + id + '_status').text('完全结算');
            } else {
                $('#' + id + '_status').text('部分结算');
            }
        });

        // 修改结算金额
        $(document).on('keyup', 'input.settle-amount', function () {
            var id = $(this).attr('data-id');
            var curAmount = $(this).val();
            var maxPercent = parseFloat($(this).attr('data-max-percent'));
            var maxAmount = parseFloat($(this).attr('data-max-amount'));
            if(maxAmount - parseInt(maxAmount) == 0){
                maxFloatAmount = maxAmount;
            }else if(maxAmount - parseInt(maxAmount) < 1){
                maxFloatAmount =  maxAmount + Number(1);
            }
            if ((curAmount != '' && (parseFloat(curAmount) > maxFloatAmount || parseFloat(curAmount) <= 0)) || (curAmount != '' && !$.isNumeric(curAmount))) {
                var msg = '';
                if (!$.isNumeric(curAmount)) {
                    msg = '请输入有效的数字';
                } else {
                    msg = '申请的结算金额超过了最大可结算金额，最大可申请结算金额为' + maxAmount + '元';
                    if (curAmount <= 0) {
                        msg = '申请结算金额要大于0';
                    }
                }

                alert(msg);
                $('#' + id + '_percent').val(save2DigsAfterPoint(maxPercent));
                $('#' + id + '_amount').val(save2DigsAfterPoint(maxAmount));
                $('#' + id + '_status').text('完全结算');
                return;
            }

            var curPercent = Math.round(curAmount * maxPercent * 100 / maxAmount) / 100; // 取两位有效数字
            $('#' + id + '_percent').val(save2DigsAfterPoint(curPercent));

            if (curAmount >= maxAmount) {
  
                $('#' + id + '_status').text('完全结算');
            } else {
                $('#' + id + '_status').text('部分结算');
            }
        });

        // 第1条申请记录比例发生变化
        $(document).on('blur', 'input.settle-percent', function () {
            var index = $(this).attr('data-index');
            // 1:如果是第一条记录，先更新每个独立结算比例与金额
            if (index == 0) {
                var percentElems = $('input.settle-percent');
                var anchorPercent = parseFloat($(percentElems[0]).val());
                for (var i = 1; i < percentElems.length; i++) {
                    var id = $(percentElems[i]).attr('data-id');
                    // 最大可结算比例
                    var tMaxPercent = parseFloat($(percentElems[i]).attr('data-max-percent'));
                    // 最大可结算金额
                    var tMaxAmount = parseFloat($(percentElems[i]).attr('data-max-amount'));
                    if (anchorPercent <= tMaxPercent) {
                        $(percentElems[i]).val(anchorPercent);
                        $('#' + id + '_amount').val(save2DigsAfterPoint(tMaxAmount * anchorPercent / tMaxPercent));
                    } else {
                        $(percentElems[i]).val(tMaxPercent);
                        $('#' + id + '_amount').val(save2DigsAfterPoint(tMaxAmount));
                    }

                    if (anchorPercent >= tMaxPercent) {
                        $('#' + id + '_status').text('完全结算');
                    } else {
                        $('#' + id + '_status').text('部分结算');
                    }
                }
            }

            // 2:更改总金额
            var totalAmount = 0;
            var amountElems = $('input.settle-amount');
            for (var i = 0; i < amountElems.length; i++) {
                totalAmount += parseFloat($(amountElems[i]).val());
            }

            $('#total_amount').text(totalAmount);
        });

        // 第1条申请记录金额发生变化
        $(document).on('blur', 'input.settle-amount', function () {
            var index = $(this).attr('data-index');
            // 1:如果是第一条记录，先更新每个独立结算比例与金额
            if (index == 0) {
                var amountElems = $('input.settle-amount');
                var anchorAmount = parseFloat($(amountElems[0]).val());
                for (var i = 1; i < amountElems.length; i++) {
                    var id = $(amountElems[i]).attr('data-id');
                    // 最大可结算比例
                    var tMaxPercent = parseFloat($(amountElems[i]).attr('data-max-percent'));
                    // 最大可结算金额
                    var tMaxAmount = parseFloat($(amountElems[i]).attr('data-max-amount'));
                    if (anchorAmount <= tMaxAmount) {
                        $(amountElems[i]).val(anchorAmount);
                        var curPercent = Math.round(anchorAmount * tMaxPercent * 100 / tMaxAmount) / 100; // 取两位有效数字
                        $('#' + id + '_percent').val(save2DigsAfterPoint(curPercent));
                    } else {
                        $(amountElems[i]).val(tMaxAmount);
                        $('#' + id + '_percent').val(save2DigsAfterPoint(tMaxPercent));
                    }

                    if (anchorAmount >= tMaxAmount) {
                        $('#' + id + '_status').text('完全结算');
                    } else {
                        $('#' + id + '_status').text('部分结算');
                    }
                }
            }

            // 2:更改总金额
            var totalAmount = 0;
            var amountElems = $('input.settle-amount');
            for (var i = 0; i < amountElems.length; i++) {
                totalAmount += parseFloat($(amountElems[i]).val());
            }

            $('#total_amount').text(totalAmount);
        });

        // 导出佣金记录
        $('#export_records').click(function () {
            var caseId = '{$caseId}';
            var filterSql = "{$filter_sql}";
            var sortSql = "{$sort_sql}";
            layer.confirm(
                    '确定导出会员吗?',
                    {icon: 3, title:'导出会员'},
                    function(index){
                        layer.close(index);
                        location.href = "{:U('MemberDistribution/exportPostCommission')}" + '/case_id/' + caseId + '/filter/' + filterSql + '/sort/' + sortSql;
                    }
            );
        });
    });
</script>
</body>
</html>