<!DOCTYPE html>
<html>
<head>
    <title>采购申请</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <include file="./Tpl/Admin/Public/comm_css_js.html" />
</head>
<body>
<div class="containter">
    <div class="right fright j-right">
        <div class="handle-tab">
            {$tabs}
        </div>
        <div style="position: absolute;top:20px;right: 80px;"><label class="label label-danger">鼠标右击-上下文菜单</label></div>
        {$form}
        <input type="hidden" name="url_current" id="url_current" value="{:U('Purchase/opinionFlow',$paramUrl)}">
    </div>
</div>
<script type="text/javascript">
    //提交采购申请
    $("#sub_purchase").click(function () {
        var p_id = $('.itemlist').filter('.selected').attr('fid');
        var status = $("select[name=" + p_id + "_STATUS]").val();

        if (status == 0) {
            layer.confirm(
                    '确定要提交采购申请吗(采购申请所有采购明细都会被提交)？',
                    {title: '提交采购申请'},
                    function (index) {
                        var _this = this;
                        //是否超出垫资比例
                        _this.is_over = false;

                        $.ajax({
                            type: "get",
                            url: "{:U('Api/is_over_payout_limit')}",
                            async: false,
                            data: {"p_id": p_id, "type": "purchase"},
                            dataType: "JSON",
                            success: function (res) {
                                if(res.data.state==true)
                                    _this.is_over = true;
                            },
                            error: function () {
                                alert("网络错误，请重试~~");
                            }
                        });

                        if(_this.is_over){
                            if(!confirm("该项目成本已超出垫资额度或超出费用预算（总费用>开票回款收入*付现成本率）\n您确定要继续吗？"))
                                return false;
                        }

                        $.ajax({
                            type: "GET",
                            url: "{:U('Purchase/check_purchase_list_by_pid')}",
                            data: {'p_id': p_id},
                            dataType: "JSON",
                            success: function (data) {
                                if (data.status == 1) {
//                                    var url_current = $('#url_current').val();
//                                    var url = url_current + "/purchase_id/" + p_id;
                                    var url = "{:U('Touch/Purchase/process')}" + '/RECORDID/' + p_id;
                                    window.location.href = url;
                                }
                                else {
                                    layer.alert(data.msg, {icon: 2, closeBtn: false},
                                            function () {
                                                layer.close(index);
                                                window.location.reload();
                                            });
                                }
                            }
                        })
                    }
            );
        }
        else {
            layer.alert('未提交过的采购申请才能提交', {icon: 2});
        }
    });

    // 查看采购流程图
    $('#show_flow_step').click(function () {
        // 定义异步调用的处理函数
        // 获取工作流ID异步调用成功回调函数
        function getFlowIdSuccess(resp, status, xhr) {
            if (resp) {
                resp = JSON.parse(resp);
            }

            if (resp.status == 'noauth') {
                var message = resp.msg || '权限不足';
                layer.alert(message, {icon: 2});
                return;
            }

            if (resp.status) {
                var viewFlowUrl = "{:U('Flow/viewFlow')}";
                viewFlowUrl += '/FLOWID/' + resp.data;
                layer.open({
                    type: 2,
                    title: '流程图',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['90%', '90%'],
                    content: viewFlowUrl
                });

            } else {
                var message = resp.message || '获取工作流ID失败';
                layer.alert(message, {icon: 7});
            }
        }

        // 获取工作流ID异步调用失败回调函数
        function getFlowIdFail(xhr, status, error) {
            layer.alert('服务器访问异常，请稍后重试!', {icon: 2});
        }

        // 显示流程图
        var selectedItem = $('.contractinfo-table .itemlist.selected');
        if (!selectedItem) {
            layer.alert('请选择一条采购申请!', {icon: 7});
            return;
        }
        var fid = selectedItem.attr('fid');
        if (fid) {
            if ($("select[name='" + fid + "_STATUS']").val() == 0) {
                layer.alert('该采购申请尚未发起工作流!', {icon: 7});
                return;
            }
            $.ajax({
                url: "{:U('Purchase/getFlowId')}",
                data: {
                    'purchaseId': fid
                },
                success: getFlowIdSuccess,
                error: getFlowIdFail
            });
        }
    });

    // 是否显示分页内的新增按钮
    var isShowOptionBtn = "{$isShowOptionBtn}";
    if (isShowOptionBtn == DISPLAY_OPTION_BTN.HIDE) {
        $.each($('.page a'), function (index, elem) {
            if (REG_EXPS.ADD.test($(elem).text())
                    || REG_EXPS.COMMIT.test($(elem).text())) {
                $(elem).remove();
            }
        });
    }

    $('input[name="END_TIME"]').blur(function() {
        if (!$('input[name="END_TIME"]').val().trim()) return;

        var postDate = new Date($('input[name="END_TIME"]').val());
        var nowDate = new Date();

        if (postDate< nowDate) {
            alert('最晚送达时间不得小于当前时间');
            $('input[name="END_TIME"]').val('');
        }
    });
</script>
<include file="./Tpl/Admin/Public/filter.html" />
<include file="./Tpl/Admin/Public/contextMenu.html" />
</body>
</html>