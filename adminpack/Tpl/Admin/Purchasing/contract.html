<!DOCTYPE html>
<html>
    <head>
        <title>采购合同</title>
        <meta charset="GBK">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <include file="./Tpl/Admin/Public/comm_css_js.html" />
		<style>
			.ui-autocomplete {
				max-height: 200px;
				overflow-y: auto;
				/* 防止水平滚动条 */
				overflow-x: hidden;
			}
		</style>
   
</head>
<body>
         
<div class="containter">     
  <div class="right fright j-right">	 
      <div class="handle-tab  ">
      <if condition="$layer neq 1">
      {$tabs}
      </if>
      </div>
          {$form}
    </div>   
</div>
<script>
	
	$(function(){
        // 隐藏未签约、无效的供应商
        var CONTRACT = {
            INVALID_SUPPLIER: 0,
            NO_SIGNED: 0
        };

        $('.contractinfo-table > table  tr').each(function(index, elem) {
            $(elem).find('td:eq(-2)').hide();  // 隐藏供应商状态列
            $(elem).find('th:eq(-2)').hide();  // 隐藏供应商状态列
            var supplierStatusElem = $(elem).find('select[name*="_SUPPLIER_STATUS"]');
            var isSignElem = $(elem).find('select[name*="_ISSIGN"]');
            if (supplierStatusElem && isSignElem) {
                var supplierStatus = parseInt(supplierStatusElem.val());
                var isSignStatus = parseInt(isSignElem.val());
                if (supplierStatus == CONTRACT.INVALID_SUPPLIER
                        && isSignStatus == CONTRACT.NO_SIGNED) {
                    $(elem).find('select[name*="_SUPPLIER_ID"]').closest('td').text('');
                }
            }
        });

		var islayer = '{$layer}';
                $(".contractinfo-table tbody tr").click(function () {
			$(this).siblings().removeClass("selected");
			$(this).addClass("selected");
		});
		/*if($("[name='ISSIGN_OLD']").val()==-1){
			$("[name='ISSIGN']").parent().parent().find('span').removeClass('spanhidden');
			$("[name='ISSIGN']").parent().hide();

		}*/
		function checkboxevent(obj){
			var fid = $(obj).val(); 
			if( $(obj).is(':checked') ){
				if(!$("#selecttr"+fid).length )$(obj).after('<input name="selecttr[]" id="selecttr'+fid+'"   class="selecttr" value="'+fid+'" type="hidden">');
			}else{
				$("#selecttr"+fid).remove();
			}
		}
		if(islayer == 1){
			//已有合同子页面
			$('.checkedtd').each(function(){
				var val = $(this).val();
				$(this).after('<input type="radio" name="checkradio" value="'+val+'" />').remove();
			});
			$("#checkall").remove();
			$('input[name=checkradio]').click(function(){
				$('input[name=aptocontractId]',window.parent.document).val($(this).val());
			});

		}else{
			$('.checkedtd').each(function(){
				$(this).click(function(){
					checkboxevent(this);
				});
			});
			$("#checkall").click( 
				function(){ 
					if(this.checked){ 
						$("input[name='checkedtd']").each(function(){ 
							 
							this.checked=true;
							checkboxevent(this);
						}); 
					}else{ 
						$("input[name='checkedtd']").each(function(){
							 
							this.checked=false;
							checkboxevent(this);
							 
						}); 
					} 
				} 
			);
		}     
	}) ;
	//判断选择
	function  ischeck(){
		var count = 0;
		$('.checkedtd').each(function(){
			if(this.checked){
				count++;
			} 
		});
		return count;
	}
	
	//新增框架合同
	function addkjcontract()
	{
		var url = "{:U('Purchasing/contract?showForm=1&kjcontract=1')}";
		window.location.href =url;
	}
	
	//生成报销申请
	function addreimbursement()
	{
            if(ischeck())
            {
                var contract_ids = [];
                $(".selecttr").each(function(){
                        contract_ids.push($(this).val());
                });

                $.ajax({
                    url:"{:U('Reimbursement/apply_purchase_contract_reim')}",
                    dataType : 'json',
                    type: 'GET',
                    data:{'contract_ids':contract_ids},
                    success:function(data)
                    {
                        if(data.state == 1)
                        {
                            layer.alert(
                                    data.msg, 
                                    {icon: 1},
                                    function(){                            
                                        if(data.forward != '')
                                        {
                                            self.location = data.forward;
                                        }
                                        else
                                        {
                                            window.location.reload();
                                        }
                                    });
                        }
                        else if(data.state == 0)
                        {
                            layer.alert(data.msg, {icon: 2});
                        }
                        else
                        {
                            var msg = data.msg ? data.msg : '申请报销功能异常';
                            layer.alert(msg, {icon: 2});
                        }
                    }
                });
            }
            else
            {
                layer.alert('请先选择采购合同！', {icon: 2});
            }
	}
        
	//删除合同
	function fthisDelContract(obj){
		var contract_id   =$(obj).parent().attr('fid');

        layer.confirm(
                '确定删除合同吗？',
                {title: '删除合同'},
                function(index)
                {
                    $.ajax({
                        url:"{:U('Purchasing/del_contract')}",
                        dataType : 'json',
                        type: 'GET',
                        data:{'contract_id':contract_id},
                        success:function(data)
                        {
                            // layer.alert
                            if(data.status==1){
                                layer.alert('删除合同成功！');
                                window.location.href= window.location.href;
                            }else layer.alert(data.info);
                        }
                    });
                }
        );
	}
	 
</script>
<include file="./Tpl/Admin/Public/filter.html" />
</body>
</html>
