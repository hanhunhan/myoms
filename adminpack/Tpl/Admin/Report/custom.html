<!DOCTYPE html>
<html>
<head>
    <title>自定义统计</title>
    <meta charset="GBK">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./Public/css/style2.css" type="text/css" rel="stylesheet"/>
    <link href="./Public/css/jquery-ui.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="./Public/validform/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="./Public/validform/js/Validform_v5.3.2.js"></script>
    <script type="text/javascript" src="./Public/validform/js/common.js"></script>
    <script type="text/javascript" src="./Public/js/common.js"></script>
    <script type="text/javascript" src="./Public/js/select.js"></script>

    <script language="javascript" type="text/javascript" src="./Public/My97DatePicker/WdatePicker.js"></script>

    <script type="text/javascript" src="./Public/validform/plugin/swfupload/swfuploadv2.2.js"></script>
    <script type="text/javascript" src="./Public/validform/plugin/swfupload/Validform.swfupload.handler.js"></script>
    <script type="text/javascript" src="./Public/js/jquery-ui.js"></script>

    <link href="./Public/css/jquery.autocomplete.css" rel="stylesheet" type="text/css" />
    <script src="./Public/js/jquery.autocomplete.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="./Public/validform/css/style.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="./Public/validform/css/validateForm.css" type="text/css" media="all"/>
    <link rel="stylesheet" href="./Public/css/report.css" type="text/css" media="all"/>
    <link href="./Public/css/report2.css" type="text/css" rel="stylesheet"/>
    <style type="text/css">
        .btn139 {
            border: none;
            cursor: pointer;
        }

        .zidytji span {
            float: none;
        }

        .fyinfotd {
            display: none;
        }

        #smxqinfo th {
            padding: 10px;
            background: #349ac0;
            color: #fff;
        }

        #smxqinfo td {
            padding: 10px 10px 10px 10px;
            white-space:nowrap;
            word-break:keep-all;
        }

        .clearfix:after {
            content: ".";
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }

        .clearfix {
            display: inline-block;
        }

        /* Hides from IE-mac \*/
        * html .clearfix {
            height: 1%;
        }

        .clearfix {
            display: block;
        }

        /* End hide from IE-mac */
        body, div, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, pre, code, form, fieldset, legend, input, button, textarea, select, p, blockquote, th, td {
            font-family: 微软雅黑, Arial, Helvetica, sans-serif;
            font-size: 13px;
        }

    </style>
    <script type="text/javascript">
        $(function(){
            //业务
            $("#search_yw").on("change",function(){
                var val = $(this).val();
                switch(val){
                    case "1":
                        $("#check_table_1").show();
                        $("#check_table_2").hide();
                        $("#check_table_3").hide();
                        $("#check_table_4").hide();
                        break;
                    case "2":
                        $("#check_table_1").hide();
                        $("#check_table_2").show();
                        $("#check_table_3").hide();
                        $("#check_table_4").hide();
                        break;
                    case "3":
                        $("#check_table_1").hide();
                        $("#check_table_2").hide();
                        $("#check_table_3").show();
                        $("#check_table_4").hide();
                        break;
                    case "4":
                        $("#check_table_1").hide();
                        $("#check_table_2").hide();
                        $("#check_table_3").hide();
                        $("#check_table_4").show();
                        break;
                    default :
                        $("#check_table_1").show();
                        $("#check_table_2").hide();
                        $("#check_table_3").hide();
                        $("#check_table_4").hide();
                        break;
                }
            });

            $("#check_con").on("change",function(){
                var val = $(this).val();
                if(val==1){
                    $("#check_con_1").show();
                    $("#check_con_3").hide();
                    $("input[name='arr_search_city[]']").change();
                }
                else if(val == 2){
                    $("#check_con_1").hide();
                    $("#check_con_2").hide();
                    $("#check_con_3").show();
                }
            });

            //城市选择
            $("input[name='arr_search_city[]']").change(function(){
                var flag = 0;
                $("input[name='arr_search_city[]']:checked").each(function () {
                    flag++;
                });

                if(flag != 1){
                    $("#check_con_2").hide();
                }
                else{
                    $("#check_con_2").show();
                }
            });

            //加载的时候运行一下
            $("#check_con").change();

            $("#checkstatus").click(function(){
                var isChecked = $(this).prop("checked");
                $("input[name='arr_search_state[]']").prop("checked", isChecked);
            });
            $("#checkcity").click(function(){
                var isChecked = $(this).prop("checked");
                $("input[name='arr_search_city[]']").prop("checked", isChecked);
                $("input[name='arr_search_city[]']").change();
            });
            $("#checkrecord").click(function(){
                var isChecked = $(this).prop("checked");
                $("input[name='arr_record[]']").prop("checked", isChecked);
            });


            //城市展开
            $(".checkzhkai").click(function () {
                if ($(this).is(':checked')) {
                    $(this).closest("tr").next('tr').fadeIn();
                } else {
                    $(this).closest('tr').next('tr').fadeOut();
                }
            });

            $("#checkall").click(function () {
                if ($(this).attr('data-flag') == 1) {
                    $("input[name='arr_search_checked[]']").prop("checked", true);
                    $(this).attr('data-flag', '0');
                } else {
                    $("input[name='arr_search_checked[]']").prop("checked", false);
                    $(this).attr('data-flag', '1');
                }
            });

            $(".inputnone").on('focus','.search_prjname',function(){
                $(this).bind("input.autocomplete",function(){
                   $(this).trigger('keydown.autocomplete');
                });

                $(this).autocomplete("{:U('Report/custom')}&act=getprj", {
                    delay:10,//延迟10秒
                    matchSubset: 1,
                    matchContains: 1,
                    max: 15,
                    cacheLength: 15,
                    width:268,
                    autoFill: false, //自动填充
                    dataType: 'json',
                    //加入对返回的json对象进行解析函数，函数返回一个数组
                    parse: function(data) {
                        var rows = [];
                        if(data){
                            for(var i=0; i<data.length; i++){
                                rows[rows.length] = {
                                    data: data[i],
                                    value: data[i].prjid,
                                    result: '[' + data[i].city + ']' + data[i].prjname //返回的结果显示内容
                                };
                            }
                        }
                        return rows;
                    },
                    formatItem: function(row) {
                        return '[' + row.city + ']' + row.prjname;
                    },
                    formatMatch: function(row, i, max) {
                        return row.prjid + row.prjname;
                    },
                    formatResult: function(row) {
                        return row.prjid;
                    }
                }).result(function(event, row, formatter) {
                    $(this).next("input[name*=arr_search_prj]").val(row.prjid);
                });
            });

            $(".add_prj").on('click', function () {
                var idx = $(".smzjia").length;
                var html = '<div class="smzjia clearfix"><div class="smfl"><input class="search_prjname" type="text" /><input name="arr_search_prj[]" type="hidden" /></div>' +
                        '<div class="smzhuangt" style="float:right;"><a class="orange del_prj"  href="javascript:void(0)">删除</a></div></div>';
                $('.inputnone').append(html);
            });

            $(".inputnone").on('click', ".del_prj",function (){
                $(this).parents(".smzjia").remove();
            });

            $("#savecfg").click(function () {
                var cfg_checked = '';
                $('#check_table input[name^="arr_search_checked[]"]:checked').each(function () {
                    cfg_checked += $(this).attr('value') + ',';
                });
                cfg_checked = cfg_checked.substring(0, cfg_checked.length - 1);
                $.post("__ACTION__&act=savecfg", {cfg: cfg_checked, act: 'savecfg'}, function (data) {
                    if (data != "true") {
                        alert("操作失败，请重试~");
                        return false;
                    }
                    alert('已保存您的当前设置~');
                });
            });

            $(".print").bind("click", function () {
//                var records = [];
//                $('input[name^="arr_record[]"]:checked').each(function () {
//                    records.push($(this).attr('value'));
//                });
//
//                if (records == "") {
//                    alert("请至少选择一条记录~~");
//                    return false;
//                }
//
//                if ($('input[name="search_prj"]').val()) {
//                    $('input[name="search_prj"]').val(records);
//
//                } else {
//                    $('input[name="search_city"]').val(records);
//                }
//
//                $('input[name="record"]').val(records);
                $('input[name="print"]').val('yes');
                $("#search_form").attr("target", "_blank");
                $("#search_form").submit();
            });

            $(".tongjicx input[type='submit']").bind("click", function () {
                $('input[name="print"]').val('');
                $("#search_form").attr("target", "");
                var search_state = search_city = search_prj = search_checked = '';

                $('input[name^="arr_search_state[]"]:checked').each(function () {
                    search_state += $(this).attr('value') + ',';
                });
                $('input[name="search_state"]').val(search_state.substring(0, search_state.length - 1));

                if ($("#city_checkbox").is(':checked')) {
                    $('input[name^="arr_search_city[]"]:checked').each(function () {
                        search_city += $(this).attr('value') + ',';
                    });
                    $('input[name="search_city"]').val(search_city.substring(0, search_city.length - 1));
                } else {
                    $('input[name="search_city"]').val('');
                }

                if ($("#prj_checkbox").is(':checked')) {
                    for (var i = 0; i < $(".smzjia").length; i++) {
                        if ($('input[name="arr_search_prj[]"]').eq(i).val())
                            search_prj += $('input[name="arr_search_prj[]"]').eq(i).val() + ',';
                    }
                    $('input[name="search_prj"]').val(search_prj.substring(0, search_prj.length - 1));
                } else {
                    $('input[name="search_prj"]').val('');
                }

                $('input[name^="arr_search_checked[]"]:checked').each(function () {
                    search_checked += $(this).attr('value') + ',';
                });
                $('input[name="search_checked"]').val(search_checked.substring(0, search_checked.length - 1));
            });
        });

    </script>
</head>
<body>

<div style="margin-top: 20px;">
    <form id="search_form" action="__ACTION__" method="post" class="clearfix">
        <div class="zidytji">
            <table width="100%" class="duibizht">
                <tr>
                    <td width="80" align="right"><span style="color: red">业务类型：</span>&nbsp;</td>
                    <td id="smcheckyw">
                        <select name="search_yw" id="search_yw" style="width:200px;">
                            <?php foreach($case_type as $key=>$val){ ?>
                            <option value="<?=$key?>" <?php if($search_yw==$key){echo "selected";}?>><?=$val?></option>
                            <?php } ?>
                        </select>
                    </td>

                    <td width="120" align="right">查询时间段：&nbsp;</td>
                    <td>
                        <input type="text" name="search_btime" id="search_btime" style="width: 180px; line-height:26px;"
                               onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',alwaysUseStartDate:true})"
                               value="{$search_btime}"/>
                        &nbsp;-&nbsp;
                        <input type="text" name="search_etime" id="search_etime" style="width: 180px;line-height: 26px;"
                               onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',alwaysUseStartDate:true})"
                               value="{$search_etime}"/>
                    </td>

                </tr>
                <tr>
                    <td width="80" align="right">业务状态：&nbsp;</td>
                    <td id="smcheckall">
                        <select name="search_state" id="search_state" style="width:200px;">
                            <option value="0">----全部-----</option>
                            <?php foreach($prjState as $key=>$val){ ?>
                            <option value="<?=$key?>" <?php if($search_state==$key){echo "selected";} ?>><?=$val?></option>
                            <?php } ?>
                        </select>
                    </td>
                    <td align="right">财务状态：&nbsp;</td>
                    <td>
                        <select name="check_finan_con" id="check_finan_con" style="width:200px;">
                            <option value="1" <?php if($check_finan_con==1){echo "selected";} ?>>----全部-----</option>
                            <option value="2" <?php if($check_finan_con==2){echo "selected";} ?>>----财务已确认-----</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td align="right">查询条件：&nbsp;</td>
                    <td colspan="3">
                        <select name="check_con" id="check_con" style="width:200px;">
                            <option value="1" <?php if($check_con==1){echo "selected";}?>>----城市对比-----</option>
                            <option value="2" <?php if($check_con==2){echo "selected";}?>>----项目对比(可跨城市)-----</option>
                        </select>
                    </td>
                </tr>
                <tr id="check_con_1">
                    <td></td>
                    <td colspan="3" id="sm_checkcity">
                        <div class="sm_div clearfix" >
                            <div class="smzhuangt">
                                <input id="checkcity" type="checkbox" class="allx" /><span>全选</span>
                            </div>
                            <?php
                            foreach($p_authcity as $key=>$val){
                                ?>
                            <div class="smzhuangt">
                            <input type="checkbox" name="arr_search_city[]" <?php if(in_array($val,$arr_search_city)){echo "checked";} ?> value="{$val}"/><span>{$cityname[$val]}</span>
                            </div>
                                <?php
                            }
                            ?>
                        </div>
                    </td>
                </tr>
                <tr id="check_con_2">
                    <td></td>
                    <td colspan="3">
                        <div class="smzhuangt">
                            <input id="whole_prj_checkbox" name="whole_prj_checkbox" value="1" type="checkbox" <?php if($whole_prj_checkbox){echo "checked";} ?> /><span style="margin-left: 10px">全部项目<针对单一城市></span>
                        </div>
                    </td>
                </tr>

                <tr class="<if condition='$search_prj eq null'>fyinfotd</if>"  id="check_con_3">
                    <td></td>
                    <td colspan="3">
                        <div class="inputnone">
                            <notempty name="arr_search_prj">
                                <volist name="arr_search_prj" id="v">
                                    <div class="smzjia clearfix">
                                        <div class="smfl">
                                            <input class="search_prjname" type="text" value="{$arr_projects[$v]}"/>
                                            <input name="arr_search_prj[]" type="hidden" value="{$v}"/>
                                        </div>
                                        <div class="smzhuangt" style="float:right;"><a class="orange del_prj" href="javascript:void(0)">删除</a>
                                        </div>
                                    </div>
                                </volist>
                            </notempty>
                            <empty name="arr_search_prj">
                                <div class="smzjia clearfix">
                                    <div class="smfl">
                                        <input class="search_prjname" type="text"/>
                                        <input name="arr_search_prj[]" type="hidden"/>
                                    </div>
                                </div>
                            </empty>
                        </div>
                        <div class="sm_target"><a class="add_prj" href="javascript:void(0);">添加项目</a></div>
                    </td>
                </tr>

            </table>

            <div class="sm_div">
                <input type="hidden" name="search_checked" value="{$search_checked}"/>
                <?php
                foreach($custom_checked as $key=>$val){
                ?>
                <table id="check_table_{$key}" width="100%" style="<?php if($key!=$search_yw){echo 'display:none;';} ?>">
                    <?php
                    $i = 0;
                    foreach($val as $k=>$v){
                            if(($i%8)==0){
                                echo "<tr>";
                            }
                        ?>
                        <td><input type="checkbox" name="arr_search_checked[]" value="{$k}"
                            <if condition="in_array($k,$arr_search_checked)">checked</if>
                            /><a title="{$v}" id="{$k}">{$v}</a></td>
                        <?php
                        $i++;
                        if(($i%8)==0){
                            echo "</tr>";
                        }
                    } ?>
                </table>
                <?php
                }
                ?>

                <div class="tongjicx">
                    <input type="hidden" name="record"/>
                    <input type="hidden" name="print"/>
                    <input type="button" id="checkall" class="btn593 sm_blue" value="全选/全不选" data-flag="1"
                           style="width:86px;cursor:pointer;border:none;background-position:0 -592px;">
                    <input type="button" id="savecfg" class="btn593 sm_blue" value="保存当前设置"
                           style="width:86px;cursor:pointer;margin:0 13px;border:none;background-position:0 -592px;"/>
                    <input type="submit" class="btn139 sm_blue" value="查询"/>
                </div>
            </div>

            <?php
             if(count($arr_search_checked)<14){
             ?>
            <div class="mrtb10" style="margin-top: 20px;float: right;">
                <a class="btn593 sm_blue print" style="text-align:center;" href="javascript:void(0)">报表导出</a>
            </div>
            <table id="smxqinfo" style="width: 100%;margin-top: 0px;">
                {$html}
            </table>
            <?php }else{ ?>
            <div style="zoom:1;overflow-x:scroll;">
                <a class="btn593 sm_blue print" style="text-align:center; margin: 10px; float: right" href="javascript:void(0)">报表导出</a>
                <table id="smxqinfo" style="table-layout:fixed;margin-top: 0px;clear: both">
                    {$html}
                </table>
            </div>
            <?php } ?>

            <div class="mrtb10">
                <p class="pagenum">{$page_nav}</p>
            </div>
        </div>
    </form>
</div>

<input type="hidden" id="u" value="{$pageurl}&pn={$page}"/>

</body>
</html>
