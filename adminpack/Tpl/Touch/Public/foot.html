<script src="Public/validform/js/jquery-1.9.1.min.js"></script>
<script src="Public/third/bootstrap/js/bootstrap.min.js"></script>
<script src="Public/uploadify/jquery.uploadify-3.1.min.js"></script>
<script src="Public/js/ECS5.js"></script>
<script src="//cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
<link rel="stylesheet" href="Public/select2/select2.css" type="text/css" media="all"/>
<link href="Public/css/style2.css" type="text/css" rel="stylesheet"/>
<script type="text/javascript" src="Public/select2/select2.js"></script>
<script type="text/javascript" src="Public/layer/layer.js"></script>
<!--jquery-ui-->
<script type="text/javascript" src="./Public/js/jquery-ui.js"></script>
<!--弹出框-->
<if condition="$isMobile eq 1">
    <script language="javascript" type="text/javascript" src="Public/layer.mobile/layer/layer.js"></script>
    <else />
    <script language="javascript" type="text/javascript" src="Public/layer/layer.js"></script>
    <script language="javascript" type="text/javascript" src="Public/layer/extend/layer.ext.js"></script>
</if>
<!--selectize-->
<link rel="stylesheet" href="Public/selectize/examples/css/normalize.css">
<link rel="stylesheet" href="Public/selectize/examples/css/stylesheet.css">
<link rel="stylesheet" href="Public/selectize/dist/css/selectize.default.css"">
<script src="Public/selectize/dist/js/standalone/selectize.js"></script>
<script src="Public/selectize/examples/js/index.js"></script>

<!--comm.js-->
<script>
    $(function () {
        var CONFIG = {
            'USERS_URL': '__APP__/Touch/Provider/getUsers/flowType/{$flowType}',
            'MID_SCREEN_WIDTH': 768
        };

        // 判断是否为安卓设备
        function isAndroidDevice() {
            var is_android = false;

            if (navigator.userAgent.match(/android/i)) {
                is_android = true;
            }

            return is_android;
        }

        // 为body添加position属性
        function addPositionToBody() {
            if (isAndroidDevice()) {
                $('body').addClass('relative-position');
            } else {
                $('body').addClass('fixed-position');
            }
        }

        function removePositionFromBody() {
            $('body').removeClass('relative-position fixed-position');
        }

        var rightMenu = $('#right-menu');

        var menuWidth = $(window).width() * 0.6 + 'px';
        if ($(window).width() > 768) {  // 如果是大尺寸屏幕，则设置为最大值
            menuWidth = 240;
        }
        rightMenu.css({
            'width': menuWidth,
            'right': '-' + menuWidth
        });

        $(document).on('touchend click', '#catalog-button, .overlay', function (event) {
            // toggle overlay
            event.preventDefault();
            doMenuCtrl();
        });

        $(document).on('click', '#right-menu a', function (event) {
            event.preventDefault();
            var anchorName = $(this).attr('href');
            if (anchorName[0] == '#') {
                anchorName = anchorName.substr(1);
            }
            if (anchorName) {
                gotoAnchor(anchorName, 500);
            }
            doMenuCtrl();
        });

        function doMenuCtrl() {
            $('body').toggleClass('noscroll');
            $('.overlay').toggleClass('show');

            // toggle menu
            rightMenu.toggleClass('cbp-spmenu-open');
        }

        // 跳转至审批意见锚点
        function gotoAnchor(anchorName, timeSpan) {
            timeSpan = timeSpan || 0;
            var pos = $('a[name="' + anchorName + '"]').position();
            var top = parseInt(pos.top) - 20;
            if (parseFloat($(window).width()) >= CONFIG.MID_SCREEN_WIDTH) {
                top -= 140;
            }
            $('html, body').animate({
                scrollTop: top + 'px'
            }, timeSpan);
        }


        /**
         * 用户筛选列表及相应交互
         */
        function UserProvider(options) {
            return {
                init: function () {
                    var that = this;
                    this.type = options.type;  // single=单选， multi=多选
                    this.model = options.model;
                    this.userList = [];
                    if (options.list) {
                        this.elem = $('#' + options.list);
                    }

                    if (options.triggerBtn) {
                        this.triggerBtn = '#' + options.triggerBtn;
                    }

                    var search = function () {
                        var val = $.trim(that.elem.find('.search-box .search-box-text').val());
                        var searchReg = new RegExp(val, 'i');
                        var lis = that.elem.find('li');
                        for (var j = 0; j < lis.length; j++) {
                            var userDesc = $(lis[j]).find('.user-desc').text();
                            var username = $(lis[j]).attr('data-name');
                            if (!searchReg.test(userDesc) && !searchReg.test(username)) {
                                $(lis[j]).removeClass('show');
                                $(lis[j]).addClass('hide');
                            } else {
                                $(lis[j]).removeClass('hide');
                                $(lis[j]).addClass('show');
                            }
                        }

                        var uls = that.elem.find('ul');
                        for (var j = 0; j < uls.length; j++) {
                            var showLiCount = $(uls[j]).find('li.show').length;
                            if (showLiCount == 0) {
                                $(uls[j]).closest('.panel').addClass('hide');
                            } else {
                                $(uls[j]).closest('.panel').removeClass('hide');
                            }
                        }
                    };
                    this.elem.find('.search-box input.search-box-text').on('input', search);
                    return this;
                },

                fire: function () {
                    var that = this;
                    //console.log(that);
                    // 默认请求一次异步调用
                    function triggerOnceRequest() {
                        var type = that.type;
                        var model = that.model;
                        // 如果有转交至下一步按钮，则默认先请求一次调用
                        var hasNext = "{$showButtons['next']}";
                        if (hasNext) {
                            // 默认先请求一次
                            $.ajax({
                                url: CONFIG.USERS_URL,
                                type: 'GET',
                                dataType: 'json',
                                data: {
                                    flowId: '{$flowId}',
                                    type:type,
                                    model:model,
                                },
                                success: function (res) {
                                    if (res.status) {
                                        that.updateUserList(res.data);
                                        that.elem.addClass('loaded');
                                    }
                                },
                                error: function () {
                                    // todo
                                }
                            });
                        }
                    }
                    //console.log(that);
                    var resetSelectedUsers = function () {
                        that.elem.find('.select-indictor').addClass('hide');
                        that.elem.find('li.selected').removeClass('selected');

                        for (var key in that.userList) {
                            var id = that.userList[key]['id'];
                            that.elem.find('[ok-indictor="' + id + '"]').removeClass('hide');
                            that.elem.find('li[data-id="' + id + '"]').addClass('selected');
                        }

                        if (that.type == 'single') {
                            var desc = that.userList.length && that.userList['userDesc'] || '';
                            that.elem.find('.select-result').text(desc);
                        } else if (that.type == 'multi') {
                            var userNum = that.userList.length;
                            if(that.model == 'group'){
                                that.elem.find('.select-result').text('已选中' + userNum + '组');
                            }else{
                                that.elem.find('.select-result').text('已选中' + userNum + '人');
                            }

                        }

                    };
                    //console.log(that);
                    $(document).on('click', that.triggerBtn, function (event) {
                        var type = that.type;
                        var model = that.model;
                        event.preventDefault();
                        $('body').toggleClass('noscroll');
                        addPositionToBody();
                        that.elem.show();
                        //console.log(that)
                        if (!that.elem.hasClass('loaded')) {
                            $.ajax({
                                url: CONFIG.USERS_URL,
                                type: 'GET',
                                dataType: 'json',
                                data: {
                                    flowId: '{$flowId}',
                                    type:type,
                                    model:model,
                                },
                                success: function (res) {
                                    if (res.status) {
                                        that.updateUserList(res.data);
                                        that.elem.addClass('loaded');
                                    }
                                },
                                error: function () {
                                    // todo
                                }
                            });
                        } else {
                            resetSelectedUsers();
                        }
                    });
                    triggerOnceRequest();  // 请求一次异步调用

                    return this;
                },
                updateUserList: function (data) {
                    var that = this;
                    var createUserPanel = function () {
                        return $('<div class="panel panel-default"></div>')
                    };

                    var createUserDesc = function (user) {
                        if(user['NAME']) {
                            var text = user['NAME'];
                            if (user['DEPTNAME']) {
                                text += '-' + user['DEPTNAME'];
                            }
                            if (user['CITY_NAME']) {
                                text += '-' + user['CITY_NAME'];
                            }
                        }else{
                            var text = user['GROUPNAME'];
                        }
                        return text;
                    };

                    var createUserItem = function (data) {
                        var desc = createUserDesc(data);
                        if(data['USERNAME']) {
                            var view = $('<li class="list-group-item" data-name="' + data['USERNAME'] + '" data-id="' + data['ID'] + '"></li>');
                        }else{
                            var view = $('<li class="list-group-item" data-name="' + data['GROUPNAME'] + '" data-id="' + data['ID'] + '"></li>');
                        }
                        var indicator = $('<i class="glyphicon glyphicon-ok pull-right hide select-indictor" ok-indictor="' + data['ID'] + '"></i>');
                        view.append(indicator);
                        view.append('<span class=user-desc>' + desc + '</a>');

                        view.click(function () {

                            // 如果是单选，则最多只能选中一个条目
                            if (that.type == 'single') {
                                $('li.list-group-item.selected').removeClass('selected').find('i').addClass('hide');
                                that.elem.find('.select-result').text(desc);
                            }

                            indicator.toggleClass('hide');
                            view.toggleClass('selected');

                            if (that.type == 'multi') {
                                var userNum = that.elem.find('li.selected').length;
                                if(that.model == 'group'){
                                    var group_userId = []
                                     group_userId[0] =$(this).attr("data-id");
                                    $.ajax({
                                        url: "index.php?s=/Api/getFlowGroupName",
                                        dataType: "json",
                                        data: {
                                            "groupUserId": group_userId,
                                        },
                                        success: function (data) {
                                            $("#group_name").val(data);
                                            $("#group_name").prop("disabled",true);
                                        }
                                    })
                                    that.elem.find('.select-result').text('已选中' + userNum + '组');
                                }else {
                                    that.elem.find('.select-result').text('已选中' + userNum + '人');
                                }
                                setTimeout(function () {
                                    that.elem.find('.search-box input.search-box-text').val('').trigger('input');  // 清空搜索
                                }, 500);
                            }

                        });

                        return view;
                    };

                    var usersBody = this.elem.find('.users-body');
                    for (var key in data) {
                        var userPanel = createUserPanel();
                        userPanel.append('<div class="panel-heading"><strong>' + key + '</strong></div>');
                        var userGroup = $('<ul class="list-group"></ul>');
                        userPanel.append(userGroup);
                        for (var i = 0; i < data[key].length; i++) {
                            var listItem = createUserItem(data[key][i]);
                            userGroup.append(listItem);
                        }
                        usersBody.append(userPanel);
                    }
                },
                bindButtons: function () {
                    var that = this;

                    // 创建选择用户条目
                    var createSelectedUserItem = function (data) {
                        var elem = $('<li class="alert-info" data-id="' + data['id'] + '"></li>');
                        elem.append('<button type="button" class="close" data-dismiss="alert"  aria-label="Close"><span aria-hidden="true">&times;</span></button>')
                        elem.append('<strong>' + data['userDesc'] + '</strong>');

                        return elem;
                    };

                    // 更新选中的用户列表
                    var updateSelectedUsers = function () {
                        that.elem.hide();
                        $('body').removeClass('noscroll');
                        removePositionFromBody();
                        var triggerBtnElem = $(that.triggerBtn);
                        if (that.type == 'single') {
                            triggerBtnElem.hide();  // 隐藏输入框
                        }

                        var usersElem = triggerBtnElem.siblings('ul.selected-user-list');
                        usersElem.html('');
                        for (var i = 0; i < that.userList.length; i++) {
                            var item = createSelectedUserItem(that.userList[i]);
                            usersElem.append(item);
                        }
                    };

                    // 确定按钮
                    that.elem.find('.ok').click(function () {
                        that.userList = [];
                        var selectedCount = that.elem.find('li.selected').length;
                        if (!selectedCount) {
                            layer.open({
                                content: '未选择用户',
                                icon: 2
                            });
                        } else {
                            var selectedUsers = that.elem.find('li.selected');
                            for (var i = 0; i < selectedUsers.length; i++) {
                                var id = $(selectedUsers[i]).attr('data-id');
                                var userDesc = $(selectedUsers[i]).find('.user-desc').text();
                                if (id) {
                                    that.userList.push({'id': id, 'userDesc': userDesc});
                                }
                            }
                            // 更新选中的用户列表
                            updateSelectedUsers();
                            gotoAnchor('opinion');  // 跳转到审批意见锚点
                        }
                    });

                    // 返回按钮
                    that.elem.find('.back').click(function () {
                        that.elem.hide();
                        $('body').removeClass('noscroll');
                        removePositionFromBody();
                        gotoAnchor('opinion');  // 跳转到审批意见锚点
                    });

                    // 当用户点击移除按钮时
                    $(document).on('click', '.selected-user-list li > button', function () {
                        var remainCount = $(this).closest('ul').find('li').length;
                        if (remainCount == 1) {
                            var inputElem = $(this).closest('.form-group').find('button');
                            if (inputElem) {
                                inputElem.show();
                            }
                        }

                        var target = $(this).closest('ul').attr('data-target');
                        var id = $(this).parent().attr('data-id');
                        if (target == 'COPY_USER') {
                            var users = copyUserProvider.getSelectedUsers();
                            for (var i = 0; i < users.length; i++) {
                                if (users[i]['id'] == id) {
                                    copyUserProvider.removeUser(i);
                                    break;
                                }
                            }
                        } else {
                            var users = dealUserProvider.getSelectedUsers();
                            for (var i = 0; i < users.length; i++) {
                                if (users[i]['id'] == id) {
                                    dealUserProvider.removeUser(i);
                                    break;
                                }
                            }
                        }

                        $(this).parent().remove();
                    });
                    return this;
                },
                getSelectedUsers: function () {
                    return this.userList;
                },
                removeUser: function (pos) {
                    this.userList.splice(pos, 1)
                }
            }
        }


        /**
         * 获取表单数据
         * @returns {*}
         */
        function getFormData(action) {
            // 获取审核页面的业务数据（通过获取DOM元素获取）
            function getBizHtml() {
                var result = '',
                    filters = ['#flow-graph', '#opinion']; // 要过滤菜单的个数
                var anchors = $('#right-menu > a').filter(function(index) {
                    var part = $(this).attr('href');
                    return $.inArray(part, filters) == -1;
                });


                for (var i = 0; i < anchors.length; i++) {
                    var name = $(anchors[i]).attr('href');
                    if (name.length && name.charAt(0) == '#') {
                        name = name.substr(1);
                    }

                    var aHtml = $('a[name="' + name + '"]').closest('.panel').prop('outerHTML');
                    if (aHtml) {
                        aHtml = inputTagReplacedHtml(aHtml);
                        result += aHtml;
                    }

                    if (name == 'purchase-exec') {
                        var extraElem = $('a[name="' + name + '"]').closest('.panel').siblings('#contract_admin_confirm');
                        var extraHtml = extraElem && extraElem.prop('outerHTML') || '';

                        extraElem = null;
                        extraElem = $('a[name="' + name + '"]').closest('.panel').siblings('#confirmed_discount_ad');
                        var extraHtml2 = extraElem && extraElem.prop('outerHTML') || '';
                        extraHtml += extraHtml2;

                        result += '<div style="padding: 10px;">' + extraHtml + '</div>';
                    }
                }

                return result;

                function inputTagReplacedHtml(srcHtml) {
                    var destHtml = srcHtml;
                    if (srcHtml) {
                        destHtml = aHtml.replace(/<input([^>]*>)?/gi, function(a) {
                            var elem = $(a);
                            var type = elem.attr('type');
                            if (type == 'text') {
                                return '<span>' + elem.val() + '</span>';
                            } else if(type == 'radio') {
                                var checked = elem.attr('ok');
                                elem.attr('disabled', true);
                                if (checked) {
                                    elem.attr('checked', 'checked');
                                }
                                return elem.prop('outerHTML')
                            } else {
                                return a;
                            }
                        })
                    }

                    return destHtml;
                }
            }

            // 检查表单数据
            var checkFormData = function (action) {
                var response = {
                    status: true,
                    message: '',
                    data: data
                };

                if (parseInt(data['flowId']) == 0) {
                    if (!$.trim(data['INFO'])) {
                        response.status = false;
                        response.message = '申请说明信息不能为空';
                    }
                }

                if (data['flowTypePY'] == 'BenefitFlow') {
                    var fee_type = $('#fee_type').val() ? $('#fee_type').val() : $('#fee_type').html();
                    if (!$.trim(fee_type)) {
                        response.status = false;
                        response.message = '费用类别不能为空';
                    }

                }

                if (response.status) {
                    switch (action) {
                        case 'pass':
                        case 'next':
                            if (!data['DEAL_USERID']) {
                                response.status = false;
                                response.message = '转交人不能为空！';
                            }

                            if (response.status && !data['DEAL_INFO']) {
                                response.status = false;
                                response.message = '审批意见不能为空！';
                            }
                            break;
                            break;
                        case 'deny':
                        case 'finish':
                            if (response.status && !data['DEAL_INFO']) {
                                response.status = false;
                                response.message = '审批意见不能为空';
                            }
                            break;
                    }
                }

                return response;
            };

            var data = {};
            var info, dealUser, copyUsers = [], isPhone, isMail, dealInfo,copyUsersGroup = [];

            // 文字说明
            info = $('#INFO') && $('#INFO').val();
            data['INFO'] = info;

            // 转交至
//            var dealUserListElem = $('#DEAL_USER').parent().find('.selected-user-list li');
            var dealUserListElem = $('[data-target="DEAL_USER"]').find('li');
            if (dealUserListElem && dealUserListElem.first()) {
                dealUser = dealUserListElem.first().attr('data-id');
            }
            data['DEAL_USERID'] = dealUser;

            // 抄送至
//            var copyUserListElem = $('#COPY_USER').parent().find('.selected-user-list li');
            var copyUserListElem = $('[data-target="COPY_USER"]').find('li');

            if (copyUserListElem) {
                for (var i = 0; i < copyUserListElem.length; i++) {
                    var id = $(copyUserListElem[i]).attr('data-id');
                    if (id) {
                        copyUsers.push(id);
                    }
                }
            }

            data['COPY_USER'] = copyUsers;
            if (data['COPY_USER'].length > 0) {
                data['COPY_USERID'] = data['COPY_USER'].join(',') + ',';
				data['COPY_USERID'] += $("#GROUPNAME_TEXT_ID").val();
            }else data['COPY_USERID']  = $("#GROUPNAME_TEXT_ID").val();

            //抄送工作组
            //var copyUserGroupList = [];
           // $(".item").each(function(){
                //copyUserGroupList.push($(this).attr('data-value'));
           // })
           // data['COPY_USERGROUP'] = copyUserGroupList.join(',');

            // 附件
            var attachmentData = [];
            var attachmentListElem = $('#FILES').parent().find('.uploadify-queue-item');
            if (attachmentListElem) {
                for (var i = 0; i < attachmentListElem.length; i++) {
                    var elem = attachmentListElem[i];
                    var fileAbstract = $(elem).attr('id') + '-' + $(elem).attr('filename') + '-' + $(elem).attr('filesize');
                    attachmentData.push(fileAbstract);
                }
            }
            data['FILES'] = attachmentData.join(',');

            // 是否短信通知
            isPhone = $('input[name="ISPHONE"]:checked').val();
            data['ISPHONE'] = isPhone;

            // 是否邮件通知
            isMail = $('input[name="ISMALL"]:checked').val();
            data['ISMALL'] = isMail;

            dealInfo = $('#DEAL_INFO').val();
            data['DEAL_INFO'] = dealInfo;

            data['savedata'] = true;
            switch (action) {
                case 'next':
                    data['flowNext'] = true;
                    break;
                case 'deny':
                    data['flowNot'] = true;
                    break;
                case 'pass':
                    data['flowPass'] = true;
                    break;
                case 'finish':
                    data['flowStop'] = true;
            }

            data['flowId'] = '{$flowId}';
            data['recordId'] = '{$recordId}';
            data['type'] = '{$flowType}';
            data['flowTypePY'] = '{$flowType}';
            data['CASEID'] = '{$CASEID}';
            data['CHANGE'] = '{$CHANGE}';
            data['ACTIVID'] = '{$ACTIVID}';
            data['RECORDID'] = '{$recordId}';
            data['others'] = '{$others}';
            data['SCALETYPE'] = '{$SCALETYPE}';
            data['invoiceId'] = '{$invoiceId}';
            if (parseInt('{$CID}') > 0) {  // 变更版本号
                data['CID'] = '{$CID}';
            }

            // 工作流抄送业务数据
            var css = "<style>.panel{border:1px solid #ccc;margin:20px auto 20px;padding-bottom:0;max-width:90%;background:#fff;overflow-x:scroll;overflow-y:hidden;}.panel ul{list-style:none;margin:0;padding:0}.panel>.panel-heading{padding:10px 5px;font-weight:700;color:#444;background-color:#ddd}.panel>.panel-heading i{display:none}.panel>.panel-body{padding:4px}.panel .list-group-item{position:relative;display:block;margin-bottom:-1px;background-color:#fff;border-top:1px solid #ccc;padding:10px 15px 10px 300px}.list-group-item>label{display:block;position:absolute;left:25px;width:200px}.panel table{border-spacing:0;border-collapse:collapse;width:100%}.panel table tr th,.panel table tr td{border-top:1px solid #ddd;padding:8px;text-align:center;border-left:1px solid #ddd}.panel .content{width:100%;border:none;background-color:#fff}</style>";
            data['style'] = css;
            data['bizHtml'] = getBizHtml().replace(/\s+/gi, ' ');

            return checkFormData(action);
        }

        /**
         * 绑定审核人操作
         * @param which
         */
        function bindAction(which) {
            var that = this;
            var ACTION_URL = {
                'caigoushenqing': '{:U("Purchase/opinionFlow")}',  // 采购申请
                'bulkPurchase': '{:U("Purchase/bulk_purchase_opinionFlow")}',  // 采购申请
                'dulihuodong': '{:U("Activ/opinionFlow")}',  // 独立活动立项
                'xiangmuxiahuodong': '{:U("Activ/XiangMuOpinionFlow")}',  // 项目下活动立项
                'dulihuodongbiangeng': '{:U("Activ/opinionFlowChange")}',  // 独立活动立项变更
                'xiangmuxiahuodongbiangeng': '{:U("Activ/opinionFlowChange")}',  // 项目下活动立项变更
                'dianziedu': '{:U("Payout_change/opinionFlow")}',  // 垫资比例调整
                'jiekuanshenqing': '{:U("Loan/opinionFlow")}',  // 借款申请
                'huiyuantuipiao': '{:U("InvoiceRecycle/opinionFlow")}',
                'tksq': '{:U("MemberRefund/opinionFlow")}',
                'projectset': '__APP__/Touch/ProjectSet/opinionFlow',  //
                'projectchange': '__APP__/Touch/ProjectChange/opinionFlow',
                'finalaccounts': '__APP__/Touch/Finalaccounts/opinionFlow',
                'biaozhuntiaozheng': '{:U("Feescale_change/opinionFlow")}',

                'PurchaseNocash': '__APP__/Touch/PurchaseNocash/opinionFlow',
                'BenefitFlow': '__APP__/Touch/BenefitFlow/opinionFlow',
                'Termination': '__APP__/Touch/ProjectTermination/opinionFlow',

                'huiyuanhuanpiao': '{:U("ChangeInvoice/opinionFlow")}',
                'jianmianshenqing': '{:U("MemberDiscount/opinionFlow")}',
                'hetongkaipiao': '{:U("Advert/opinionFlow")}',
                'chengbenhuabo': '{:U("Cost/opinionFlow")}',
                'yewujintie': '{:U("Benefits/opinionFlow")}',
                'PurchasingBee': '{:U("PurchasingBee/opinionFlow")}',
                'zhihuanshenqing': '{:U("Displace/opinionFlow")}',
                'shoumai': '{:U("InboundUse/opinionFlow","flowDisplaceType=1")}',
                'neibulingyong': '{:U("InboundUse/opinionFlow","flowDisplaceType=2")}',
                'baosun': '{:U("InboundUse/opinionFlow","flowDisplaceType=3")}',
                'shoumaibiangeng': '{:U("DisplaceSaleChange/opinionFlow")}',
                'AdvanceChaoe' : '__APP__/Touch/AdvanceChaoe/opinionFlow',
            };

            var formData = {};  // 表单数据

            // 异步调用之前的操作
            var before = function (type) {

            };

            // 异步调用成功后的回调函数
            var successCallback = function (type) {

                return function () {
                };
            };

            // 异步调用失败后的回调函数
            var failCallback = function (type) {

                return function () {
                };
            };

            var doAction = function (action, data, onSuccess, onFail) {
                if (!action) {
                    return false;
                }
                var isMobile = '{$isMobile}', url = ACTION_URL[which];  // 获取URL
                $.ajax({
                    url: url,
                    type: 'POST',
                    async: false,
                    data: data,
                    success: (function (res) {
                        res = res && JSON.parse(res);

                        if (res.status == true || parseInt(res.status) == 1) {
                            onSuccess.call(that, res);
                            var msg = res.message || '操作成功';
                            layer.open({
                                content: msg,
                                btn: ['确定'],
                                yes: function() {
                                    if (isMobile) {
                                        if (res.url) {
                                            location.href = res.url;
                                        } else {
                                            location.reload();
                                        }
                                    } else {
                                        location.href = '{:U("Admin/Flow/workStep")}';  // PC版将跳转至指定页面
                                    }
                                }
                            });
                        } else {
                            onFail.call(that, res);
                            var msg = res.message || '操作失败';
                            $('#btn-next, #btn-deny, #btn-pass, #btn-finish').prop('disabled', false);
                            layer.open({
                                content: msg
                            });
                        }
                    }),
                    error: function () {
                        // todo
                    }
                });
            };

            $('#btn-next, #btn-deny, #btn-pass, #btn-finish').click(function () {
                $('#btn-next, #btn-deny, #btn-pass, #btn-finish').prop('disabled', true);
                var action = $(this).attr('data-action');
                var result = getFormData(action);
                //console.log(result);
                if (result.status == false) {

                    var msg = result.message || '请检查表单数据';
                    layer.open({ content: msg });
                    $('#btn-next, #btn-deny, #btn-pass, #btn-finish').prop('disabled', false);
                    return;
                } else {
                    formData = result.data;
                }
                if (action == 'finish' || action == 'deny') {
                    // 如果是备案或否决操作，则弹出确认框确认
                    var title = "确认备案？";
                    var text = "【备案】是工作流审批的最后一步，备案成功则完成审批。<br/><br/>确定要备案该工作流？";
                    if (action == 'deny') {
                        title = "确认否决？";
                        text = "执行“否决”操作成功后，该条工作流将被废弃。<br/>确定要否决该工作流？";
                    }

                    layer.open({
                        content: text,
                        btn: ['确定', '取消'],
                        yes: function() {
                            // 确定
                            before(which);
                            $('#btn-next, #btn-deny, #btn-pass, #btn-finish').prop('disabled', true);
                            doAction(action, formData, successCallback(which), failCallback(which));
                        },
                        no: function() {
                            // layer.mobile版的取消

                        },
                        btn2: function() {
                            // layer PC版的取消

                        }
                    });
                } else {
                    before(which);
                    $('#btn-next, #btn-deny, #btn-pass, #btn-finish').prop('disabled', true);
                    doAction(action, formData, successCallback(which), failCallback(which));
                }
            });
        }

        // 转交至用户选择
        var dealUserProvider = new UserProvider({
            model: 'user',
            type: 'single',
            list: 'deal-user-list',
            triggerBtn: 'DEAL_USER'
        });
        dealUserProvider.init().fire().bindButtons();

        // 抄送至用户选择
        var copyUserProvider = new UserProvider({
            model: 'users',
            type: 'multi',
            list: 'copy-user-list',
            triggerBtn: 'COPY_USER'
        });
        copyUserProvider.init().fire().bindButtons();
        
        var copyGroupProvider = new UserProvider({
            model : 'group',
            type: 'multi',
            list: 'copy-usergroup-list',
            triggerBtn: 'COPY_USERGROUP'

        })
        copyGroupProvider.init().fire().bindButtons();
         //绑定事件
        bindAction('{$flowType}');

        // 全局返回按钮
        $('.btn-back-global').click(function (event) {
            event.preventDefault();
            // 返回的类型type parent=上一级 history=上一步
            var type = $(this).attr('data-type');
            var historyLength = $(this).attr('data-history');

            history.back();
            return;
            if (type == 'history') {
                history.back();
            } else {
                location.href = '__APP__/Flow/workStep';
            }
        });

        // 打印工作流按钮
        $('.btn-print-flow').click(function (event) {

            event.preventDefault();
            $('#catalog-button, .panel-opinion, .back-btn-box, .cbp-spmenu').remove();
            $('.jumbotron').css({'position': 'absolute'});
            $('a').removeAttr('href');  // 去掉链接

            $('html, body').animate({
                scrollTop: 0
            }, 0);
            if (navigator.userAgent.toLowerCase().indexOf("firefox") != -1) {
                window.print();
            } else {
                document.execCommand('print');  // 打印当前页
            }

            location.reload();
        });
    });

</script>
<!--upload.js-->
<script>
    $(function () {
        // 更新文件列表
        function uploadify_uploadfilelist(filename, filesize, filecode, field) {
            var itemTemplate = '<div id="' + filecode + '" filename="' + filename + '" filesize="' + filesize + '"   name="filename_' + field + '" class="uploadify-queue-item">\
					<div class="cancel">\
						<a class="btn-remove-file" href="javascript:void(0);" data-filecode="' + filecode + '">&times;</a>\
					</div>\
					<span class="fileName"><a target="_blank" href="index.php?s=/Upload/showfile&filecode=' + filecode + '">' + filename + ' (' + filesize + ')</a></span><span class="data"></span>\
					<div class="uploadify-progress">\
						<div  > </div>\
					</div>\
				</div>';
            $("#" + field + "").parent().append(itemTemplate);
        }

        $(document).on('click', '.btn-remove-file', function () {
            var fileCode = $(this).attr('data-filecode');
            $("#" + fileCode).remove();
        });

        $('#FILES').uploadify({
            'uploader': 'index.php?s=/Upload/save2oracle/',
            'onUploadSuccess': function (file, data) {
                uploadify_uploadfilelist(file.name, file.size, data, 'FILES');
            },
            'formData': {
                'timestamp': '{:time()}',
                'token': "{:md5('nr234n9i92n2' . time())}"
            },
            'swf': 'Public/uploadify/uploadify.swf',
            'buttonText': '上传文件',
            'height': 'auto',
            'width': '120',
            'height': '35',
            'buttonCursor': 'hand'
        });
    });
</script>

<!--purchase.js-->
<script>
    $(function () {
        var ACTION = {
            EDIT: 1,
            CHECK: 2
        };

        function getSelectedPurchaseItem(fid) {
            var result = [];
            if (parseInt(fid) > 0) {
                var purchaseList = '{$purchaseListJSON}';
                if (purchaseList) {
                    purchaseList = JSON.parse(purchaseList);
                }
                for (var i = 0; i < purchaseList.length; i++) {
                    if (fid == purchaseList[i]['ID']) {
                        result = purchaseList[i];
                        break;
                    }
                }
            }

            return result;
        }

        $(document).on('click touchend', '.row-op', function (event) {
            event.preventDefault();
            var fid = $(this).attr('fid');
            var layerW = $(window).width() * 0.9,
                    layerH = $(window).height() * .7;


            var detail = getSelectedPurchaseItem(fid),
                    action = $(this).attr('data-action'),
                    url = '__APP__/Purchase/purchase_list/TAB_NUMBER/5/&parentchooseid=' + detail['PR_ID'] + '&showForm=' + action + '&ID=' + detail['ID'];
            if (action == 3) {  // 删除采购明细操作
                layer.open({
                    content: '确定删除该条采购明细？',
                    btn: ['确定', '取消'],
                    yes: function() {
                        url = '__APP__/Purchase/purchase_list/&parentchooseid=' + detail['PR_ID'] + '&faction=delData&ID=' + detail['ID'];
                        $.ajax({
                            url: url,
                            success: function (data) {
                                data = data && JSON.parse(data);
                                var msg = '采购明细删除成功！', type = 'success';
                                if (data.status != 'success') {
                                    msg = '采购明细删除失败！';
                                    type = 'error';
                                }
                                alert(msg);
                                location.reload();
                            },
                            error: function () {

                            }
                        });
                    },
                    no: function() {

                    },
                    btn2: function() {

                    }
                });
            } else {
                layer.open({
                    type: 2,
                    area: [layerW + 'px', layerH + 'px'],
                    fix: true, //不固定
                    shadeClose: true,
                    content: url,
                    shade: 0.8,
                    end: function () {
                        if (action == ACTION.EDIT) {
                            location.reload();
                        }
                    }
                });
            }
        });

        //置换业务工作流更新处理
        $(document).on('click touchend', '.displace-row-op', function (event) {
            //初始化
            event.preventDefault();
            var fid = $(this).attr('fid');
            var layerW = $(window).width() * 0.9,
                    layerH = $(window).height() * .7;

            var action = $(this).attr('data-action'),
                    updateurl = $(this).attr('data-update-url'),
                    delurl = $(this).attr('data-del-url');

            if (action == 3) {  // 删除采购明细操作
                layer.open({
                    content: '确定删除该条记录吗？',
                    btn: ['确定', '取消'],
                    yes: function() {
                        $.ajax({
                            url: delurl,
                            success: function (data) {
                                data = data && JSON.parse(data);
                                var msg = '亲,删除成功！', type = 'success';
                                if (data.status != 'success') {
                                    msg = '亲,删除失败,请重试！';
                                    type = 'error';
                                }
                                alert(msg);
                                location.reload();
                            },
                            error: function () {

                            }
                        });
                    },
                    no: function() {

                    },
                    btn2: function() {

                    }
                });
            } else {
                layer.open({
                    type: 2,
                    area: [layerW + 'px', layerH + 'px'],
                    fix: true, //不固定
                    shadeClose: true,
                    content: updateurl,
                    shade: 0.8,
                    end: function () {
                        if (action == ACTION.EDIT) {
                            location.reload();
                        }
                    }
                });
            }
        });
    });

</script>

<!--history.js-->
<script>
    $(function () {
        var histroyLength = history.length;
        $('.btn-back-global').attr('data-history', histroyLength);

        //工作组下拉
        $.ajax({
            type: "GET",
            url: "index.php?s=/Api/ajax_get_groupname",
            dataType:"JSON",
            success:function(data)
            {
                var groupName = [];
                $.each(data, function(key, value)
                {
                    groupName .push('<option value="'+ value['ID'] +'">'+ value['GROUPNAME']+'</option>');
                })
                $("select[name='COPY_USERGROUP_SELECT']").append(groupName.join(''));

                //展示值
                var $select = $('#COPY_USERGROUP_SELECT').selectize({
                    plugins: ['remove_button'],
                    persist: false,
                    create: true,
                    maxItems: null,
                    valueField: 'id',
                    labelField: 'title',
                    searchField: 'title',
                    create: false,
					onItemRemove:function(a){removeItem(a);},
					onItemAdd:function(a){ addItem(a)}
                });
            },

        })

    });
</script>

<!--autocomplete.js-->
<if condition="$isMobile eq 0">
    <script>
		Array.prototype.del=function(n) {　//n表示第几项，从0开始算起。
			//prototype为对象原型，注意这里为对象增加自定义方法的方法。
		　if(n<0)　//如果n<0，则不进行任何操作。
			return this;
		　else
			return this.slice(0,n).concat(this.slice(n+1,this.length));
		}

        function createSelectedUserItem(data, callback) {
            callback = callback || function () {
            };
            var elem = $('<li class="alert-info" data-id="' + data['id'] + '"></li>');
            var button = $('<button type="button" class="close" data-dismiss="alert"  aria-label="Close"><span aria-hidden="true">&times;</span></button>');
            elem.append(button);
            elem.append('<strong>' + data['userDesc'] + '</strong>');

        callback.call(this, button);

            return elem;
        }

        $("#DEAL_USER_INPUT").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "index.php?s=/Api/getFlowPeople",
                    dataType: "json",
                    data: {
                        "search": request.term,
                        "roleId": $("#roleId").val()
                    },
                    success: function (obJect) {
                        response($.map(obJect, function (item) {
                            return {
                                label: item.name,
                                value: item.name,
                                USERID: item.id,
                                PHONE: item.phone,
                                CITY: item.city
                            }
                        }));
                    }
                });
            },
            minLength: 1,
            select: function (event, ui) {
                $('#DEAL_USER_INPUT').hide();
                var usersElem = $(this).siblings('ul.selected-user-list');
                usersElem.html('');
                var item = createSelectedUserItem({
                    id: ui.item.USERID,
                    userDesc: ui.item.label
                }, function (elem) {
                    $(elem).unbind('click').bind('click', function () {
                        $(elem).closest('li').remove();
                        $('#DEAL_USER_INPUT').show().focus();
                    })
                });
                usersElem.append(item);

                // 清空输入框的内容
                $(this).val('');
                return false;
            }
        });

        $("#COPY_USER_INPUT").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "index.php?s=/Api/getFlowPeople",
                    dataType: "json",
                    data: {
                        "search": request.term,
                        "roleId": $("#roleId").val()
                    },
                    success: function (obJect) {
                        response($.map(obJect, function (item) {
                            return {
                                label: item.name,
                                value: item.name,
                                USERID: item.id,
                                PHONE: item.phone,
                                CITY: item.city
                            }
                        }));
                    }
                });
            },
            minLength: 1,
            select: function (event, ui) {
                var usersElem = $(this).siblings('ul.selected-user-list');
                var item = createSelectedUserItem({
                    id: ui.item.USERID,
                    userDesc: ui.item.label
                }, function (elem) {
                    $(elem).unbind('click').bind('click', function () {
                        $(elem).closest('li').remove();
                    })
                });
                //console.log(item);
                usersElem.append(item);

                // 清空输入框的内容
                $(this).val('');
                return false;
            }
        });
		
		 
     // $("select[name='COPY_USERGROUP_SELECT']").change(function(){
		function addItem(a){  //alert(a);
            //var groupUserId = $("select[name='COPY_USERGROUP_SELECT']").val();
            $.ajax({
                url: "index.php?s=/Api/getFlowGroupName",
                dataType: "json",
                data: {
                    "groupUserId": a,
                },
                success: function (data) {
					//if($("#GROUPNAME_TEXT").val() !=''){
						//console.log(data);
						//data= eval('(' + data + ')')
						var users = new Array();
						var text = new Array();
						if($("#GROUPNAME_TEXT_ID").val().length>0)users= $("#GROUPNAME_TEXT_ID").val().split(','); 
						if($("#GROUPNAME_TEXT").val().length>0)text  = $("#GROUPNAME_TEXT").val().split(','); 
					for(var i in data ){ 
						//$("#GROUPNAME_TEXT").append(','+data[i]['SinUserName']);
						text.push(data[i]['SinUserName']);
						users.push(data[i]['USERNAME']);
					}
					var ccc = text.join(',');
					ccc=ccc.substring(0, ccc.lastIndexOf(','));  
					$("#GROUPNAME_TEXT").val(ccc);
					var cc = users.join(','); 
					cc=cc.substring(0, cc.lastIndexOf(','));  
					$("#GROUPNAME_TEXT_ID").val(cc);
						 
					//}else $("#GROUPNAME_TEXT").val( data);
                    $("#GROUPNAME_TEXT").prop("disabled",true);
                }
            })
		}
        //});
		function removeByValue(arr, val) {
		  for(var i=0; i<arr.length; i++) {
			if(arr[i] == val) {
			  arr.splice(i, 1);
			  break;
			}
		  }
		}

		function removeItem(value){
		
			$.ajax({
					url: "index.php?s=/Api/getFlowGroupName&actt=1",
					dataType: "json",
					data: {
						"groupUserId": value,
					},
					success: function (data) {
						//if($("#GROUPNAME_TEXT").val() !=''){
							//console.log(data);
							//data= eval('(' + data + ')')
							var  GROUPNAME_TEXT = new Array();
							
							if($("#GROUPNAME_TEXT").val().length>0) GROUPNAME_TEXT = $("#GROUPNAME_TEXT").val().split(',');
							 
							//alert(GROUPNAME_TEXT.split(','));
							var  GROUPNAME_TEXT_ID = new Array();
							if($("#GROUPNAME_TEXT_ID").val().length>0) GROUPNAME_TEXT_ID = $("#GROUPNAME_TEXT_ID").val().split(',');
							 
						for(var i in data ){ 

							/*for(var ii in GROUPNAME_TEXT){ 
								if(GROUPNAME_TEXT[ii] != data[i]['SinUserName']){
									 
									GROUPNAME_TEXT_NEW.push(GROUPNAME_TEXT[ii]);
								}
							} 
							for(var ii in GROUPNAME_TEXT_ID){
								if(GROUPNAME_TEXT_ID[ii] != data[i]['USERNAME']){
									GROUPNAME_TEXT_ID_NEW.push(GROUPNAME_TEXT_ID[ii]);
								}
							}*/
							//GROUPNAME_TEXT.del(data[i]['SinUserName']);
							//GROUPNAME_TEXT_ID.del(data[i]['USERNAME']);
							removeByValue(GROUPNAME_TEXT,data[i]['SinUserName']);
							removeByValue(GROUPNAME_TEXT_ID,data[i]['USERNAME']); //alert(GROUPNAME_TEXT_ID);
							 
						}
						var cc = GROUPNAME_TEXT.join(',');
						//cc=cc.substring(0, cc.lastIndexOf(','));  
						$("#GROUPNAME_TEXT").val(cc);
						var ccc = GROUPNAME_TEXT_ID.join(',');  
						//ccc=ccc.substring(0, ccc.lastIndexOf(','));  
						$("#GROUPNAME_TEXT_ID").val(ccc);
						//alert(cc);	 
						//}else $("#GROUPNAME_TEXT").val( data);
						$("#GROUPNAME_TEXT").prop("disabled",true);
					}
				});
		}

    </script>
</if>