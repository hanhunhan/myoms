<script src="Public/validform/js/jquery-1.9.1.min.js"></script>
<script src="Public/third/bootstrap/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
<script src="Public/js/iscroll.js"></script>
<script>
$(function() {
//    url请求配置
    var URL_CONFIG = {
        'FLOW_RECYCLE': '{:U("Flow/recycle")}',
        'FLOW_LIST': '{:U("Flow/flowList")}',
        'FLOW_TYPE': '__APP__/Api/getFlowType',
        'IS_RECYCLE': '__APP__/Api/judge_Recover_Flow',
    };

    function swalWarningInfo(text) {
        swal({
            'title': '提示',
            'text': text,
            'type': 'warning',
            'animation': false
        });
    }

    /**
     * 用户筛选列表及相应交互
     */
    function FlowListProvider(options) {
        return {
            init: function () {
                var _this = this;

                _this.fid = 0;
                _this.status = 1;
                _this.page = 1;

                return this;
            },
            select: function(){
                var _this = this;
                $(document).on('click',".list-group-item",function(){
                    $(".list-group-item").removeClass("bg-gray");
                    $(this).addClass("bg-gray");
                    _this.fid = $(this).attr("flowId");
                });
                return this;
            },
            fire: function () {
                var _this = this;

                $(document).on('click', "#handle", function () {
                    if(_this.fid == 0){
                        swalWarningInfo("亲，请选择其中一条记录进行办理!");
                        return false;
                    }

                    dealFlowListProvider.handleFlow();
                });

                $(document).on('click', "#view", function () {
                    if(_this.fid == 0){
                        swalWarningInfo("亲，请选择其中一条记录进行查看!");
                        return false;
                    }

                    dealFlowListProvider.handleFlow('view');
                });

                $(document).on('click', "#recycle", function () {
                    if(_this.fid == 0){
                        swalWarningInfo("亲，请选择其中一条记录进行办理!");
                        return false;
                    }

                    //判断回收状态
                    if(dealFlowListProvider.flowRecycle() == false){
                        swalWarningInfo("对不起，亲，该工作流已经不能回收!");
                        return false;
                    }

                    swal({
                        title: '收回工作流',
                        text: "亲，确定要回收此条工作流吗？",
                        type: "warning",
                        animation: false,
                        showCancelButton: true,
                        cancelButtonText: '取消',
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "确定",
                        closeOnConfirm: true
                    }, function (isConfirm) {
                        if (isConfirm) {
                            dealFlowListProvider.ajaxRecycle(_this.fid);
                        }
                    });

//                    if(!confirm("亲，确定要回收此条工作流吗？"))
//                        return false;
//
//                    dealFlowListProvider.ajaxRecycle(_this.fid);

                });

                $(document).on('click',".flow-status button",function(){
                    $(this).addClass("bg-red-strong").siblings().removeClass("bg-red-strong");
                    _this.status = $(this).attr("flowstatus");
                    dealFlowListProvider.ajaxFlowData(_this.status,_this.page);
                });

                return this;
            },
            flowRecycle:function(){
                var _this = this;
                _this.flag = false;
                $.ajax({
                    url:URL_CONFIG.IS_RECYCLE,
                    dataType:"json",
                    async:false,
                    data: {'flowId': _this.fid},
                    success:function(res){
                        if(res.msg=='yes'){
                            _this.flag = true;
                        }
                    },
                    error:function(res){

                    },
                });
                return _this.flag;
            },
            handleFlow:function(operate){

                var _this = this;
                var appUrl = "__APP__";

                $.ajax({
                    url: URL_CONFIG.FLOW_TYPE,
                    dataType: "json",
                    data: {'flowId': _this.fid},
                    success: function (obJect) {
                        if (obJect['nopower'] == 1) {
                            if (obJect['status'] == 'not_login') {
                                swal({
                                    title: '登录超时',
                                    text: "请重新登录",
                                    type: "warning",
                                    animation: false,
                                    showCancelButton: false,
                                    cancelButtonText: '取消',
                                    confirmButtonColor: "#DD6B55",
                                    confirmButtonText: "确定",
                                    closeOnConfirm: true
                                }, function (isConfirm) {
                                    if (isConfirm) {
                                        location.href = "{:U('Index/login')}";
                                    }
                                });

//                                swalWarningInfo('登录超时，请重新登录！');
//                                location.href = "{:U('Index/login')}";
                            } else {
                                swalWarningInfo('您没有权限操作该城市的流程！');
                            }

                        } else {
                            var type = '&flowTypePinYin=' + obJect[0]['PINYIN'];
                            switch (obJect[0]['PINYIN']) {
                                //业务津贴
                                case 'yewujintie':
                                    url = appUrl + '/Touch/Benefits/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //采购申请
                                case 'caigoushenqing':

                                    if (obJect[0]['CASEID'] > 0) {
                                        type += '&purchaseType=purchase';
                                    } else {
                                        type += '&purchaseType=bulkPurchase';
                                    }
                                    url = appUrl + '/Touch/Purchase/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;


//                                    if (obJect[0]['CASEID'] > 0) {
//                                        url = appUrl + '/Purchase/opinionFlow&flowId=' + flowId + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'];
//                                        switch (obJect[0]['ACTIVID']) {
//                                            case '1':
//                                                url += "&TAB_NUMBER=5";
//                                                break;
//                                            case '2':
//                                                url += "&TAB_NUMBER=4";
//                                                break;
//                                            case '3':
//                                                url += "&TAB_NUMBER=11";
//                                                break;
//                                            case '4':
//                                                url += "&TAB_NUMBER=12";
//                                                break;
//                                            case '8':
//                                                url += "&TAB_NUMBER=24";
//                                                break;
//                                        }
//                                    }
//                                    else {
//                                        url = appUrl + '/Purchase/bulk_purchase_opinionFlow&flowId=' + flowId + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'];
//                                    }


                                    break;
                                //非付现成本*
                                case 'feifuxianchengbenshenqing':  // 非现金成本申请
                                    url = appUrl + '/Touch/PurchaseNocash/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + '&TAB_NUMBER=5';
                                    break;
                                //成本划拨
                                case 'chengbenhuabo':
                                    url = appUrl + '/Touch/Cost/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + '&flowTypePinYin=' + obJect[0]['PINYIN'];
                                    break;
                                //立项变更*
                                case 'lixiangbiangeng':
                                    url = appUrl + '/Touch/ProjectChange/show&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + '&CHANGE=-1&type=1&flowType=lixiangbiangeng&active=1&tabNum=20';
                                    break;
                                //标准调整
                                case 'biaozhuntiaozheng':
                                    url = appUrl + '/Touch/Feescale_change/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //合同开票
                                case 'hetongkaipiao':
                                    url = appUrl + '/Touch/Advert/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //退款申请
                                case 'tksq':
                                    url = appUrl + '/Touch/MemberRefund/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //垫资调整
                                case 'dianziedu':
                                    url = appUrl + '/Touch/Payout_change/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //立项申请*
                                case 'lixiangshenqing':
 
                                    url = appUrl + '/Touch/ProjectSet/show&tabNum=20&flowId=' +  _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
 
                                    break;
                                //会员退票
                                case 'huiyuantuipiao':
                                    url = appUrl + '/Touch/InvoiceRecycle/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                case 'xiangmuxiahuodong': // 项目下活动立项
                                case 'dulihuodongbiangeng': // 独立活动变更
                                case 'xiangmuxiahuodongbiangeng': // 项目下活动变更
                                case 'dulihuodong': // 独立活动立项
                                    url = appUrl + '/Touch/Activ/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                case 'xiangmuzhongzhi'://项目终止*
 
                                    url = appUrl + '/Touch/ProjectTermination/show&flowId=' +  _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
 
                                    break;
                                case 'xiangmujuesuan'://决算*
 
                                    url = appUrl + '/Touch/Finalaccounts/show&flowId=' +  _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
 
                                    break;
                                case 'jiekuanshenqing':  // 借款申请
                                    url = appUrl + '/Touch/Loan/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //会员减免
                                case 'jianmianshenqing':
                                    url = appUrl + '/Touch/MemberDiscount/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                //会员换票
                                case 'huiyuanhuanpiao':
                                    url = appUrl + '/Touch/ChangeInvoice/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                case 'yusuanqita'://预算其他*
 
                                    url = appUrl + '/Touch/BenefitFlow/process&flowId=' +  _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
 
                                    break;
                                case 'xiaomifengchaoe'://小蜜蜂*
                                    url = appUrl + '/Touch/PurchasingBee/show&prjid=0&flowId=' + _this.fid + '&beeId=' + obJect[0]['RECORDID'] + '&TAB_NUMBER=25';
                                    break;
                                case 'zhihuanshenqing':
                                    url = appUrl + '/Touch/Displace/process&flowId=' + _this.fid + '&RECORDID=' + obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                case 'shoumai':
                                    url = appUrl + '/Touch/InboundUse/process&flowId=' + _this.fid +'&RECORDID='+obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type + '&flowDisplaceType=1';
                                    break;
                                case 'neibulingyong':
                                    url = appUrl + '/Touch/InboundUse/process&flowId=' + _this.fid +'&RECORDID='+obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type + '&flowDisplaceType=2';
                                    break;
                                case 'baosun':
                                    url = appUrl + '/Touch/InboundUse/process&flowId=' + _this.fid +'&RECORDID='+obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type + '&flowDisplaceType=3';
                                    break;
                                case 'shoumaibiangeng':
                                    url = appUrl + '/Touch/DisplaceSaleChange/process&flowId=' + _this.fid +'&RECORDID='+obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type;
                                    break;
                                case 'dianzibilichaoe':
                                    url = appUrl + '/Touch/AdvanceChaoe/show&flowId=' + _this.fid +'&RECORDID='+obJect[0]['RECORDID'] + '&CASEID=' + obJect[0]['CASEID'] + type ;
                                    break;
                            }
                            if(operate=='view'){
                                url = url + '&operate=view';
                            }
                            window.location.href = url;
                        }
                    }
                });
            },
            ajaxRecycle: function(flowID){
                $.ajax({
                    url: URL_CONFIG.FLOW_RECYCLE,
                    method: 'GET',
                    data:{flowId:flowID},
                    dataType: 'json',
                    success: function (res) {
                        if (res.status) {
                            swalWarningInfo("工作流回收成功");
                            dealFlowListProvider.initRecycleList(flowID);
                        }
                    },
                    error: function () {
                        // todo
                    }
                });
            },
            //删除回收的工作流
            initRecycleList:function(){
                $('.list-group-item.bg-gray').remove();
            },
            ajaxFlowData: function(status,page){
                $.ajax({
                    url: '{:U("Flow/flowList")}',
                    method: 'GET',
                    data:{status:status,page:page,act:"getPageList"},
                    dataType: 'json',
                    success: function (res) {
                        if (res.status) {
                            var data = res.data;
                            var flowHtml = '';
                            for(i=0;i<data.length;i++){
                                flowHtml += getFlowHtml(data[i],status);
                            }
                            $("#list-item-info").html(flowHtml);
                        }
                        //页面赋值为初始值
                        window.page = 1;

                        //初始化下拉菜单
                        $("#pullUp").html('<span class="pullUpLabel">上拉加载更多...</span>');


                        //初始化悬浮按钮
                        switch(status){
                            case "1":
                                $("#catalog-button").find(".btn-group-vertical button").remove();
                                $("#catalog-button").find(".btn-group-vertical").append('<button type="button" class="btn btn-danger flow-btn" id="handle"><i class="glyphicon glyphicon-edit"></i></button>');
                                break;
                            case "2":
                                $("#catalog-button").find(".btn-group-vertical button").remove();
                                $("#catalog-button").find(".btn-group-vertical").append('<button type="button" class="btn btn-danger flow-btn" id="recycle"><i class="glyphicon glyphicon-retweet"></i></button>');
                                $("#catalog-button").find(".btn-group-vertical").append('<button type="button" class="btn btn-danger flow-btn" id="view"><i class="glyphicon glyphicon-eye-open"></i></button>');
                                break;
                            case "3":
                                $("#catalog-button").find(".btn-group-vertical button").remove();
                                $("#catalog-button").find(".btn-group-vertical").append('<button type="button" class="btn btn-danger flow-btn" id="view"><i class="glyphicon glyphicon-eye-open"></i></button>');
                                break;
                        }

                        //工作条刷新
                        window.myScroll.refresh();
                    },
                    error: function () {
                        swalWarningInfo("对不起,网络错误~~");
                    }
                });
            },
            getFlowHtml:function(flowData,status){
//                var retStr = '<div class="list-group">';
                var retStr = '';
                retStr += '<div class="list-group-item" flowId="' + flowData.ID + '">';
                if(status=="2" || status=="3") {
                    retStr += '<h5 class="list-group-item-heading"><span class="label" style="background-color: ' + flowData.COLOR + '">' + flowData.FLOWTYPE + '-' + flowData.CITYNAME + '</span><span class="label label-success">进行中</span><small><span class="pull-right gray">' + flowData.ADDTIME + '</span></small></h5>';
                }
                else{
                    retStr += '<h5 class="list-group-item-heading"><span class="label" style="background-color: ' + flowData.COLOR + '">' + flowData.FLOWTYPE + '-' + flowData.CITYNAME + '</span><small><span class="pull-right gray">' + flowData.ADDTIME + '</span></small></h5>';
                }
                retStr += '<p class="list-group-item-text"><i class="glyphicon glyphicon-user"></i>&nbsp;<span class="list_user">' + flowData.NAME + '</span><small class="label pull-right bg-green">第' + flowData.MAXSTEP + '步</small></p>';
                retStr += '<p class="list-group-item-text"><i class="glyphicon glyphicon-check"></i>&nbsp;' + flowData.INFO + '</p>';
                retStr += '</div>';
//                retStr += '</div>';
                return retStr;
            },
        }
    };

    // 转交至用户选择
    var dealFlowListProvider = new FlowListProvider({
    });
    dealFlowListProvider.init().select().fire();
});

/********************************/
/*************滚动刷新功能*********/
/********************************/

var myScroll, pullDownEl, pullDownOffset, pullUpEl, pullUpOffset, generatedCount = 0;
var page = 1;


/**
 * 下拉刷新 （自定义实现此方法）
 * myScroll.refresh();		// 数据加载完成后，调用界面更新方法
 */
function pullDownAction () {
    status = $(".flow-status").find(".bg-red-strong").attr("flowstatus");
    location.href = "{:U('Flow/flowList')}" + "/status/" + status;
//    setTimeout(function () {	// <-- Simulate network congestion, remove setTimeout from production!
//        status = $(".flow-status").find(".bg-red-strong").attr("flowstatus");
//        $.ajax({
//            url: '{:U("Flow/flowList")}',
//            method: 'GET',
//            data:{status:status,page:1,act:"getPageList"},
//            dataType: 'json',
//            success: function (res) {
//                if (res.status) {
//                    var data = res.data;
//                    var flowHtml = '';
//                    for(i=0;i<data.length;i++){
//                        flowHtml += getFlowHtml(data[i],status);
//                    }
//                    $("#list-item-info").html(flowHtml);
//                }
//                myScroll.refresh();
//            },
//            error: function () {
//                alert("对不起,网络错误或登陆超时，请重新进入经管系统~~");
//            }
//        });
//        //myScroll.refresh();		//数据加载完成后，调用界面更新方法   Remember to refresh when contents are loaded (ie: on ajax completion)
//    }, 1000);	// <-- Simulate network congestion, remove setTimeout from production!
}

/**
 * 滚动翻页 （自定义实现此方法）
 * myScroll.refresh();		// 数据加载完成后，调用界面更新方法
 */
function pullUpAction () {
    status = $(".flow-status").find(".bg-red-strong").attr("flowstatus");
    setTimeout(function () {
        $.ajax({
            url: '{:U("Flow/flowList")}',
            method: 'GET',
            data:{status:status,page:++page,act:"getPageList"},
            dataType: 'json',
            success: function (res) {
                if (res.status) {
                    var data = res.data;
                    for(i=0;i<data.length;i++){
                        flowHtml = getFlowHtml(data[i],status);
                        $("#list-item-info").append(flowHtml);
                    }

                    if(i<9){
                        $("#pullUp").html("亲，没有更多工作流了");
                    }
                }
                myScroll.refresh();
            },
            error: function () {
                swalWarningInfo("对不起,网络错误或登陆超时，请重新进入经管系统~~");
            }
        });
        // 数据加载完成后，调用界面更新方法 Remember to refresh when contents are loaded (ie: on ajax completion)
        //myScroll.refresh();
    }, 1000);
}

function getFlowHtml(flowData,status){

    var retStr = '';
    retStr += '<div class="list-group-item" flowId="' + flowData.ID + '">';
    var flow_status = flowData.STATUS;
    if(status=="2" || status=="3") {
        retStr += '<h5 class="list-group-item-heading"><span class="label" style="background-color: ' + flowData.COLOR + '">' + flowData.FLOWTYPE + '-' + flowData.CITYNAME + '</span>&nbsp;<span class="label label-success">' + flowData.FLOW_STATUS + '</span><small><span class="pull-right gray">' + flowData.ADDTIME + '</span></small></h5>';
    }
    else{
        retStr += '<h5 class="list-group-item-heading"><span class="label" style="background-color: ' + flowData.COLOR + '">' + flowData.FLOWTYPE + '-' + flowData.CITYNAME + '</span><small><span class="pull-right gray">' + flowData.ADDTIME + '</span></small></h5>';
    }
    retStr += '<p class="list-group-item-text"><i class="glyphicon glyphicon-user"></i>&nbsp;<span class="list_user">' + flowData.NAME + '</span><small class="label pull-right bg-green">第' + flowData.MAXSTEP + '步</small></p>';
    retStr += '<p class="list-group-item-text"><i class="glyphicon glyphicon-check"></i>&nbsp;' + flowData.INFO + '</p>';
    retStr += '</div>';
    return retStr;
}

/**
 * 初始化iScroll控件
 */
function loaded() {
    pullDownEl = document.getElementById('pullDown');
    pullDownOffset = pullDownEl.offsetHeight;
    pullUpEl = document.getElementById('pullUp');
    pullUpOffset = pullUpEl.offsetHeight;

    myScroll = new iScroll('wrapper', {
        scrollbarClass: 'myScrollbar', /* 重要样式 */
        useTransition: false, /* 此属性不知用意，本人从true改为false */
        topOffset: pullDownOffset,
        onRefresh: function () {
            if (pullDownEl.className.match('loading')) {
                pullDownEl.className = '';
                pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
            } else if (pullUpEl.className.match('loading')) {
                pullUpEl.className = '';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
            }
        },
        onScrollMove: function () {
            if (this.y > 5 && !pullDownEl.className.match('flip')) {
                pullDownEl.className = 'flip';
                pullDownEl.querySelector('.pullDownLabel').innerHTML = '松手开始更新...';
                this.minScrollY = 0;
            } else if (this.y < 5 && pullDownEl.className.match('flip')) {
                pullDownEl.className = '';
                pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
                this.minScrollY = -pullDownOffset;
            } else if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip')) {
                pullUpEl.className = 'flip';
                if($('.pullUpLabel').length) {
                    pullUpEl.querySelector('.pullUpLabel').innerHTML = '松手开始更新...';
                    this.maxScrollY = this.maxScrollY;
                }
            } else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip')) {
                pullUpEl.className = '';
                pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
                this.maxScrollY = pullUpOffset;
            }
        },
        onScrollEnd: function () {
            if (pullDownEl.className.match('flip')) {
                pullDownEl.className = 'loading';
                pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
                pullDownAction();	// Execute custom function (ajax call?)
            } else if (pullUpEl.className.match('flip')) {
                pullUpEl.className = 'loading';
                if($('.pullUpLabel').length) {
                    pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
                    pullUpAction();	// Execute custom function (ajax call?)
                }
            }
        }
    });

    setTimeout(function () { document.getElementById('wrapper').style.left = '0'; }, 800);
}

//初始化绑定iScroll控件
document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
document.addEventListener('DOMContentLoaded', loaded, false);
</script>